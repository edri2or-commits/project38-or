name: Test n8n Deploy

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  N8N_URL: "https://n8n-production-2fe0.up.railway.app"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get n8n API Key
        id: secrets
        run: |
          N8N_API_KEY=$(gcloud secrets versions access latest --secret="N8N-API" --project=project38-483612)
          echo "::add-mask::$N8N_API_KEY"
          echo "n8n_api_key=$N8N_API_KEY" >> $GITHUB_OUTPUT

      - name: Create Minimal Test Workflow
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          # Create a minimal workflow JSON
          cat > test-workflow.json << 'EOF'
          {
            "name": "Test Deploy - Delete Me",
            "nodes": [
              {
                "id": "start",
                "name": "Start",
                "type": "n8n-nodes-base.manualTrigger",
                "typeVersion": 1,
                "position": [100, 100],
                "parameters": {}
              }
            ],
            "connections": {},
            "active": false,
            "settings": {
              "saveExecutionProgress": false,
              "saveManualExecutions": false,
              "timezone": "UTC"
            }
          }
          EOF

          echo "Workflow JSON:"
          cat test-workflow.json
          echo ""

          echo "Creating test workflow..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json" \
            -d @test-workflow.json)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response:"
          echo "$BODY" | jq '.' || echo "$BODY"

          # Write to summary
          echo "## Test Workflow Deploy" >> $GITHUB_STEP_SUMMARY
          echo "HTTP: $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$BODY" | jq '.' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "$BODY" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Delete the test workflow if created
          WORKFLOW_ID=$(echo "$BODY" | jq -r '.id')
          if [ -n "$WORKFLOW_ID" ] && [ "$WORKFLOW_ID" != "null" ]; then
            echo "✅ Created workflow: $WORKFLOW_ID"
            echo "Cleaning up..."
            curl -s -X DELETE "$N8N_URL/api/v1/workflows/$WORKFLOW_ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY"
            echo "✅ Deleted test workflow"
          else
            echo "❌ Failed to create workflow"
            exit 1
          fi
