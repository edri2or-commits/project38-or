name: Test n8n Deploy

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

env:
  N8N_URL: "https://n8n-production-2fe0.up.railway.app"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get n8n API Key
        id: secrets
        run: |
          N8N_API_KEY=$(gcloud secrets versions access latest --secret="N8N-API" --project=project38-483612)
          echo "::add-mask::$N8N_API_KEY"
          echo "n8n_api_key=$N8N_API_KEY" >> $GITHUB_OUTPUT

      - name: Test n8n API - List Workflows
        id: list_test
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          echo "Testing GET /api/v1/workflows..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP: $HTTP_CODE"
          echo "list_http=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "list_response<<EOFLIST" >> $GITHUB_OUTPUT
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOFLIST" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ List failed"
          else
            COUNT=$(echo "$BODY" | jq '.data | length' 2>/dev/null || echo "0")
            echo "✅ Found $COUNT workflows"
          fi

      - name: Test n8n API - Create Workflow
        id: create_test
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          cat > test-workflow.json << 'EOF'
          {
            "name": "Test Deploy - Delete Me",
            "nodes": [
              {
                "id": "start",
                "name": "Start",
                "type": "n8n-nodes-base.manualTrigger",
                "typeVersion": 1,
                "position": [100, 100],
                "parameters": {}
              }
            ],
            "connections": {},
            "active": false,
            "settings": {
              "saveExecutionProgress": false,
              "saveManualExecutions": false,
              "timezone": "UTC"
            }
          }
          EOF

          echo "Testing POST /api/v1/workflows..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$N8N_URL/api/v1/workflows" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json" \
            -d @test-workflow.json)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP: $HTTP_CODE"
          echo "create_http=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "create_response<<EOFCREATE" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOFCREATE" >> $GITHUB_OUTPUT

          WORKFLOW_ID=$(echo "$BODY" | jq -r '.id' 2>/dev/null)
          if [ -n "$WORKFLOW_ID" ] && [ "$WORKFLOW_ID" != "null" ]; then
            echo "✅ Created: $WORKFLOW_ID"
            echo "workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT
            # Clean up
            curl -s -X DELETE "$N8N_URL/api/v1/workflows/$WORKFLOW_ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY"
            echo "✅ Cleaned up"
          else
            echo "❌ Create failed"
          fi

      - name: Post Results to Issue
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY="## n8n API Test Results - $(date -u +%Y-%m-%dT%H:%M:%SZ)

### List Workflows (GET)
- HTTP Status: ${{ steps.list_test.outputs.list_http }}

### Create Workflow (POST)
- HTTP Status: ${{ steps.create_test.outputs.create_http }}
- Response:
\`\`\`json
${{ steps.create_test.outputs.create_response }}
\`\`\`

### Workflow ID (if created)
${{ steps.create_test.outputs.workflow_id || 'None' }}
"

          # Create or update issue
          ISSUE=$(gh issue list --repo ${{ github.repository }} --search "n8n API Test Results" --state open --limit 1 --json number -q '.[0].number')

          if [ -n "$ISSUE" ]; then
            gh issue comment "$ISSUE" --body "$BODY" --repo ${{ github.repository }}
            echo "Added comment to issue #$ISSUE"
          else
            gh issue create --title "n8n API Test Results" --body "$BODY" --repo ${{ github.repository }}
            echo "Created new issue"
          fi
