name: Credential Operations Bridge

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - health-check
          - exchange-oauth-code
          - refresh-google-token
          - rotate-mcp-token
          - check-github-app
          - full-audit
      oauth_code:
        description: 'OAuth authorization code (for exchange-oauth-code)'
        required: false
        type: string
      notify_issue:
        description: 'Issue number to post results to'
        required: false
        type: string

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612
  GCP_PROJECT_NUMBER: '979429709900'

jobs:
  credential-operation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install httpx google-cloud-secret-manager pyjwt cryptography

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Health Check
        if: inputs.operation == 'health-check'
        id: health
        run: |
          echo "## Credential Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Credential | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Check GCP WIF (already authenticated if we got here)
          echo "| GCP WIF | âœ… Healthy | Authenticated via OIDC |" >> $GITHUB_STEP_SUMMARY

          # Check Google OAuth secrets
          OAUTH_CLIENT_ID=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-ID 2>/dev/null || echo "")
          OAUTH_CLIENT_SECRET=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-SECRET 2>/dev/null || echo "")
          OAUTH_REFRESH_TOKEN=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-REFRESH-TOKEN 2>/dev/null || echo "")

          if [ -n "$OAUTH_CLIENT_ID" ] && [ -n "$OAUTH_CLIENT_SECRET" ] && [ -n "$OAUTH_REFRESH_TOKEN" ]; then
            # Test refresh token
            RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
              -d "client_id=$OAUTH_CLIENT_ID" \
              -d "client_secret=$OAUTH_CLIENT_SECRET" \
              -d "refresh_token=$OAUTH_REFRESH_TOKEN" \
              -d "grant_type=refresh_token")

            if echo "$RESPONSE" | grep -q "access_token"; then
              echo "| Google OAuth | âœ… Healthy | Refresh token valid |" >> $GITHUB_STEP_SUMMARY
            else
              ERROR=$(echo "$RESPONSE" | jq -r '.error_description // .error // "Unknown error"')
              echo "| Google OAuth | âŒ Failed | $ERROR |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            MISSING=""
            [ -z "$OAUTH_CLIENT_ID" ] && MISSING="$MISSING CLIENT-ID"
            [ -z "$OAUTH_CLIENT_SECRET" ] && MISSING="$MISSING CLIENT-SECRET"
            [ -z "$OAUTH_REFRESH_TOKEN" ] && MISSING="$MISSING REFRESH-TOKEN"
            echo "| Google OAuth | âŒ Missing | Secrets:$MISSING |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Railway API
          RAILWAY_TOKEN=$(gcloud secrets versions access latest --secret=RAILWAY-API 2>/dev/null || echo "")
          if [ -n "$RAILWAY_TOKEN" ]; then
            RAILWAY_RESPONSE=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"query": "{ me { id } }"}')

            if echo "$RAILWAY_RESPONSE" | grep -q '"id"'; then
              echo "| Railway API | âœ… Healthy | Token valid |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Railway API | âŒ Failed | Token invalid |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Railway API | âŒ Missing | Secret not found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check MCP Gateway
          MCP_TOKEN=$(gcloud secrets versions access latest --secret=MCP-GATEWAY-TOKEN 2>/dev/null || echo "")
          if [ -n "$MCP_TOKEN" ]; then
            echo "| MCP Gateway | âœ… Present | Token exists |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MCP Gateway | âŒ Missing | Secret not found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check GitHub App
          GITHUB_APP_KEY=$(gcloud secrets versions access latest --secret=github-app-private-key 2>/dev/null || echo "")
          if [ -n "$GITHUB_APP_KEY" ]; then
            echo "| GitHub App | âœ… Present | Private key exists |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GitHub App | âŒ Missing | Private key not found |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check completed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY

      - name: Exchange OAuth Code
        if: inputs.operation == 'exchange-oauth-code'
        run: |
          if [ -z "${{ inputs.oauth_code }}" ]; then
            echo "âŒ OAuth code is required for this operation"
            exit 1
          fi

          echo "ðŸ”„ Exchanging OAuth authorization code..."

          # Get credentials from Secret Manager
          CLIENT_ID=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-ID)
          CLIENT_SECRET=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-SECRET)

          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
            echo "âŒ OAuth Client ID or Secret not found in Secret Manager"
            echo "Please run 'create-oauth-client' action first"
            exit 1
          fi

          # Exchange code for tokens
          RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "code=${{ inputs.oauth_code }}" \
            -d "grant_type=authorization_code" \
            -d "redirect_uri=urn:ietf:wg:oauth:2.0:oob")

          # Check for errors
          if echo "$RESPONSE" | grep -q "error"; then
            echo "âŒ Token exchange failed!"
            echo "$RESPONSE" | jq -r '.error_description // .error'
            exit 1
          fi

          # Extract refresh token
          REFRESH_TOKEN=$(echo "$RESPONSE" | jq -r '.refresh_token')

          if [ -z "$REFRESH_TOKEN" ] || [ "$REFRESH_TOKEN" = "null" ]; then
            echo "âŒ No refresh token in response!"
            echo "Response: $RESPONSE"
            exit 1
          fi

          # Store refresh token in Secret Manager
          echo "ðŸ“¦ Storing refresh token in Secret Manager..."
          if ! gcloud secrets describe GOOGLE-OAUTH-REFRESH-TOKEN --project=$GCP_PROJECT_ID 2>/dev/null; then
            gcloud secrets create GOOGLE-OAUTH-REFRESH-TOKEN --project=$GCP_PROJECT_ID --replication-policy=automatic
          fi
          echo -n "$REFRESH_TOKEN" | gcloud secrets versions add GOOGLE-OAUTH-REFRESH-TOKEN --data-file=- --project=$GCP_PROJECT_ID

          echo ""
          echo "âœ… SUCCESS! OAuth setup complete!"
          echo ""
          echo "## OAuth Exchange Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Refresh token obtained and stored**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Secrets updated:" >> $GITHUB_STEP_SUMMARY
          echo "- GOOGLE-OAUTH-REFRESH-TOKEN" >> $GITHUB_STEP_SUMMARY

      - name: Refresh Google Token
        if: inputs.operation == 'refresh-google-token'
        run: |
          echo "ðŸ”„ Testing Google OAuth token refresh..."

          # Get credentials
          CLIENT_ID=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-ID)
          CLIENT_SECRET=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-SECRET)
          REFRESH_TOKEN=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-REFRESH-TOKEN)

          if [ -z "$REFRESH_TOKEN" ]; then
            echo "âŒ No refresh token found. Run exchange-oauth-code first."
            exit 1
          fi

          # Attempt token refresh
          RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "refresh_token=$REFRESH_TOKEN" \
            -d "grant_type=refresh_token")

          if echo "$RESPONSE" | grep -q "access_token"; then
            EXPIRES_IN=$(echo "$RESPONSE" | jq -r '.expires_in')
            echo "âœ… Token refresh successful!"
            echo "Access token expires in: $EXPIRES_IN seconds"

            echo "## Token Refresh Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Refresh successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Expires in: $EXPIRES_IN seconds" >> $GITHUB_STEP_SUMMARY
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error_description // .error')
            echo "âŒ Token refresh failed: $ERROR"
            exit 1
          fi

      - name: Rotate MCP Token
        if: inputs.operation == 'rotate-mcp-token'
        run: |
          echo "ðŸ”„ Rotating MCP Gateway token..."

          # Generate new token
          NEW_TOKEN=$(openssl rand -base64 32 | tr -d '/+=' | head -c 32)

          # Store in Secret Manager
          if ! gcloud secrets describe MCP-GATEWAY-TOKEN --project=$GCP_PROJECT_ID 2>/dev/null; then
            gcloud secrets create MCP-GATEWAY-TOKEN --project=$GCP_PROJECT_ID --replication-policy=automatic
          fi
          echo -n "$NEW_TOKEN" | gcloud secrets versions add MCP-GATEWAY-TOKEN --data-file=- --project=$GCP_PROJECT_ID

          echo "âœ… MCP Gateway token rotated successfully!"
          echo ""
          echo "âš ï¸ IMPORTANT: Update your local Claude configuration with the new token."
          echo "Run 'deliver' action with an issue number to receive the new token securely."

          echo "## MCP Token Rotation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **New token generated and stored**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Remember to update local Claude configuration" >> $GITHUB_STEP_SUMMARY

      - name: Check GitHub App
        if: inputs.operation == 'check-github-app'
        run: |
          echo "ðŸ” Checking GitHub App configuration..."

          PRIVATE_KEY=$(gcloud secrets versions access latest --secret=github-app-private-key 2>/dev/null || echo "")

          if [ -z "$PRIVATE_KEY" ]; then
            echo "âŒ GitHub App private key not found in Secret Manager"
            echo "## GitHub App Status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Private key missing**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Key exists - check format
          if echo "$PRIVATE_KEY" | grep -q "BEGIN RSA PRIVATE KEY"; then
            echo "âœ… GitHub App private key found (RSA format)"
            KEY_TYPE="RSA"
          elif echo "$PRIVATE_KEY" | grep -q "BEGIN PRIVATE KEY"; then
            echo "âœ… GitHub App private key found (PKCS8 format)"
            KEY_TYPE="PKCS8"
          else
            echo "âš ï¸ Private key found but format unrecognized"
            KEY_TYPE="Unknown"
          fi

          echo "## GitHub App Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Private key present**" >> $GITHUB_STEP_SUMMARY
          echo "- Format: $KEY_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- App ID: 2497877 (hardcoded)" >> $GITHUB_STEP_SUMMARY
          echo "- Installation ID: 100231961 (hardcoded)" >> $GITHUB_STEP_SUMMARY

      - name: Full Audit
        if: inputs.operation == 'full-audit'
        run: |
          echo "ðŸ” Running full credential audit..."
          echo ""

          echo "## Full Credential Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Audit timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List all secrets and their versions
          echo "### Secret Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Versions | Last Updated |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------------|" >> $GITHUB_STEP_SUMMARY

          for secret in ANTHROPIC-API GEMINI-API N8N-API OPENAI-API RAILWAY-API TELEGRAM-BOT-TOKEN github-app-private-key GOOGLE-OAUTH-CLIENT-ID GOOGLE-OAUTH-CLIENT-SECRET GOOGLE-OAUTH-REFRESH-TOKEN MCP-GATEWAY-TOKEN WORKSPACE-MCP-BRIDGE-TOKEN; do
            if gcloud secrets describe "$secret" --project=$GCP_PROJECT_ID 2>/dev/null >/dev/null; then
              VERSIONS=$(gcloud secrets versions list "$secret" --project=$GCP_PROJECT_ID --format="value(name)" 2>/dev/null | wc -l)
              LATEST=$(gcloud secrets versions describe latest --secret="$secret" --project=$GCP_PROJECT_ID --format="value(createTime)" 2>/dev/null || echo "Unknown")
              echo "| $secret | $VERSIONS | $LATEST |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $secret | âŒ | Not found |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for missing critical secrets
          MISSING=""
          for secret in RAILWAY-API github-app-private-key; do
            if ! gcloud secrets describe "$secret" --project=$GCP_PROJECT_ID 2>/dev/null >/dev/null; then
              MISSING="$MISSING $secret"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "âš ï¸ **Missing critical secrets**:$MISSING" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All critical secrets present" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify Issue
        if: inputs.notify_issue != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Post results to issue
          gh issue comment ${{ inputs.notify_issue }} --body "## Credential Operation Complete

**Operation**: ${{ inputs.operation }}
**Status**: âœ… Completed
**Timestamp**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

See workflow run for full details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
