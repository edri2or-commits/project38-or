name: Check Billing Status

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  issues: write

env:
  PROJECT_ID: project38-483612

jobs:
  check-billing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: claude-code-agent@project38-483612.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Comprehensive Diagnostic Check
        run: |
          REPORT_FILE="diagnostics/billing_diagnostic_$(date +%Y%m%d_%H%M%S).md"
          mkdir -p diagnostics

          echo "# GCP Deployment Diagnostic Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # 1. Billing Status
          echo "## Billing Status" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          set +e
          BILLING_OUTPUT=$(gcloud beta billing projects describe $PROJECT_ID --format=json 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            BILLING_ENABLED=$(echo "$BILLING_OUTPUT" | jq -r '.billingEnabled')
            BILLING_ACCOUNT=$(echo "$BILLING_OUTPUT" | jq -r '.billingAccountName // "N/A"')

            echo "- **Status:** $BILLING_ENABLED" >> $REPORT_FILE
            echo "- **Account:** $BILLING_ACCOUNT" >> $REPORT_FILE

            if [ "$BILLING_ENABLED" = "true" ]; then
              echo "- **Result:** âœ… ENABLED" >> $REPORT_FILE
            else
              echo "- **Result:** âŒ **DISABLED - ROOT CAUSE IDENTIFIED**" >> $REPORT_FILE
              echo "" >> $REPORT_FILE
              echo "**Fix:** https://console.cloud.google.com/billing/linkedaccount?project=$PROJECT_ID" >> $REPORT_FILE
            fi
          else
            echo "- **Result:** âš ï¸ Could not check (Exit code: $EXIT_CODE)" >> $REPORT_FILE
          fi
          echo "" >> $REPORT_FILE

          # 2. Cloud Function Status
          echo "## Cloud Function Status" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          set +e
          FUNC_LIST=$(gcloud functions list --regions=us-central1 --format="value(name)" 2>&1)
          FUNC_EXIT=$?
          set -e

          if [ $FUNC_EXIT -eq 0 ]; then
            if echo "$FUNC_LIST" | grep -q "mcp-router"; then
              echo "- **Function mcp-router:** âœ… EXISTS" >> $REPORT_FILE
            else
              echo "- **Function mcp-router:** âŒ NOT FOUND" >> $REPORT_FILE
            fi
            echo "- **All functions:** $FUNC_LIST" >> $REPORT_FILE
          else
            echo "- **Result:** âš ï¸ Could not list functions" >> $REPORT_FILE
          fi
          echo "" >> $REPORT_FILE

          # 3. Service Account IAM
          echo "## Service Account IAM Roles" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          set +e
          IAM_ROLES=$(gcloud projects get-iam-policy $PROJECT_ID \
            --flatten="bindings[].members" \
            --filter="bindings.members:serviceAccount:claude-code-agent@$PROJECT_ID.iam.gserviceaccount.com" \
            --format="value(bindings.role)" 2>&1)
          IAM_EXIT=$?
          set -e

          if [ $IAM_EXIT -eq 0 ]; then
            echo "\`\`\`" >> $REPORT_FILE
            echo "$IAM_ROLES" >> $REPORT_FILE
            echo "\`\`\`" >> $REPORT_FILE

            if echo "$IAM_ROLES" | grep -q "serviceAccountUser"; then
              echo "- **serviceAccountUser role:** âœ… GRANTED" >> $REPORT_FILE
            else
              echo "- **serviceAccountUser role:** âš ï¸ MISSING" >> $REPORT_FILE
            fi
          else
            echo "- **Result:** âš ï¸ Could not check IAM" >> $REPORT_FILE
          fi
          echo "" >> $REPORT_FILE

          # 4. Enabled APIs
          echo "## Required APIs Status" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          set +e
          APIS=$(gcloud services list --enabled \
            --filter="name:cloudfunctions.googleapis.com OR name:cloudbuild.googleapis.com OR name:run.googleapis.com" \
            --format="value(name)" 2>&1)
          API_EXIT=$?
          set -e

          if [ $API_EXIT -eq 0 ]; then
            for api in "cloudfunctions.googleapis.com" "cloudbuild.googleapis.com" "run.googleapis.com"; do
              if echo "$APIS" | grep -q "$api"; then
                echo "- $api: âœ…" >> $REPORT_FILE
              else
                echo "- $api: âŒ" >> $REPORT_FILE
              fi
            done
          else
            echo "- **Result:** âš ï¸ Could not check APIs" >> $REPORT_FILE
          fi
          echo "" >> $REPORT_FILE

          # 5. Function URL Test
          echo "## Function Accessibility Test" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          FUNC_URL="https://us-central1-$PROJECT_ID.cloudfunctions.net/mcp-router"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FUNC_URL" 2>&1 || echo "ERROR")
          echo "- **URL:** $FUNC_URL" >> $REPORT_FILE
          echo "- **HTTP Status:** $HTTP_CODE" >> $REPORT_FILE

          if [ "$HTTP_CODE" = "404" ]; then
            echo "- **Result:** âŒ Function NOT deployed" >> $REPORT_FILE
          elif [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "400" ]; then
            echo "- **Result:** âœ… Function IS deployed" >> $REPORT_FILE
          else
            echo "- **Result:** âš ï¸ Unexpected status" >> $REPORT_FILE
          fi
          echo "" >> $REPORT_FILE

          # 6. Conclusion
          echo "## Diagnosis Conclusion" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          if [ "$BILLING_ENABLED" = "false" ]; then
            echo "ðŸ”´ **ROOT CAUSE: Billing is DISABLED**" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            echo "This prevents Cloud Function deployment. Enable billing to proceed." >> $REPORT_FILE
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âš ï¸ **Function not deployed despite billing being enabled**" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            echo "Check deployment logs for specific errors (quota, permissions, code issues)." >> $REPORT_FILE
          else
            echo "âœ… **Function appears to be working**" >> $REPORT_FILE
          fi

          # Print to console
          cat $REPORT_FILE

          # Create GitHub Issue with diagnostic report
          # (Cannot push to main due to branch protection)
          echo ""
          echo "Creating GitHub Issue with diagnostic report..."

          ISSUE_TITLE="[Diagnostic] GCP Billing & Deployment Status - $(date +%Y-%m-%d_%H:%M)"
          ISSUE_BODY=$(cat $REPORT_FILE)

          ISSUE_URL=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues" \
            -d "$(jq -n --arg title "$ISSUE_TITLE" --arg body "$ISSUE_BODY" '{title: $title, body: $body, labels: ["diagnostic", "automated"]}')" \
            | jq -r '.html_url // "ERROR"')

          if [ "$ISSUE_URL" != "ERROR" ]; then
            echo "âœ… Diagnostic report published to: $ISSUE_URL"
          else
            echo "âŒ Failed to create issue"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Billing Status Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See workflow logs above for detailed billing information." >> $GITHUB_STEP_SUMMARY
