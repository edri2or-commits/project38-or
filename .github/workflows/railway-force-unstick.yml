name: Railway Force Unstick

on:
  workflow_dispatch:
    inputs:
      deployment_id:
        description: 'Deployment ID to remove (leave empty to remove all QUEUED)'
        required: false
      issue_number:
        description: 'Issue number for results'
        required: true
        type: number

permissions:
  contents: read
  id-token: write
  issues: write

env:
  PROJECT_ID: project38-483612
  RAILWAY_API: https://backboard.railway.app/graphql/v2
  RAILWAY_PROJECT_ID: "95ec21cc-9ada-41c5-8485-12f9a00e0116"
  RAILWAY_ENV_ID: "99c99a18-aea2-4d01-9360-6a93705102a0"
  RAILWAY_SERVICE_ID: "7d427f80-c97f-4c8b-a301-2fecbd6d1331"

jobs:
  unstick:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Railway Token
        id: get-token
        run: |
          TOKEN=$(gcloud secrets versions access latest --secret="RAILWAY-API" --project="${PROJECT_ID}")
          echo "::add-mask::${TOKEN}"
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT

      - name: Get QUEUED Deployments
        id: get-queued
        run: |
          echo "Getting QUEUED deployments..."

          RESPONSE=$(curl -s -X POST "$RAILWAY_API" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { deployments(input: { projectId: \"'"$RAILWAY_PROJECT_ID"'\", serviceId: \"'"$RAILWAY_SERVICE_ID"'\" }, first: 10) { edges { node { id status createdAt } } } }"
            }')

          echo "Response: $RESPONSE"

          QUEUED_IDS=$(echo "$RESPONSE" | jq -r '.data.deployments.edges[] | select(.node.status == "QUEUED") | .node.id')
          echo "QUEUED IDs: $QUEUED_IDS"

          echo "queued_ids<<EOF" >> $GITHUB_OUTPUT
          echo "$QUEUED_IDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Remove QUEUED Deployments
        run: |
          echo "Removing QUEUED deployments..."

          QUEUED_IDS="${{ steps.get-queued.outputs.queued_ids }}"

          if [ -z "$QUEUED_IDS" ]; then
            echo "No QUEUED deployments found"
            exit 0
          fi

          for ID in $QUEUED_IDS; do
            echo "Removing deployment: $ID"

            RESPONSE=$(curl -s -X POST "$RAILWAY_API" \
              -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
              -H "Content-Type: application/json" \
              -d "{\"query\": \"mutation { deploymentRemove(id: \\\"$ID\\\") }\"}")

            echo "Result: $RESPONSE"
            sleep 1
          done

      - name: Fresh Redeploy
        id: redeploy
        run: |
          echo "Waiting 5s then triggering fresh redeploy..."
          sleep 5

          RESPONSE=$(curl -s -X POST "$RAILWAY_API" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { serviceInstanceRedeploy(environmentId: \\\"$RAILWAY_ENV_ID\\\", serviceId: \\\"$RAILWAY_SERVICE_ID\\\") }\"}")

          echo "Redeploy result: $RESPONSE"

          if echo "$RESPONSE" | grep -q "error"; then
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "success=true" >> $GITHUB_OUTPUT
          fi

      - name: Wait and Check Status
        run: |
          echo "Waiting 30s for deployment to progress..."
          sleep 30

          RESPONSE=$(curl -s -X POST "$RAILWAY_API" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { deployments(input: { projectId: \"'"$RAILWAY_PROJECT_ID"'\", serviceId: \"'"$RAILWAY_SERVICE_ID"'\" }, first: 3) { edges { node { id status createdAt } } } }"
            }')

          echo "Final status: $RESPONSE" | jq '.'

      - name: Post Results
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BODY="## Railway Force Unstick Results

          Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          Removed QUEUED deployments and triggered fresh redeploy.

          Redeploy success: ${{ steps.redeploy.outputs.success }}

          Check Railway dashboard for final status."

          gh issue comment ${{ inputs.issue_number }} --body "$BODY" --repo ${{ github.repository }}
