# Daily Email Agent v2.0 - LangGraph-based email processing
#
# Runs automatically every morning at 07:00 Israel time (05:00 UTC)
# Can also be triggered manually via workflow_dispatch
#
# Architecture: FETCH ‚Üí CLASSIFY ‚Üí RESEARCH ‚Üí HISTORY ‚Üí DRAFT ‚Üí FORMAT ‚Üí SEND
# ADR-014: Smart Email Agent with Telegram Integration

name: Daily Email Agent

on:
  schedule:
    # Run at 05:00 UTC = 07:00 Israel time (winter) / 08:00 Israel time (summer)
    - cron: '0 5 * * *'

  workflow_dispatch:
    inputs:
      hours:
        description: 'Hours to look back for emails'
        required: false
        default: '24'
        type: string
      send_telegram:
        description: 'Send summary to Telegram'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run (test without API calls)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write  # For GCP Workload Identity Federation

concurrency:
  group: email-agent
  cancel-in-progress: false  # Don't cancel running email scans

jobs:
  run-email-agent:
    name: Run Email Agent
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install httpx openai langgraph

      - name: Authenticate to GCP
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: project38-483612

      - name: Get secrets from GCP
        id: secrets
        run: |
          # Get MCP Tunnel token (for GCP Tunnel which has OAuth secrets)
          MCP_TOKEN=$(gcloud secrets versions access latest --secret="MCP-TUNNEL-TOKEN" 2>/dev/null || echo "")
          if [ -n "$MCP_TOKEN" ]; then
            echo "MCP_GATEWAY_TOKEN=$MCP_TOKEN" >> $GITHUB_ENV
            echo "MCP_GATEWAY_URL=https://mcp-router-979429709900.us-central1.run.app" >> $GITHUB_ENV
            echo "‚úÖ MCP Tunnel token loaded (GCP Tunnel)"
          else
            echo "‚ö†Ô∏è MCP Tunnel token not found"
          fi

          # Get Telegram bot token
          BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" 2>/dev/null || echo "")
          if [ -n "$BOT_TOKEN" ]; then
            echo "TELEGRAM_BOT_TOKEN=$BOT_TOKEN" >> $GITHUB_ENV
            echo "‚úÖ Telegram bot token loaded"
          else
            echo "‚ö†Ô∏è Telegram bot token not found"
          fi

          # Get Telegram chat ID
          CHAT_ID=$(gcloud secrets versions access latest --secret="TELEGRAM-CHAT-ID" 2>/dev/null || echo "")
          if [ -n "$CHAT_ID" ]; then
            echo "TELEGRAM_CHAT_ID=$CHAT_ID" >> $GITHUB_ENV
            echo "‚úÖ Telegram chat ID loaded"
          else
            echo "‚ö†Ô∏è Telegram chat ID not found"
          fi

      - name: Run Email Agent v2.0
        if: ${{ !inputs.dry_run }}
        id: run_agent
        env:
          PYTHONPATH: ${{ github.workspace }}
          MCP_GATEWAY_URL: ${{ env.MCP_GATEWAY_URL }}
          MCP_GATEWAY_TOKEN: ${{ env.MCP_GATEWAY_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ env.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ env.TELEGRAM_CHAT_ID }}
        run: |
          HOURS="${{ inputs.hours || '24' }}"
          SEND_TELEGRAM="${{ inputs.send_telegram != 'false' && 'true' || 'false' }}"

          echo "üìß Running Smart Email Agent v2.0 (LangGraph)..."
          echo "   Hours: $HOURS"
          echo "   Send Telegram: $SEND_TELEGRAM"
          echo "   Phase 2 Intelligence: Enabled"
          echo "   MCP_GATEWAY_URL: ${MCP_GATEWAY_URL:-(not set)}"
          echo "   MCP_GATEWAY_TOKEN: ${MCP_GATEWAY_TOKEN:+SET}"
          echo "   TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:+SET}"
          echo "   TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-(not set)}"
          echo ""

          python -c "
          import asyncio
          import sys
          import traceback
          sys.path.insert(0, '.')

          async def main():
              try:
                  from src.agents.smart_email.graph import run_smart_email_agent

                  result = await run_smart_email_agent(
                      hours=int('$HOURS'),
                      send_telegram='$SEND_TELEGRAM' == 'true',
                      enable_phase2=True,
                      enable_research=True,
                      enable_history=True,
                      enable_drafts=True,
                  )

                  # Print summary
                  print('\\n=== Results ===')
                  print(f'Total emails: {result.get(\"total_count\", 0)}')
                  print(f'System filtered: {result.get(\"system_emails_count\", 0)}')
                  print(f'P1 (urgent): {result.get(\"p1_count\", 0)}')
                  print(f'P2 (important): {result.get(\"p2_count\", 0)}')
                  print(f'P3 (info): {result.get(\"p3_count\", 0)}')
                  print(f'P4 (low): {result.get(\"p4_count\", 0)}')
                  print(f'Researched: {result.get(\"research_count\", 0)}')
                  print(f'Drafts generated: {result.get(\"drafts_count\", 0)}')
                  print(f'Duration: {result.get(\"duration_ms\", 0)}ms')
                  print(f'Telegram sent: {result.get(\"telegram_sent\", False)}')

                  # Only fail on critical errors, not Telegram failures
                  errors = result.get('errors', [])
                  if errors:
                      print(f'Errors: {errors}')
                      # Check if it's just a Telegram error
                      critical = [e for e in errors if 'telegram' not in str(e).lower()]
                      if critical:
                          sys.exit(1)
                      else:
                          print('‚ö†Ô∏è Telegram error only - not failing workflow')

                  # Check Telegram status
                  if result.get('telegram_error'):
                      print(f'‚ö†Ô∏è Telegram error: {result.get(\"telegram_error\")}')

              except Exception as e:
                  print(f'\\n‚ùå EXCEPTION: {type(e).__name__}: {e}')
                  traceback.print_exc()
                  # Don't fail on Telegram-related exceptions
                  if 'telegram' in str(e).lower():
                      print('‚ö†Ô∏è Telegram exception - continuing')
                  else:
                      sys.exit(1)

          asyncio.run(main())
          "

      - name: Dry Run Mode
        if: ${{ inputs.dry_run }}
        run: |
          echo "üß™ DRY RUN MODE - Smart Email Agent v2.0"
          echo ""
          echo "Would run Email Agent with:"
          echo "  Hours: ${{ inputs.hours || '24' }}"
          echo "  Send Telegram: ${{ inputs.send_telegram != 'false' }}"
          echo "  Phase 2: Enabled (research, history, drafts)"
          echo ""
          echo "Environment check:"
          echo "  MCP_GATEWAY_TOKEN: ${{ env.MCP_GATEWAY_TOKEN != '' && '‚úÖ Set' || '‚ùå Missing' }}"
          echo "  TELEGRAM_CHAT_ID: ${{ env.TELEGRAM_CHAT_ID != '' && '‚úÖ Set' || '‚ùå Missing' }}"
          echo ""
          echo "Testing v2.0 imports..."

          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.agents.smart_email.graph import SmartEmailGraph, run_smart_email_agent
          from src.agents.smart_email.state import EmailCategory, Priority
          print('‚úÖ SmartEmailGraph v2.0 imported successfully')

          graph = SmartEmailGraph(enable_phase2=True)
          print(f'   Graph nodes: {list(graph.graph.nodes.keys())}')
          print(f'   Categories: {[c.value for c in EmailCategory]}')
          print(f'   Priorities: {[p.name for p in Priority]}')
          "

      - name: Report failure
        if: failure()
        run: |
          echo "‚ùå Email Agent failed!"
          echo "Check the logs above for details."
          # Could send failure notification to Telegram here
