name: GCP Tunnel Health Check

# Scheduled health check to ensure GCP Tunnel is working
# Runs every 6 hours and on manual trigger

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      notify_on_success:
        description: 'Create issue on success (for testing)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  id-token: write
  issues: write

concurrency:
  group: gcp-tunnel-health-check
  cancel-in-progress: true

env:
  PROJECT_ID: project38-483612
  SERVICE_ACCOUNT: claude-code-agent@project38-483612.iam.gserviceaccount.com
  CLOUD_RUN_URL: https://mcp-router-979429709900.us-central1.run.app
  CLOUD_FUNCTION_URL: https://us-central1-project38-483612.cloudfunctions.net/mcp-router

jobs:
  health-check:
    runs-on: ubuntu-latest
    outputs:
      cloud_run_status: ${{ steps.check-cloud-run.outputs.status }}
      cloud_function_status: ${{ steps.check-cloud-function.outputs.status }}
      mcp_tools_status: ${{ steps.check-mcp-tools.outputs.status }}
      tool_tests_status: ${{ steps.test-tools.outputs.status }}
      tool_tests_passed: ${{ steps.test-tools.outputs.passed }}
      tool_tests_failed: ${{ steps.test-tools.outputs.failed }}
      overall_status: ${{ steps.summary.outputs.overall_status }}

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get MCP Tunnel Token
        id: get-token
        run: |
          TOKEN=$(gcloud secrets versions access latest --secret="MCP-TUNNEL-TOKEN" --project="${PROJECT_ID}" 2>/dev/null || echo "")
          if [ -z "$TOKEN" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "::error::Could not retrieve MCP-TUNNEL-TOKEN from Secret Manager"
          else
            echo "::add-mask::${TOKEN}"
            echo "token=${TOKEN}" >> $GITHUB_OUTPUT
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      - name: Check Cloud Run Health
        id: check-cloud-run
        if: steps.get-token.outputs.status == 'ok'
        run: |
          echo "Checking Cloud Run at: ${{ env.CLOUD_RUN_URL }}"

          HTTP_CODE=$(curl -s -o /tmp/cloudrun-response.txt -w "%{http_code}" \
            "${{ env.CLOUD_RUN_URL }}/health" \
            --max-time 30 || echo "000")

          RESPONSE=$(cat /tmp/cloudrun-response.txt 2>/dev/null || echo "No response")

          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "‚úÖ Cloud Run is healthy"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "‚ùå Cloud Run is unhealthy (HTTP $HTTP_CODE)"
          fi

      - name: Check Cloud Function Health
        id: check-cloud-function
        if: steps.get-token.outputs.status == 'ok'
        run: |
          echo "Checking Cloud Function at: ${{ env.CLOUD_FUNCTION_URL }}"

          # Cloud Function proxies to Cloud Run, so a 502/504 from CF means CF is up but backend is down
          HTTP_CODE=$(curl -s -o /tmp/cf-response.txt -w "%{http_code}" \
            -X POST "${{ env.CLOUD_FUNCTION_URL }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --max-time 30 || echo "000")

          RESPONSE=$(cat /tmp/cf-response.txt 2>/dev/null || echo "No response")

          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE"

          # 401 means CF is responding (auth required) - that's good!
          # 502/504 means CF is up but can't reach backend
          # 200 means everything works
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "‚úÖ Cloud Function is healthy"
          elif [ "$HTTP_CODE" = "502" ] || [ "$HTTP_CODE" = "504" ]; then
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Cloud Function is up but backend unreachable"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "‚ùå Cloud Function is unhealthy (HTTP $HTTP_CODE)"
          fi

      - name: Check MCP Tools Access
        id: check-mcp-tools
        if: steps.get-token.outputs.status == 'ok' && steps.check-cloud-run.outputs.status == 'healthy'
        run: |
          echo "Checking MCP tools access..."

          RESPONSE=$(curl -s -X POST "${{ env.CLOUD_RUN_URL }}/" \
            -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{"data": "{\"jsonrpc\": \"2.0\", \"method\": \"tools/list\", \"id\": 1}"}' \
            --max-time 30 || echo '{"error": "request failed"}')

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q "tools"; then
            TOOL_COUNT=$(echo "$RESPONSE" | grep -o '"name"' | wc -l)
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "tool_count=$TOOL_COUNT" >> $GITHUB_OUTPUT
            echo "‚úÖ MCP tools accessible ($TOOL_COUNT tools)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "tool_count=0" >> $GITHUB_OUTPUT
            echo "‚ùå MCP tools not accessible"
          fi

      - name: Test Individual Tools
        id: test-tools
        if: steps.check-mcp-tools.outputs.status == 'healthy'
        run: |
          echo "Testing individual MCP tools..."

          # Helper function to call MCP tool
          call_tool() {
            local tool_name=$1
            local args=$2
            curl -s -X POST "${{ env.CLOUD_RUN_URL }}/" \
              -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
              -H "Content-Type: application/json" \
              -d "{\"data\": \"{\\\"jsonrpc\\\": \\\"2.0\\\", \\\"method\\\": \\\"tools/call\\\", \\\"params\\\": {\\\"name\\\": \\\"$tool_name\\\", \\\"arguments\\\": $args}, \\\"id\\\": 1}\"}" \
              --max-time 30 2>/dev/null || echo '{"error": "request failed"}'
          }

          PASSED=0
          FAILED=0
          RESULTS=""

          # Test 1: gcp_project_info
          echo "üîç Testing gcp_project_info..."
          RESP=$(call_tool "gcp_project_info" "{}")
          if echo "$RESP" | grep -q "project38-483612\|project_id"; then
            echo "‚úÖ gcp_project_info: PASS"
            RESULTS="${RESULTS}gcp_project_info:pass,"
            PASSED=$((PASSED + 1))
          else
            echo "‚ùå gcp_project_info: FAIL"
            echo "Response: $RESP"
            RESULTS="${RESULTS}gcp_project_info:fail,"
            FAILED=$((FAILED + 1))
          fi

          # Test 2: gcp_secret_list
          echo "üîç Testing gcp_secret_list..."
          RESP=$(call_tool "gcp_secret_list" "{}")
          if echo "$RESP" | grep -q "secrets\|ANTHROPIC\|MCP"; then
            echo "‚úÖ gcp_secret_list: PASS"
            RESULTS="${RESULTS}gcp_secret_list:pass,"
            PASSED=$((PASSED + 1))
          else
            echo "‚ùå gcp_secret_list: FAIL"
            echo "Response: $RESP"
            RESULTS="${RESULTS}gcp_secret_list:fail,"
            FAILED=$((FAILED + 1))
          fi

          # Test 3: health_check (monitoring tool)
          echo "üîç Testing health_check..."
          RESP=$(call_tool "health_check" "{}")
          if echo "$RESP" | grep -q "healthy\|status\|ok"; then
            echo "‚úÖ health_check: PASS"
            RESULTS="${RESULTS}health_check:pass,"
            PASSED=$((PASSED + 1))
          else
            echo "‚ùå health_check: FAIL"
            echo "Response: $RESP"
            RESULTS="${RESULTS}health_check:fail,"
            FAILED=$((FAILED + 1))
          fi

          # Test 4: railway_status
          echo "üîç Testing railway_status..."
          RESP=$(call_tool "railway_status" "{}")
          if echo "$RESP" | grep -q "delightful-cat\|status\|project\|deployments"; then
            echo "‚úÖ railway_status: PASS"
            RESULTS="${RESULTS}railway_status:pass,"
            PASSED=$((PASSED + 1))
          else
            echo "‚ùå railway_status: FAIL"
            echo "Response: $RESP"
            RESULTS="${RESULTS}railway_status:fail,"
            FAILED=$((FAILED + 1))
          fi

          # Test 5: railway_logs (WebSocket-based log fetching)
          echo "üîç Testing railway_logs..."
          RESP=$(call_tool "railway_logs" "{\"service_name\": \"telegram-bot\", \"log_type\": \"build\", \"timeout_seconds\": 15}")
          if echo "$RESP" | grep -q "logs\|entries\|completed\|no_logs\|error"; then
            # Success if we got any response (logs, no_logs, or even errors are OK - means tool works)
            echo "‚úÖ railway_logs: PASS"
            RESULTS="${RESULTS}railway_logs:pass,"
            PASSED=$((PASSED + 1))
            # Show first part of response for debugging
            echo "Response preview: $(echo "$RESP" | head -c 200)"
          else
            echo "‚ùå railway_logs: FAIL"
            echo "Response: $RESP"
            RESULTS="${RESULTS}railway_logs:fail,"
            FAILED=$((FAILED + 1))
          fi

          echo ""
          echo "üìä Tool Test Results: $PASSED passed, $FAILED failed"

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "results=$RESULTS" >> $GITHUB_OUTPUT

          if [ "$FAILED" -eq 0 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
          fi

      - name: Generate Summary
        id: summary
        run: |
          echo "## GCP Tunnel Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Secret Manager
          if [ "${{ steps.get-token.outputs.status }}" = "ok" ]; then
            echo "| Secret Manager | ‚úÖ Token retrieved |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Manager | ‚ùå Token missing |" >> $GITHUB_STEP_SUMMARY
          fi

          # Cloud Run
          CR_STATUS="${{ steps.check-cloud-run.outputs.status }}"
          if [ "$CR_STATUS" = "healthy" ]; then
            echo "| Cloud Run | ‚úÖ Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Cloud Run | ‚ùå Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi

          # Cloud Function
          CF_STATUS="${{ steps.check-cloud-function.outputs.status }}"
          if [ "$CF_STATUS" = "healthy" ]; then
            echo "| Cloud Function | ‚úÖ Healthy |" >> $GITHUB_STEP_SUMMARY
          elif [ "$CF_STATUS" = "partial" ]; then
            echo "| Cloud Function | ‚ö†Ô∏è Partial |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Cloud Function | ‚ùå Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi

          # MCP Tools
          MCP_STATUS="${{ steps.check-mcp-tools.outputs.status }}"
          TOOL_COUNT="${{ steps.check-mcp-tools.outputs.tool_count }}"
          if [ "$MCP_STATUS" = "healthy" ]; then
            echo "| MCP Tools | ‚úÖ $TOOL_COUNT tools |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MCP Tools | ‚ùå Not accessible |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Individual Tool Tests
          TOOL_TEST_STATUS="${{ steps.test-tools.outputs.status }}"
          TOOL_PASSED="${{ steps.test-tools.outputs.passed }}"
          TOOL_FAILED="${{ steps.test-tools.outputs.failed }}"

          if [ -n "$TOOL_PASSED" ]; then
            echo "### Individual Tool Tests" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Tool | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

            # Parse results
            RESULTS="${{ steps.test-tools.outputs.results }}"
            for result in $(echo "$RESULTS" | tr ',' ' '); do
              if [ -n "$result" ]; then
                tool_name=$(echo "$result" | cut -d':' -f1)
                tool_status=$(echo "$result" | cut -d':' -f2)
                if [ "$tool_status" = "pass" ]; then
                  echo "| $tool_name | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| $tool_name | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Summary:** $TOOL_PASSED passed, $TOOL_FAILED failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Determine overall status
          if [ "${{ steps.get-token.outputs.status }}" = "ok" ] && \
             [ "$CR_STATUS" = "healthy" ] && \
             [ "$CF_STATUS" = "healthy" ] && \
             [ "$MCP_STATUS" = "healthy" ] && \
             [ "$TOOL_TEST_STATUS" = "healthy" ]; then
            echo "### ‚úÖ All systems operational" >> $GITHUB_STEP_SUMMARY
            echo "overall_status=healthy" >> $GITHUB_OUTPUT
          elif [ "${{ steps.get-token.outputs.status }}" = "ok" ] && \
               [ "$CR_STATUS" = "healthy" ] && \
               [ "$CF_STATUS" = "healthy" ] && \
               [ "$MCP_STATUS" = "healthy" ]; then
            echo "### ‚ö†Ô∏è Systems operational with some tool failures" >> $GITHUB_STEP_SUMMARY
            echo "overall_status=partial" >> $GITHUB_OUTPUT
          else
            echo "### ‚ùå Issues detected" >> $GITHUB_STEP_SUMMARY
            echo "overall_status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Create Alert Issue on Failure
        if: steps.summary.outputs.overall_status == 'unhealthy'
        uses: actions/github-script@v7
        env:
          SECRET_STATUS: ${{ steps.get-token.outputs.status }}
          CR_STATUS: ${{ steps.check-cloud-run.outputs.status }}
          CF_STATUS: ${{ steps.check-cloud-function.outputs.status }}
          MCP_STATUS: ${{ steps.check-mcp-tools.outputs.status }}
        with:
          script: |
            const secretIcon = process.env.SECRET_STATUS === 'ok' ? '‚úÖ' : '‚ùå';
            const crIcon = process.env.CR_STATUS === 'healthy' ? '‚úÖ' : '‚ùå';
            const cfIcon = process.env.CF_STATUS === 'healthy' ? '‚úÖ' : (process.env.CF_STATUS === 'partial' ? '‚ö†Ô∏è' : '‚ùå');
            const mcpIcon = process.env.MCP_STATUS === 'healthy' ? '‚úÖ' : '‚ùå';

            const title = `üö® GCP Tunnel Health Check Failed - ${new Date().toISOString().slice(0, 16)}`;
            const body = `## GCP Tunnel Health Check Alert

            **Time:** ${new Date().toISOString()}
            **Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Status

            | Component | Status |
            |-----------|--------|
            | Secret Manager | ${secretIcon} |
            | Cloud Run | ${crIcon} |
            | Cloud Function | ${cfIcon} |
            | MCP Tools | ${mcpIcon} |

            ### Troubleshooting

            1. Check Cloud Run logs: \`gcloud run services logs read mcp-router --region=us-central1\`
            2. Check Cloud Function logs: \`gcloud functions logs read mcp-router --region=us-central1\`
            3. Verify token in Secret Manager: \`gcloud secrets versions access latest --secret="MCP-TUNNEL-TOKEN"\`
            4. Redeploy if needed: Run \`deploy-mcp-router-cloudrun.yml\` workflow
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-check-failure', 'gcp-tunnel']
            });

      - name: Create Success Issue (if requested)
        if: steps.summary.outputs.overall_status == 'healthy' && inputs.notify_on_success == 'true'
        uses: actions/github-script@v7
        env:
          TOOL_COUNT: ${{ steps.check-mcp-tools.outputs.tool_count }}
        with:
          script: |
            const toolCount = process.env.TOOL_COUNT || '0';
            const title = `‚úÖ GCP Tunnel Health Check Passed - ${new Date().toISOString().slice(0, 16)}`;
            const body = `## GCP Tunnel Health Check Success

            **Time:** ${new Date().toISOString()}
            **Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            All components are operational:
            - ‚úÖ Secret Manager: Token retrieved
            - ‚úÖ Cloud Run: Healthy
            - ‚úÖ Cloud Function: Healthy
            - ‚úÖ MCP Tools: ${toolCount} tools accessible
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-check-success', 'gcp-tunnel']
            });
