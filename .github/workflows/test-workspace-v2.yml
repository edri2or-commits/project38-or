name: Test Workspace V2

on:
  workflow_dispatch:
    inputs:
      email:
        description: 'Email to send test to'
        required: true
        type: string

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-auth google-auth-oauthlib google-api-python-client

      - name: Test and Report
        env:
          GH_TOKEN: ${{ github.token }}
          TEST_EMAIL: ${{ inputs.email }}
        run: |
          python << 'PYTHON_EOF' 2>&1 | tee test_output.txt
          import os
          import subprocess
          import json
          import traceback
          from datetime import datetime, timedelta

          print("=" * 60)
          print("üîç WORKSPACE AUTONOMY TEST - DETAILED LOG")
          print("=" * 60)

          def get_secret(name):
              print(f"  Getting secret: {name}")
              result = subprocess.run(
                  ["gcloud", "secrets", "versions", "access", "latest",
                   f"--secret={name}", "--project=project38-483612"],
                  capture_output=True, text=True
              )
              if result.returncode != 0:
                  print(f"  ‚ùå Failed to get {name}: {result.stderr}")
                  return None
              print(f"  ‚úÖ Got {name} ({len(result.stdout)} chars)")
              return result.stdout.strip()

          # Get credentials
          print("\nüì¶ STEP 1: Loading credentials...")
          client_id = get_secret("GOOGLE-OAUTH-CLIENT-ID")
          client_secret = get_secret("GOOGLE-OAUTH-CLIENT-SECRET")
          refresh_token = get_secret("GOOGLE-OAUTH-REFRESH-TOKEN")

          if not all([client_id, client_secret, refresh_token]):
              print("\n‚ùå FATAL: Missing credentials!")
              exit(1)

          print("\nüîê STEP 2: Creating credentials object...")
          try:
              from google.oauth2.credentials import Credentials
              creds = Credentials(
                  token=None,
                  refresh_token=refresh_token,
                  token_uri="https://oauth2.googleapis.com/token",
                  client_id=client_id,
                  client_secret=client_secret,
                  scopes=[
                      "https://www.googleapis.com/auth/gmail.send",
                      "https://www.googleapis.com/auth/calendar"
                  ]
              )
              print("‚úÖ Credentials object created")
          except Exception as e:
              print(f"‚ùå Failed to create credentials: {e}")
              traceback.print_exc()
              exit(1)

          # Test Gmail
          print("\nüìß STEP 3: Testing Gmail...")
          gmail_result = "NOT TESTED"
          gmail_details = ""
          try:
              from googleapiclient.discovery import build
              from email.mime.text import MIMEText
              import base64

              print("  Building Gmail service...")
              gmail = build('gmail', 'v1', credentials=creds)

              print("  Creating message...")
              message = MIMEText(f"""Test email from Claude Autonomy System.

          Timestamp: {datetime.utcnow().isoformat()}
          """)
              message['to'] = os.environ['TEST_EMAIL']
              message['subject'] = f'ü§ñ Claude Test {datetime.utcnow().strftime("%H:%M:%S")}'

              raw = base64.urlsafe_b64encode(message.as_bytes()).decode()

              print("  Sending email...")
              result = gmail.users().messages().send(
                  userId='me',
                  body={'raw': raw}
              ).execute()

              gmail_result = "‚úÖ SUCCESS"
              gmail_details = f"Message ID: {result.get('id', 'unknown')}"
              print(f"  ‚úÖ Email sent! {gmail_details}")

          except Exception as e:
              gmail_result = "‚ùå FAILED"
              gmail_details = str(e)
              print(f"  ‚ùå Gmail error: {e}")
              traceback.print_exc()

          # Test Calendar
          print("\nüìÖ STEP 4: Testing Calendar...")
          calendar_result = "NOT TESTED"
          calendar_details = ""
          try:
              from googleapiclient.discovery import build

              print("  Building Calendar service...")
              calendar = build('calendar', 'v3', credentials=creds)

              start = datetime.utcnow() + timedelta(days=1)
              start = start.replace(hour=14, minute=0, second=0, microsecond=0)
              end = start + timedelta(hours=1)

              event = {
                  'summary': f'ü§ñ Claude Test {datetime.utcnow().strftime("%H:%M")}',
                  'start': {'dateTime': start.isoformat() + 'Z', 'timeZone': 'UTC'},
                  'end': {'dateTime': end.isoformat() + 'Z', 'timeZone': 'UTC'},
              }

              print("  Creating event...")
              result = calendar.events().insert(calendarId='primary', body=event).execute()

              calendar_result = "‚úÖ SUCCESS"
              calendar_details = f"Event ID: {result.get('id', 'unknown')}"
              print(f"  ‚úÖ Event created! {calendar_details}")

          except Exception as e:
              calendar_result = "‚ùå FAILED"
              calendar_details = str(e)
              print(f"  ‚ùå Calendar error: {e}")
              traceback.print_exc()

          print("\n" + "=" * 60)
          print("üìä SUMMARY")
          print("=" * 60)
          print(f"Gmail: {gmail_result} - {gmail_details}")
          print(f"Calendar: {calendar_result} - {calendar_details}")
          PYTHON_EOF

          # Post results to issue
          echo ""
          echo "üìù Posting to issue #149..."

          GMAIL_LINE=$(grep "^Gmail:" test_output.txt || echo "Gmail: Unknown")
          CALENDAR_LINE=$(grep "^Calendar:" test_output.txt || echo "Calendar: Unknown")

          gh issue comment 149 --body "## üß™ Workspace Test Results (V2)

          \`\`\`
          $GMAIL_LINE
          $CALENDAR_LINE
          \`\`\`

          **Target Email:** $TEST_EMAIL
          **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          <details>
          <summary>Full Log</summary>

          \`\`\`
          $(cat test_output.txt)
          \`\`\`
          </details>" --repo edri2or-commits/project38-or
