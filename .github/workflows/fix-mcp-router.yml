name: Fix MCP Router (Gen 1)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: project38-483612
  FUNCTION_NAME: mcp-router
  SERVICE_ACCOUNT: claude-code-agent@project38-483612.iam.gserviceaccount.com
  CLOUD_RUN_URL: https://mcp-router-3e7yyrd7xq-uc.a.run.app

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check current function state
        run: |
          echo "=== Current mcp-router state ==="
          gcloud functions describe ${{ env.FUNCTION_NAME }} --region=us-central1 --format="yaml(name,status,runtime,httpsTrigger.url)" || echo "Function not found"

      - name: Delete existing function (to force Gen 1)
        run: |
          echo "Deleting existing function to ensure clean Gen 1 deployment..."
          gcloud functions delete ${{ env.FUNCTION_NAME }} --region=us-central1 --quiet || echo "Function didn't exist"
          sleep 5

      - name: Deploy simple proxy to mcp-router (Gen 1)
        run: |
          echo "Deploying simple proxy code to mcp-router as Gen 1..."

          # --no-gen2 flag explicitly requests Gen 1
          gcloud functions deploy ${{ env.FUNCTION_NAME }} \
            --no-gen2 \
            --runtime=python311 \
            --region=us-central1 \
            --source=cloud_functions/mcp_proxy \
            --entry-point=mcp_proxy \
            --trigger-http \
            --allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --memory=256MB \
            --timeout=120s \
            --set-env-vars="CLOUD_RUN_URL=${{ env.CLOUD_RUN_URL }}"

          echo "✅ Deployment completed"

      - name: Set IAM policy for public access
        run: |
          echo "Setting IAM policy to allow unauthenticated access..."
          gcloud functions add-iam-policy-binding ${{ env.FUNCTION_NAME }} \
            --region=us-central1 \
            --member="allUsers" \
            --role="roles/cloudfunctions.invoker"
          echo "✅ IAM policy set"

      - name: Verify function
        run: |
          echo "=== Function state after deploy ==="
          gcloud functions describe ${{ env.FUNCTION_NAME }} --region=us-central1 --format="yaml(name,status,runtime,httpsTrigger.url)"

          echo ""
          echo "=== Testing HTTP endpoint ==="
          URL="https://us-central1-${{ env.PROJECT_ID }}.cloudfunctions.net/${{ env.FUNCTION_NAME }}"
          echo "URL: $URL"

          HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" -X POST "$URL" -H "Content-Type: application/json" -d '{}')
          echo "HTTP Status: $HTTP_CODE"
          echo "Response body:"
          cat /tmp/response.txt
          echo ""

          if [ "$HTTP_CODE" = "502" ] || [ "$HTTP_CODE" = "504" ]; then
            echo "⚠️ Backend connection issue (expected - Cloud Run blocked from GH Actions)"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "❌ 404 - Function not responding"
            exit 1
          elif [ "$HTTP_CODE" = "503" ]; then
            echo "❌ 503 - Service unavailable"
            exit 1
          else
            echo "✅ Function responding (status: $HTTP_CODE)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## MCP Router Fix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function:** ${{ env.FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://us-central1-${{ env.PROJECT_ID }}.cloudfunctions.net/${{ env.FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This deploys simple proxy code to the existing Gen 1 mcp-router function." >> $GITHUB_STEP_SUMMARY
