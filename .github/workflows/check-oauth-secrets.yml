name: Check OAuth Secrets

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: List ALL secrets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üîê All secrets in GCP Secret Manager:"
          echo ""

          SECRETS=$(gcloud secrets list --format="value(name)" --project=$GCP_PROJECT_ID)

          echo "| Secret Name | Status |"
          echo "|-------------|--------|"

          REPORT=""
          for secret in $SECRETS; do
            secret_name=$(basename $secret)
            if gcloud secrets versions access latest --secret="$secret_name" --project=$GCP_PROJECT_ID > /dev/null 2>&1; then
              echo "| $secret_name | ‚úÖ Accessible |"
              REPORT="$REPORT\n| $secret_name | ‚úÖ |"
            else
              echo "| $secret_name | ‚ùå No access |"
              REPORT="$REPORT\n| $secret_name | ‚ùå |"
            fi
          done

          # Post to issue #149
          gh issue comment 149 --body "## üîê Secret Manager Status ($(date -u +'%Y-%m-%d %H:%M UTC'))

          | Secret | Status |
          |--------|--------|$(echo -e "$REPORT")

          **Total secrets:** $(echo "$SECRETS" | wc -l)" --repo edri2or-commits/project38-or
