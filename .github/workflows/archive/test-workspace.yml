name: Test Google Workspace

on:
  workflow_dispatch:
    inputs:
      email:
        description: 'Email address to send test to'
        required: true
        type: string

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-auth google-auth-oauthlib google-api-python-client

      - name: Test Gmail and Calendar
        env:
          GH_TOKEN: ${{ github.token }}
          TEST_EMAIL: ${{ inputs.email }}
        run: |
          python << 'PYTHON_EOF'
          import os
          import subprocess
          import json
          from datetime import datetime, timedelta
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          import base64
          from email.mime.text import MIMEText

          # Get secrets from GCP
          def get_secret(name):
              result = subprocess.run(
                  ["gcloud", "secrets", "versions", "access", "latest",
                   f"--secret={name}", "--project=project38-483612"],
                  capture_output=True, text=True
              )
              return result.stdout.strip()

          print("ðŸ” Loading credentials from GCP Secret Manager...")
          client_id = get_secret("GOOGLE-OAUTH-CLIENT-ID")
          client_secret = get_secret("GOOGLE-OAUTH-CLIENT-SECRET")
          refresh_token = get_secret("GOOGLE-OAUTH-REFRESH-TOKEN")

          # Create credentials
          creds = Credentials(
              token=None,
              refresh_token=refresh_token,
              token_uri="https://oauth2.googleapis.com/token",
              client_id=client_id,
              client_secret=client_secret,
              scopes=[
                  "https://www.googleapis.com/auth/gmail.send",
                  "https://www.googleapis.com/auth/calendar"
              ]
          )

          results = []

          # Test Gmail
          print("\nðŸ“§ Testing Gmail...")
          try:
              gmail = build('gmail', 'v1', credentials=creds)

              # Create message
              message = MIMEText(f"""×©×œ×•×!

          ×–×”×• ×ž×™×™×œ ×‘×“×™×§×” ×ž-Claude Code Autonomy System.

          âœ… ×× ×§×™×‘×œ×ª ××ª ×”×ž×™×™×œ ×”×–×”, ×–×” ××•×ž×¨ ×©-Gmail Autonomy ×¢×•×‘×“!

          ---
          Sent: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}
          System: project38-or
          """)
              message['to'] = os.environ['TEST_EMAIL']
              message['subject'] = 'ðŸ¤– Claude Autonomy Test - Gmail Works!'

              raw = base64.urlsafe_b64encode(message.as_bytes()).decode()

              result = gmail.users().messages().send(
                  userId='me',
                  body={'raw': raw}
              ).execute()

              print(f"âœ… Gmail: Email sent! Message ID: {result['id']}")
              results.append(("Gmail", "âœ… Success", f"Message ID: {result['id']}"))
          except Exception as e:
              print(f"âŒ Gmail error: {e}")
              results.append(("Gmail", "âŒ Failed", str(e)[:100]))

          # Test Calendar
          print("\nðŸ“… Testing Calendar...")
          try:
              calendar = build('calendar', 'v3', credentials=creds)

              # Create event for tomorrow
              start = datetime.utcnow() + timedelta(days=1)
              start = start.replace(hour=10, minute=0, second=0, microsecond=0)
              end = start + timedelta(hours=1)

              event = {
                  'summary': 'ðŸ¤– Claude Autonomy Test Event',
                  'description': 'This event was created by Claude Code Autonomy System to verify Calendar access.',
                  'start': {
                      'dateTime': start.isoformat() + 'Z',
                      'timeZone': 'UTC',
                  },
                  'end': {
                      'dateTime': end.isoformat() + 'Z',
                      'timeZone': 'UTC',
                  },
              }

              result = calendar.events().insert(
                  calendarId='primary',
                  body=event
              ).execute()

              print(f"âœ… Calendar: Event created! Event ID: {result['id']}")
              results.append(("Calendar", "âœ… Success", f"Event: {result.get('htmlLink', 'created')}"))
          except Exception as e:
              print(f"âŒ Calendar error: {e}")
              results.append(("Calendar", "âŒ Failed", str(e)[:100]))

          # Post results to issue
          print("\nðŸ“ Posting results...")

          results_md = "\n".join([f"| {r[0]} | {r[1]} | {r[2]} |" for r in results])

          comment = f"""## ðŸ§ª Google Workspace Autonomy Test Results

          | Service | Status | Details |
          |---------|--------|---------|
          {results_md}

          **Test Email:** {os.environ['TEST_EMAIL']}
          **Timestamp:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}

          {'ðŸŽ‰ **Full Autonomy Confirmed!**' if all('âœ…' in r[1] for r in results) else 'âš ï¸ Some tests failed'}
          """

          print(comment)
          PYTHON_EOF
