name: Deploy to Railway

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Minimal permissions
permissions:
  contents: read
  id-token: write  # Required for WIF authentication

# Prevent concurrent deployments
concurrency:
  group: railway-deploy-${{ github.ref }}-${{ inputs.environment }}
  cancel-in-progress: false  # Don't cancel in-progress deployments

jobs:
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: agentplatform
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .  # Install project in editable mode (src layout)
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run linter
        run: ruff check src/ tests/

      - name: Debug environment
        run: |
          echo "=== Python Version ==="
          python --version
          echo "=== Installed Packages ==="
          pip list | grep -E "(pytest|coverage|google|jwt)" || true
          echo "=== Test Import Check ==="
          python -c "from src.secrets_manager import SecretManager; print('âœ… Imports OK')" || echo "âŒ Import failed"

      - name: Run tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/agentplatform
        run: |
          # Run tests with same options as test.yml
          python -m pytest -v --tb=long -x 2>&1 | tee pytest-output.txt
          exit $?

      - name: Check documentation
        run: |
          pip install -q mkdocs mkdocs-material mkdocstrings[python]
          mkdocs build --strict

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment: Production  # Requires manual approval

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch Railway API Token
        id: railway-token
        run: |
          # Fetch RAILWAY-API token from GCP Secret Manager
          RAILWAY_TOKEN=$(gcloud secrets versions access latest --secret="RAILWAY-API" --project=project38-483612)
          echo "::add-mask::$RAILWAY_TOKEN"
          echo "token=$RAILWAY_TOKEN" >> $GITHUB_OUTPUT

      - name: Install Railway CLI
        run: |
          # Install Railway CLI using the official installer
          bash <(curl -fsSL https://railway.app/install.sh)
          railway version

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ steps.railway-token.outputs.token }}
          RAILWAY_SERVICE_ID: ${{ vars.RAILWAY_SERVICE_ID || '' }}
        run: |
          echo "ðŸš€ Deploying to Railway using CLI..."
          echo "Service ID: ${RAILWAY_SERVICE_ID:-not set}"

          # Deploy using Railway CLI
          # The CLI uses RAILWAY_TOKEN automatically for authentication
          # railway up deploys the current directory to Railway
          if [ -n "$RAILWAY_SERVICE_ID" ]; then
            echo "Deploying to service: $RAILWAY_SERVICE_ID"
            railway up --service "$RAILWAY_SERVICE_ID" --detach
          else
            echo "Deploying to linked service..."
            railway up --detach
          fi

          echo "âœ… Deployment started successfully"

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          sleep 30  # Give Railway time to deploy

          # TODO: Poll Railway API for deployment status
          # For now, we wait a fixed time

      - name: Health Check
        env:
          # IMPORTANT: Set this in GitHub Repository Variables
          # Get from Railway: Settings â†’ Networking â†’ Public Networking
          RAILWAY_URL: ${{ vars.RAILWAY_URL || 'NOT_SET' }}
        run: |
          echo "ðŸ¥ Running health check..."

          if [ "$RAILWAY_URL" = "NOT_SET" ]; then
            echo "âš ï¸  WARNING: RAILWAY_URL not configured"
            echo "Set in GitHub Repository Variables:"
            echo "  Settings â†’ Secrets and variables â†’ Actions â†’ Variables"
            echo "  Name: RAILWAY_URL"
            echo "  Value: https://your-app.up.railway.app"
            echo ""
            echo "â­ï¸  Skipping health check for now"
            exit 0
          fi

          echo "Checking: $RAILWAY_URL/api/health"

          # Health check with retries
          MAX_RETRIES=5
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$RAILWAY_URL/api/health" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed (HTTP $HTTP_CODE)"

              # Get health check details
              curl -s "$RAILWAY_URL/api/health" | jq '.' || echo "Response received"
              exit 0
            fi

            echo "â³ HTTP $HTTP_CODE - Retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Railway Deployment Summary"
          echo ""
          echo "- **Environment:** ${{ inputs.environment }}"
          echo "- **Branch:** ${{ github.ref_name }}"
          echo "- **Commit:** ${{ github.sha }}"
          echo "- **Triggered by:** ${{ github.actor }}"
          echo ""
          echo "âœ… Deployment complete"

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment: Production

    steps:
      - name: Rollback deployment
        run: |
          echo "ðŸ”„ Rollback triggered due to deployment failure"

          # TODO: Implement rollback logic
          # Railway supports rollback via API or dashboard

          echo "âš ï¸  Manual rollback may be required via Railway dashboard"
