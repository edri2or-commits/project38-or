name: Deploy to Railway

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Minimal permissions
permissions:
  contents: read
  id-token: write  # Required for WIF authentication

# Prevent concurrent deployments
concurrency:
  group: railway-deploy-${{ github.ref }}-${{ inputs.environment }}
  cancel-in-progress: false  # Don't cancel in-progress deployments

jobs:
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -q -r requirements.txt
          pip install -q -r requirements-dev.txt

      - name: Run linter
        run: ruff check src/ tests/

      - name: Run tests
        run: python -m pytest tests/ -v --tb=short

      - name: Check documentation
        run: |
          pip install -q mkdocs mkdocs-material mkdocstrings[python]
          mkdocs build --strict

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment: Production  # Requires manual approval

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch Railway API Token
        id: railway-token
        run: |
          # Fetch RAILWAY-API token from GCP Secret Manager
          RAILWAY_TOKEN=$(gcloud secrets versions access latest --secret="RAILWAY-API" --project=project38-483612)
          echo "::add-mask::$RAILWAY_TOKEN"
          echo "token=$RAILWAY_TOKEN" >> $GITHUB_OUTPUT

      - name: Trigger Railway Deployment
        env:
          RAILWAY_TOKEN: ${{ steps.railway-token.outputs.token }}
        run: |
          # Deploy to Railway using API
          # Railway automatically detects Python projects and runs them

          echo "üöÄ Deploying to Railway..."

          # Trigger deployment via Railway API
          # Note: This assumes Railway project is already set up
          RESPONSE=$(curl -s -X POST \
            "https://backboard.railway.app/graphql" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { deploymentTrigger(projectId: \"YOUR_PROJECT_ID\", environmentId: \"YOUR_ENV_ID\") { id status } }"
            }')

          echo "Response: $RESPONSE"

          # TODO: Replace YOUR_PROJECT_ID and YOUR_ENV_ID with actual values
          # Get these from Railway dashboard: Settings -> General

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30  # Give Railway time to deploy

          # TODO: Poll Railway API for deployment status
          # For now, we wait a fixed time

      - name: Health Check
        run: |
          echo "üè• Running health check..."

          # TODO: Replace with your actual Railway URL
          # RAILWAY_URL="https://your-app.up.railway.app"

          # Health check endpoint
          # RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$RAILWAY_URL/health")

          # if [ "$RESPONSE" != "200" ]; then
          #   echo "‚ùå Health check failed: HTTP $RESPONSE"
          #   exit 1
          # fi

          echo "‚úÖ Health check passed (placeholder)"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Railway Deployment Summary"
          echo ""
          echo "- **Environment:** ${{ inputs.environment }}"
          echo "- **Branch:** ${{ github.ref_name }}"
          echo "- **Commit:** ${{ github.sha }}"
          echo "- **Triggered by:** ${{ github.actor }}"
          echo ""
          echo "‚úÖ Deployment complete"

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment: Production

    steps:
      - name: Rollback deployment
        run: |
          echo "üîÑ Rollback triggered due to deployment failure"

          # TODO: Implement rollback logic
          # Railway supports rollback via API or dashboard

          echo "‚ö†Ô∏è  Manual rollback may be required via Railway dashboard"
