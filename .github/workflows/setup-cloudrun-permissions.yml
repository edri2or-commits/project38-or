name: Setup Cloud Run Permissions

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - enable-apis
          - grant-roles
          - full-setup

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: project38-483612
  PROJECT_NUMBER: "979429709900"
  SERVICE_ACCOUNT: claude-code-agent@project38-483612.iam.gserviceaccount.com
  WIF_PROVIDER: projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Check Current State
        if: inputs.action == 'check' || inputs.action == 'full-setup'
        run: |
          echo "## Current State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Enabled APIs" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gcloud services list --enabled --filter="name:(run OR cloudbuild OR artifactregistry OR storage)" --format="value(name)" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Could not list services"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Service Account IAM Roles" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gcloud projects get-iam-policy ${{ env.PROJECT_ID }} \
            --flatten="bindings[].members" \
            --filter="bindings.members:${{ env.SERVICE_ACCOUNT }}" \
            --format="table(bindings.role)" 2>&1 >> $GITHUB_STEP_SUMMARY || echo "Could not list IAM roles"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "### Required APIs:" >> $GITHUB_STEP_SUMMARY
          echo "- cloudbuild.googleapis.com" >> $GITHUB_STEP_SUMMARY
          echo "- run.googleapis.com" >> $GITHUB_STEP_SUMMARY
          echo "- artifactregistry.googleapis.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Roles:" >> $GITHUB_STEP_SUMMARY
          echo "- roles/run.admin" >> $GITHUB_STEP_SUMMARY
          echo "- roles/cloudbuild.builds.editor" >> $GITHUB_STEP_SUMMARY
          echo "- roles/storage.admin" >> $GITHUB_STEP_SUMMARY
          echo "- roles/iam.serviceAccountUser" >> $GITHUB_STEP_SUMMARY
          echo "- roles/cloudfunctions.admin (for Cloud Functions IAM)" >> $GITHUB_STEP_SUMMARY
          echo "- roles/secretmanager.secretAccessor (for Secret Manager mounts)" >> $GITHUB_STEP_SUMMARY

      - name: Enable APIs
        if: inputs.action == 'enable-apis' || inputs.action == 'full-setup'
        run: |
          echo "Enabling required APIs..."

          gcloud services enable cloudbuild.googleapis.com --quiet && echo "✅ Cloud Build API enabled" || echo "❌ Failed to enable Cloud Build API"
          gcloud services enable run.googleapis.com --quiet && echo "✅ Cloud Run API enabled" || echo "❌ Failed to enable Cloud Run API"
          gcloud services enable artifactregistry.googleapis.com --quiet && echo "✅ Artifact Registry API enabled" || echo "❌ Failed to enable Artifact Registry API"

      - name: Grant IAM Roles
        if: inputs.action == 'grant-roles' || inputs.action == 'full-setup'
        run: |
          echo "Granting IAM roles to service account..."

          # Cloud Run Admin
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --role="roles/run.admin" \
            --quiet && echo "✅ roles/run.admin granted" || echo "❌ Failed to grant roles/run.admin"

          # Cloud Build Editor
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --role="roles/cloudbuild.builds.editor" \
            --quiet && echo "✅ roles/cloudbuild.builds.editor granted" || echo "❌ Failed to grant roles/cloudbuild.builds.editor"

          # Storage Admin (for Cloud Build artifacts)
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --role="roles/storage.admin" \
            --quiet && echo "✅ roles/storage.admin granted" || echo "❌ Failed to grant roles/storage.admin"

          # Service Account User (to act as other SAs)
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --role="roles/iam.serviceAccountUser" \
            --quiet && echo "✅ roles/iam.serviceAccountUser granted" || echo "❌ Failed to grant roles/iam.serviceAccountUser"

          # Cloud Functions Admin (for IAM policy bindings on Cloud Functions)
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --role="roles/cloudfunctions.admin" \
            --quiet && echo "✅ roles/cloudfunctions.admin granted" || echo "❌ Failed to grant roles/cloudfunctions.admin"

          # Secret Manager Secret Accessor (for --set-secrets in Cloud Run)
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --role="roles/secretmanager.secretAccessor" \
            --quiet && echo "✅ roles/secretmanager.secretAccessor granted" || echo "❌ Failed to grant roles/secretmanager.secretAccessor"

      - name: Verify Setup
        if: inputs.action == 'full-setup'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Enabled APIs" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gcloud services list --enabled --filter="name:(run OR cloudbuild OR artifactregistry OR cloudfunctions OR secretmanager)" --format="value(name)" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Could not list services"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### IAM Roles Granted" >> $GITHUB_STEP_SUMMARY
          echo "The following roles were requested for \`${{ env.SERVICE_ACCOUNT }}\`:" >> $GITHUB_STEP_SUMMARY
          echo "- \`roles/run.admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`roles/cloudbuild.builds.editor\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`roles/storage.admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`roles/iam.serviceAccountUser\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`roles/cloudfunctions.admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`roles/secretmanager.secretAccessor\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Note: Reading IAM policy requires resourcemanager.projects.getIamPolicy permission
          # which may not be available. The grant commands above succeeded if no error was shown.
          echo "### Verification" >> $GITHUB_STEP_SUMMARY
          echo "IAM roles were granted in the previous step. If 'Grant IAM Roles' showed ✅, the setup is complete." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run \`deploy-mcp-router-cloudrun.yml\` to deploy Cloud Run with Secret Manager mounts" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`fix-mcp-router.yml\` to deploy the Cloud Function proxy" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`gcp-tunnel-health-check.yml\` to verify the setup" >> $GITHUB_STEP_SUMMARY
