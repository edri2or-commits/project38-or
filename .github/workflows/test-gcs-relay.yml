name: Test GCS MCP Relay

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: project38-483612
  WIF_PROVIDER: projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  WIF_SERVICE_ACCOUNT: claude-code-agent@project38-483612.iam.gserviceaccount.com
  BUCKET_NAME: project38-mcp-relay
  PREFIX: mcp-relay

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Test GCS Relay
        run: |
          echo "## GCS MCP Relay Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SESSION_ID="test-$(date +%s)"
          REQUEST_ID="req-$(cat /proc/sys/kernel/random/uuid | cut -c1-8)"
          RESPONSE_PATH="${{ env.PREFIX }}/responses/$SESSION_ID/$REQUEST_ID.json"
          REQUEST_PATH="${{ env.PREFIX }}/requests/$SESSION_ID/$REQUEST_ID.json"

          echo "Session: $SESSION_ID"
          echo "Request ID: $REQUEST_ID"

          # Create test request (using initialize method which we know works)
          cat > /tmp/request.json << EOFJ
          {
            "jsonrpc": "2.0",
            "id": "$REQUEST_ID",
            "method": "initialize",
            "params": {},
            "_bridge": {
              "sessionId": "$SESSION_ID",
              "requestId": "$REQUEST_ID",
              "responsePath": "$RESPONSE_PATH"
            }
          }
          EOFJ

          # Upload request
          gsutil cp /tmp/request.json "gs://${{ env.BUCKET_NAME }}/$REQUEST_PATH"
          echo "âœ… Request uploaded to gs://${{ env.BUCKET_NAME }}/$REQUEST_PATH"
          echo "- Request uploaded: \`$REQUEST_PATH\`" >> $GITHUB_STEP_SUMMARY

          # Wait for response (up to 30 seconds)
          echo "Waiting for response..."
          for i in $(seq 1 15); do
            sleep 2
            if gsutil -q stat "gs://${{ env.BUCKET_NAME }}/$RESPONSE_PATH" 2>/dev/null; then
              echo "âœ… Response received after $((i*2)) seconds!"
              echo "- **Response received** after $((i*2))s âœ…" >> $GITHUB_STEP_SUMMARY

              # Download and display response
              RESPONSE=$(gsutil cat "gs://${{ env.BUCKET_NAME }}/$RESPONSE_PATH")
              echo "$RESPONSE"
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              echo "$RESPONSE" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

              # Verify it's valid JSON-RPC response
              if echo "$RESPONSE" | jq -e '.result.protocolVersion' > /dev/null 2>&1; then
                echo "âœ… Valid MCP initialize response!"
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**GCS MCP Relay is working!** ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
              fi

              # Clean up
              gsutil rm "gs://${{ env.BUCKET_NAME }}/$RESPONSE_PATH" || true
              exit 0
            fi
            echo "  [$i/15] Waiting..."
          done

          echo "âŒ No response after 30 seconds"
          echo "- **No response** after 30s âŒ" >> $GITHUB_STEP_SUMMARY
          
          # Clean up request
          gsutil rm "gs://${{ env.BUCKET_NAME }}/$REQUEST_PATH" 2>/dev/null || true
          exit 1
