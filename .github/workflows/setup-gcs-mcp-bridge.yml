name: Setup GCS MCP Bridge

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'full-setup'
        type: choice
        options:
          - full-setup
          - create-bucket
          - create-service-account
          - deploy-server
          - generate-config
          - check-status

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: project38-483612
  PROJECT_NUMBER: '979429709900'
  REGION: us-central1
  BUCKET_NAME: project38-mcp-relay
  SA_NAME: mcp-bridge-sa
  WIF_PROVIDER: projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  WIF_SERVICE_ACCOUNT: claude-code-agent@project38-483612.iam.gserviceaccount.com

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # ========== CREATE BUCKET ==========
      - name: Create GCS Bucket
        if: inputs.action == 'full-setup' || inputs.action == 'create-bucket'
        run: |
          echo "Creating GCS bucket: ${{ env.BUCKET_NAME }}"

          # Check if bucket exists
          if gsutil ls -b gs://${{ env.BUCKET_NAME }} 2>/dev/null; then
            echo "✅ Bucket already exists"
          else
            # Create bucket
            gsutil mb -p ${{ env.PROJECT_ID }} -l ${{ env.REGION }} gs://${{ env.BUCKET_NAME }}
            echo "✅ Bucket created"
          fi

          # Set lifecycle policy (delete objects after 1 day)
          cat > /tmp/lifecycle.json << 'EOF'
          {
            "rule": [
              {
                "action": {"type": "Delete"},
                "condition": {"age": 1, "matchesPrefix": ["mcp-relay/"]}
              }
            ]
          }
          EOF
          gsutil lifecycle set /tmp/lifecycle.json gs://${{ env.BUCKET_NAME }}
          echo "✅ Lifecycle policy set"

      # ========== GRANT PERMISSIONS TO EXISTING SA ==========
      - name: Grant Storage Permissions
        if: inputs.action == 'full-setup' || inputs.action == 'create-service-account'
        run: |
          # Use the existing claude-code-agent service account
          SA_EMAIL="${{ env.WIF_SERVICE_ACCOUNT }}"
          echo "Granting storage permissions to: $SA_EMAIL"

          # Grant Storage permissions on the bucket
          gsutil iam ch serviceAccount:$SA_EMAIL:objectAdmin gs://${{ env.BUCKET_NAME }}
          echo "✅ Storage permissions granted to existing service account"

          # The WIF authentication already provides credentials, no need to create keys

      # ========== CONFIGURE RAILWAY MCP GATEWAY ==========
      - name: Configure Railway MCP Gateway
        if: inputs.action == 'full-setup' || inputs.action == 'deploy-server'
        run: |
          echo "Configuring existing Railway MCP Gateway to use GCS..."
          echo "✅ The existing MCP Gateway at or-infra.com will be used"
          echo ""
          echo "The GCS Bridge server runs on Railway and polls the bucket."
          echo "Configuration:"
          echo "  GCS_BUCKET=${{ env.BUCKET_NAME }}"
          echo "  MCP_URL=http://localhost:8080/mcp"

      # ========== GENERATE CONFIG ==========
      - name: Generate Claude Code Configuration
        if: inputs.action == 'full-setup' || inputs.action == 'generate-config'
        run: |
          echo "## ✅ GCS MCP Bridge Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **Bucket**: \`gs://${{ env.BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: \`${{ env.REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Account**: \`${{ env.WIF_SERVICE_ACCOUNT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "Claude Code <--stdio--> GCS Bridge <--GCS--> Server <--http--> MCP Gateway" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next: Deploy Server to Railway" >> $GITHUB_STEP_SUMMARY
          echo "The GCS Bridge Server needs to be deployed to Railway to poll the bucket." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Set these environment variables on Railway:" >> $GITHUB_STEP_SUMMARY
          echo "- \`GCS_BUCKET=${{ env.BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`MCP_URL=http://localhost:8080/mcp\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`GOOGLE_APPLICATION_CREDENTIALS_JSON=<service account key>\`" >> $GITHUB_STEP_SUMMARY

      # ========== CHECK STATUS ==========
      - name: Check Status
        if: inputs.action == 'check-status'
        run: |
          echo "## GCS MCP Bridge Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check bucket
          if gsutil ls -b gs://${{ env.BUCKET_NAME }} 2>/dev/null; then
            echo "- ✅ Bucket \`${{ env.BUCKET_NAME }}\` exists" >> $GITHUB_STEP_SUMMARY

            # Check bucket permissions
            PERMS=$(gsutil iam get gs://${{ env.BUCKET_NAME }} 2>/dev/null | grep -c "${{ env.WIF_SERVICE_ACCOUNT }}" || echo "0")
            if [ "$PERMS" -gt 0 ]; then
              echo "- ✅ Service account has bucket permissions" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⚠️ Service account may not have bucket permissions" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ❌ Bucket \`${{ env.BUCKET_NAME }}\` does not exist" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Connectivity" >> $GITHUB_STEP_SUMMARY
          echo "To test, upload a file:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "echo 'test' | gsutil cp - gs://${{ env.BUCKET_NAME }}/mcp-relay/test.txt" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
