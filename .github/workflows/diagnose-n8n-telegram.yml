name: Diagnose n8n Telegram

on:
  workflow_dispatch:
    inputs:
      update_webhook:
        description: 'Update webhook to FastAPI bot (for AI responses)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read
  id-token: write
  issues: write

env:
  N8N_URL: "https://n8n-production-2fe0.up.railway.app"

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Secrets
        id: secrets
        run: |
          N8N_API_KEY=$(gcloud secrets versions access latest --secret="N8N-API" --project=project38-483612)
          TELEGRAM_BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "n8n_api_key=$N8N_API_KEY" >> $GITHUB_OUTPUT
          echo "telegram_token=$TELEGRAM_BOT_TOKEN" >> $GITHUB_OUTPUT

      - name: Check Telegram Webhook Info
        id: telegram-webhook
        continue-on-error: true
        env:
          TELEGRAM_TOKEN: ${{ steps.secrets.outputs.telegram_token }}
        run: |
          set +e
          echo "=== Telegram Webhook Info ==="
          RESPONSE=$(curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getWebhookInfo" 2>&1)
          echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

          WEBHOOK_URL=$(echo "$RESPONSE" | jq -r '.result.url' 2>/dev/null || echo "unknown")
          PENDING=$(echo "$RESPONSE" | jq -r '.result.pending_update_count' 2>/dev/null || echo "0")
          LAST_ERROR=$(echo "$RESPONSE" | jq -r '.result.last_error_message // "none"' 2>/dev/null || echo "unknown")

          echo "telegram_webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "telegram_pending=$PENDING" >> $GITHUB_OUTPUT
          echo "telegram_last_error=$LAST_ERROR" >> $GITHUB_OUTPUT
          exit 0

      - name: Update Webhook to FastAPI Bot
        id: update-webhook
        if: inputs.update_webhook == 'true'
        env:
          TELEGRAM_TOKEN: ${{ steps.secrets.outputs.telegram_token }}
        run: |
          set +e
          FASTAPI_URL="https://telegram-bot-production-053d.up.railway.app/webhook"

          echo "=== Updating Telegram Webhook to FastAPI Bot ==="
          echo "Target URL: $FASTAPI_URL"
          echo ""

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/setWebhook" \
            -d "url=$FASTAPI_URL" \
            -d "max_connections=40" \
            -d "drop_pending_updates=false")

          echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

          SUCCESS=$(echo "$RESPONSE" | jq -r '.ok' 2>/dev/null || echo "false")

          if [ "$SUCCESS" = "true" ]; then
            echo ""
            echo "âœ… Webhook updated to FastAPI bot!"
            echo ""
            echo "Verifying..."
            VERIFY=$(curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getWebhookInfo")
            NEW_URL=$(echo "$VERIFY" | jq -r '.result.url')
            echo "New webhook URL: $NEW_URL"
            echo "webhook_updated=true" >> $GITHUB_OUTPUT
            echo "new_webhook_url=$NEW_URL" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ Failed to update webhook"
            echo "webhook_updated=false" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Check n8n Health
        id: n8n-health
        continue-on-error: true
        run: |
          set +e
          echo "=== n8n Health ==="
          RESPONSE=$(curl -s -w "\n%{http_code}" "$N8N_URL/healthz" 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "HTTP: $HTTP_CODE"
          echo "Response: $BODY"
          echo "n8n_health_http=$HTTP_CODE" >> $GITHUB_OUTPUT
          exit 0

      - name: List n8n Workflows
        id: list-workflows
        continue-on-error: true
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          set +e
          echo "=== n8n Workflows ==="
          echo "API Key length: ${#N8N_API_KEY}"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_URL/api/v1/workflows" 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response (first 500 chars): $(echo "$BODY" | head -c 500)"

          # Save to output
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [[ "$HTTP_CODE" == "200" ]]; then
            WORKFLOW_COUNT=$(echo "$BODY" | jq '.data | length' 2>/dev/null || echo '0')
            echo ""
            echo "Total workflows: $WORKFLOW_COUNT"
            echo "workflow_count=$WORKFLOW_COUNT" >> $GITHUB_OUTPUT
            echo ""
            echo "Workflows:"
            echo "$BODY" | jq -r '.data[]? | "  - \(.name) (ID: \(.id), Active: \(.active))"' 2>/dev/null || echo "Could not parse workflows"
          else
            echo "âš ï¸ n8n API returned HTTP $HTTP_CODE"
            echo "workflow_count=error" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Check for Telegram Webhook Bot Workflow
        id: check-telegram-workflow
        continue-on-error: true
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          set +e
          echo "=== Looking for 'Telegram Webhook Bot' workflow ==="
          RESPONSE=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_URL/api/v1/workflows" 2>&1)

          # Get first matching workflow (handle case of multiple workflows)
          WF_ID=$(echo "$RESPONSE" | jq -r '[.data[] | select(.name == "Telegram Webhook Bot")][0].id // empty' 2>/dev/null)
          ACTIVE=$(echo "$RESPONSE" | jq -r '[.data[] | select(.name == "Telegram Webhook Bot")][0].active // empty' 2>/dev/null)

          echo "Found workflow ID: $WF_ID"
          echo "Workflow active: $ACTIVE"

          if [[ -n "$WF_ID" && "$WF_ID" != "null" ]]; then
            echo "âœ… Found 'Telegram Webhook Bot' workflow"

            # Get full workflow details
            echo ""
            echo "Getting full workflow details..."
            WORKFLOW_DETAILS=$(curl -s \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              "$N8N_URL/api/v1/workflows/$WF_ID" 2>&1)

            echo "Workflow nodes:"
            echo "$WORKFLOW_DETAILS" | jq '.nodes[]? | {name: .name, type: .type, parameters: .parameters}' 2>/dev/null || echo "Could not parse nodes"

            # Check if webhook path is correct
            WEBHOOK_PATH=$(echo "$WORKFLOW_DETAILS" | jq -r '.nodes[]? | select(.type == "n8n-nodes-base.webhook") | .parameters.path // empty' 2>/dev/null)
            echo "Webhook path in workflow: $WEBHOOK_PATH"
            echo "workflow_webhook_path=$WEBHOOK_PATH" >> $GITHUB_OUTPUT

            echo "workflow_found=true" >> $GITHUB_OUTPUT
            echo "workflow_id=$WF_ID" >> $GITHUB_OUTPUT
            echo "workflow_active=$ACTIVE" >> $GITHUB_OUTPUT

            if [[ "$ACTIVE" != "true" ]]; then
              echo ""
              echo "âš ï¸ WORKFLOW IS NOT ACTIVE! Attempting to activate..."

              # Try to activate using POST to /activate endpoint
              echo "Trying POST /api/v1/workflows/$WF_ID/activate"
              ACTIVATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                "$N8N_URL/api/v1/workflows/$WF_ID/activate" 2>&1)

              ACTIVATE_HTTP=$(echo "$ACTIVATE_RESPONSE" | tail -1)
              ACTIVATE_BODY=$(echo "$ACTIVATE_RESPONSE" | head -n -1)

              echo "Activate HTTP: $ACTIVATE_HTTP"
              echo "Activate response: $ACTIVATE_BODY"

              if [[ "$ACTIVATE_HTTP" == "200" ]]; then
                echo "âœ… Workflow activated successfully!"
                echo "workflow_active=true" >> $GITHUB_OUTPUT
              else
                echo "Trying alternative: PATCH to update workflow"
                # Alternative: try PATCH to update workflow
                PATCH_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
                  -H "X-N8N-API-KEY: $N8N_API_KEY" \
                  -H "Content-Type: application/json" \
                  "$N8N_URL/api/v1/workflows/$WF_ID" \
                  -d '{"active":true}' 2>&1)

                PATCH_HTTP=$(echo "$PATCH_RESPONSE" | tail -1)
                PATCH_BODY=$(echo "$PATCH_RESPONSE" | head -n -1)

                echo "PATCH HTTP: $PATCH_HTTP"
                echo "PATCH response: $PATCH_BODY"

                if [[ "$PATCH_HTTP" == "200" ]]; then
                  echo "âœ… Workflow activated via PATCH!"
                  echo "workflow_active=true" >> $GITHUB_OUTPUT
                else
                  echo "âŒ Failed to activate workflow via both methods"
                fi
              fi
            else
              echo "Workflow is already active, but let's toggle it to force webhook re-registration..."

              # Deactivate
              echo "Deactivating workflow..."
              DEACTIVATE=$(curl -s -X PATCH \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                "$N8N_URL/api/v1/workflows/$WF_ID" \
                -d '{"active":false}' 2>&1)
              echo "Deactivate response: $DEACTIVATE"

              # Wait a moment
              sleep 2

              # Reactivate
              echo "Reactivating workflow..."
              REACTIVATE=$(curl -s -X PATCH \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                "$N8N_URL/api/v1/workflows/$WF_ID" \
                -d '{"active":true}' 2>&1)
              echo "Reactivate response: $REACTIVATE"

              echo "âœ… Workflow toggled to force webhook re-registration"
            fi
          else
            echo "âŒ Workflow 'Telegram Webhook Bot' NOT FOUND!"
            echo "This is why the bot doesn't respond!"
            echo "workflow_found=false" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Check Recent Executions
        id: executions
        continue-on-error: true
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          set +e
          echo "=== Recent Executions ==="
          RESPONSE=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_URL/api/v1/executions?limit=10" 2>&1)

          echo "Response: $(echo "$RESPONSE" | head -c 500)"
          echo ""
          echo "Recent executions:"
          EXECS=$(echo "$RESPONSE" | jq -r '.data[]? | "  - \(.workflowName // "unknown") (\(.status)) at \(.startedAt)"' 2>/dev/null)
          if [[ -n "$EXECS" ]]; then
            echo "$EXECS"
            echo "executions_found=true" >> $GITHUB_OUTPUT
          else
            echo "No executions found or API error"
            echo "executions_found=false" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Try Creating Workflow via API
        id: create-workflow
        continue-on-error: true
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
          WORKFLOW_FOUND: ${{ steps.check-telegram-workflow.outputs.workflow_found }}
          EXISTING_WORKFLOW_ID: ${{ steps.check-telegram-workflow.outputs.workflow_id }}
        run: |
          set +e
          echo "=== Attempting to Create Workflow via API ==="

          # If workflow exists but webhooks don't work, delete and recreate
          if [[ "$WORKFLOW_FOUND" == "true" ]]; then
            echo "Workflow exists but webhooks return 404. Deleting and recreating..."

            # Delete the existing workflow
            echo "Deleting workflow $EXISTING_WORKFLOW_ID..."
            DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              "$N8N_URL/api/v1/workflows/$EXISTING_WORKFLOW_ID" 2>&1)

            DELETE_HTTP=$(echo "$DELETE_RESPONSE" | tail -1)
            echo "Delete HTTP: $DELETE_HTTP"

            if [[ "$DELETE_HTTP" != "200" && "$DELETE_HTTP" != "204" ]]; then
              echo "Warning: Delete returned $DELETE_HTTP, continuing anyway..."
            fi

            # Wait a moment
            sleep 3

            echo "Creating fresh workflow..."
          fi

          # Generate unique node ID
          NODE_ID=$(cat /proc/sys/kernel/random/uuid)

          # Create minimal workflow JSON using printf to avoid YAML parsing issues
          # Note: "active" field is read-only and must not be included
          # Using typeVersion 1.1 and adding webhookId for proper registration
          WEBHOOK_ID=$(cat /proc/sys/kernel/random/uuid)
          printf '{"name":"Telegram Webhook Bot","nodes":[{"id":"%s","parameters":{"httpMethod":"POST","path":"telegram-bot","responseMode":"onReceived","options":{}},"name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[250,300],"webhookId":"%s"}],"connections":{},"settings":{"executionOrder":"v1"}}' "$NODE_ID" "$WEBHOOK_ID" > /tmp/workflow.json

          echo "Workflow JSON to send:"
          cat /tmp/workflow.json
          echo ""

          echo "Sending POST to $N8N_URL/api/v1/workflows"
          echo "API Key length: ${#N8N_API_KEY}"
          echo ""

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "Content-Type: application/json" \
            "$N8N_URL/api/v1/workflows" \
            -d @/tmp/workflow.json 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Code: $HTTP_CODE"
          echo "Full Response Body:"
          echo "$BODY"

          echo "create_http=$HTTP_CODE" >> $GITHUB_OUTPUT

          # Capture error message for display
          ERROR_MSG=$(echo "$BODY" | jq -r '.message // .error // "unknown"' 2>/dev/null || echo "$BODY" | head -c 200)
          echo "create_error=$ERROR_MSG" >> $GITHUB_OUTPUT

          if [[ "$HTTP_CODE" == "200" || "$HTTP_CODE" == "201" ]]; then
            WORKFLOW_ID=$(echo "$BODY" | jq -r '.id' 2>/dev/null)
            echo ""
            echo "âœ… Workflow created! ID: $WORKFLOW_ID"
            echo "created_workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT

            # Activate it using POST /activate endpoint (more reliable for webhook registration)
            echo "Activating workflow using POST /activate..."
            ACTIVATE1=$(curl -s -w "\n%{http_code}" -X POST \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              "$N8N_URL/api/v1/workflows/$WORKFLOW_ID/activate" 2>&1)
            ACTIVATE1_HTTP=$(echo "$ACTIVATE1" | tail -1)
            ACTIVATE1_BODY=$(echo "$ACTIVATE1" | head -n -1)
            echo "POST /activate HTTP: $ACTIVATE1_HTTP"
            echo "POST /activate response: $ACTIVATE1_BODY"

            # If POST fails, try PATCH as fallback
            if [[ "$ACTIVATE1_HTTP" != "200" ]]; then
              echo "POST /activate failed, trying PATCH..."
              ACTIVATE2=$(curl -s -X PATCH \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                "$N8N_URL/api/v1/workflows/$WORKFLOW_ID" \
                -d '{"active": true}')
              echo "PATCH response: $ACTIVATE2"
            fi

            # Wait for webhook to be registered
            echo "Waiting 5 seconds for webhook registration..."
            sleep 5

            # Test webhook immediately after activation
            echo "Testing webhook immediately after activation..."
            TEST_AFTER=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              "$N8N_URL/webhook/telegram-bot" -d '{"test":"after_activation"}' 2>&1)
            TEST_AFTER_HTTP=$(echo "$TEST_AFTER" | tail -1)
            echo "Immediate test HTTP: $TEST_AFTER_HTTP"
          else
            echo ""
            echo "âŒ Failed to create workflow: $ERROR_MSG"
            echo "created_workflow_id=" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Test Webhook Endpoint Directly
        id: webhook-test
        continue-on-error: true
        env:
          WORKFLOW_ID: ${{ steps.check-telegram-workflow.outputs.workflow_id }}
        run: |
          set +e
          echo "=== Testing Multiple Webhook URLs ==="

          # Try standard production webhook URL
          echo "1. Testing $N8N_URL/webhook/telegram-bot"
          R1=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" "$N8N_URL/webhook/telegram-bot" -d '{"test":1}' 2>&1)
          H1=$(echo "$R1" | tail -1)
          echo "   HTTP: $H1"

          # Try test webhook URL
          echo "2. Testing $N8N_URL/webhook-test/telegram-bot"
          R2=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" "$N8N_URL/webhook-test/telegram-bot" -d '{"test":2}' 2>&1)
          H2=$(echo "$R2" | tail -1)
          echo "   HTTP: $H2"

          # Try with workflow ID prefix
          echo "3. Testing $N8N_URL/webhook/$WORKFLOW_ID/telegram-bot"
          R3=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" "$N8N_URL/webhook/$WORKFLOW_ID/telegram-bot" -d '{"test":3}' 2>&1)
          H3=$(echo "$R3" | tail -1)
          echo "   HTTP: $H3"

          # Try just the workflow ID as path
          echo "4. Testing $N8N_URL/webhook/$WORKFLOW_ID"
          R4=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" "$N8N_URL/webhook/$WORKFLOW_ID" -d '{"test":4}' 2>&1)
          H4=$(echo "$R4" | tail -1)
          echo "   HTTP: $H4"

          # Try root webhook path to see response format
          echo "5. Testing $N8N_URL/webhook/ (root)"
          R5=$(curl -s -w "\n%{http_code}" "$N8N_URL/webhook/" 2>&1)
          H5=$(echo "$R5" | tail -1)
          B5=$(echo "$R5" | head -n -1 | head -c 200)
          echo "   HTTP: $H5"
          echo "   Body: $B5"

          # Check n8n UI/root to confirm it's responding
          echo "6. Testing $N8N_URL/ (root)"
          R6=$(curl -s -w "\n%{http_code}" "$N8N_URL/" 2>&1)
          H6=$(echo "$R6" | tail -1)
          echo "   HTTP: $H6"

          # Choose the best result
          BEST_HTTP="404"
          for H in "$H1" "$H2" "$H3" "$H4"; do
            if [[ "$H" == "200" ]]; then
              BEST_HTTP="200"
              break
            fi
          done

          echo ""
          echo "Best webhook HTTP code: $BEST_HTTP"
          echo "webhook_http_code=$BEST_HTTP" >> $GITHUB_OUTPUT
          echo "webhook_urls_tested=production:$H1,test:$H2,wf_prefix:$H3,wf_only:$H4,root_webhook:$H5,root:$H6" >> $GITHUB_OUTPUT
          echo "root_webhook_body=$B5" >> $GITHUB_OUTPUT

          # Show the actual response body from the 404
          echo ""
          echo "=== Response body from /webhook/telegram-bot ==="
          R1_BODY=$(echo "$R1" | head -n -1)
          echo "$R1_BODY"
          echo "webhook_error_body<<EOF" >> $GITHUB_OUTPUT
          echo "$R1_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit 0

      - name: Post Diagnostic Results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_WEBHOOK_URL: ${{ steps.telegram-webhook.outputs.telegram_webhook_url }}
          TELEGRAM_PENDING: ${{ steps.telegram-webhook.outputs.telegram_pending }}
          TELEGRAM_LAST_ERROR: ${{ steps.telegram-webhook.outputs.telegram_last_error }}
          WEBHOOK_UPDATED: ${{ steps.update-webhook.outputs.webhook_updated }}
          NEW_WEBHOOK_URL: ${{ steps.update-webhook.outputs.new_webhook_url }}
          N8N_HEALTH_HTTP: ${{ steps.n8n-health.outputs.n8n_health_http }}
          WORKFLOW_COUNT: ${{ steps.list-workflows.outputs.workflow_count }}
          WORKFLOW_FOUND: ${{ steps.check-telegram-workflow.outputs.workflow_found }}
          WORKFLOW_ID: ${{ steps.check-telegram-workflow.outputs.workflow_id }}
          WORKFLOW_ACTIVE: ${{ steps.check-telegram-workflow.outputs.workflow_active }}
          EXECUTIONS_FOUND: ${{ steps.executions.outputs.executions_found }}
          CREATE_HTTP: ${{ steps.create-workflow.outputs.create_http }}
          CREATED_WORKFLOW_ID: ${{ steps.create-workflow.outputs.created_workflow_id }}
          CREATE_ERROR: ${{ steps.create-workflow.outputs.create_error }}
          WORKFLOW_WEBHOOK_PATH: ${{ steps.check-telegram-workflow.outputs.workflow_webhook_path }}
          WEBHOOK_HTTP: ${{ steps.webhook-test.outputs.webhook_http_code }}
          WEBHOOK_URLS_TESTED: ${{ steps.webhook-test.outputs.webhook_urls_tested }}
          WEBHOOK_ERROR_BODY: ${{ steps.webhook-test.outputs.webhook_error_body }}
          ROOT_WEBHOOK_BODY: ${{ steps.webhook-test.outputs.root_webhook_body }}
        run: |
          cat > /tmp/comment.md << 'COMMENT_EOF'
          ## ðŸ” n8n Telegram Diagnostic Results

          ### Telegram Bot
          COMMENT_EOF

          echo "| Check | Result |" >> /tmp/comment.md
          echo "|-------|--------|" >> /tmp/comment.md
          echo "| Webhook URL | \`$TELEGRAM_WEBHOOK_URL\` |" >> /tmp/comment.md
          echo "| Pending Updates | \`$TELEGRAM_PENDING\` |" >> /tmp/comment.md
          echo "| Last Error | \`$TELEGRAM_LAST_ERROR\` |" >> /tmp/comment.md

          # Show webhook update status if it was requested
          if [[ "$WEBHOOK_UPDATED" == "true" ]]; then
            echo "" >> /tmp/comment.md
            echo "### âœ… Webhook Updated to FastAPI Bot" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "**New URL**: \`$NEW_WEBHOOK_URL\`" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "The bot should now respond to messages with AI-generated responses via LiteLLM Gateway." >> /tmp/comment.md
          fi

          echo "" >> /tmp/comment.md
          echo "### n8n Status" >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "| Check | Result |" >> /tmp/comment.md
          echo "|-------|--------|" >> /tmp/comment.md
          echo "| Health HTTP | \`$N8N_HEALTH_HTTP\` |" >> /tmp/comment.md
          echo "| Total Workflows | \`$WORKFLOW_COUNT\` |" >> /tmp/comment.md
          echo "| 'Telegram Webhook Bot' Found | \`$WORKFLOW_FOUND\` |" >> /tmp/comment.md
          echo "| Workflow ID | \`$WORKFLOW_ID\` |" >> /tmp/comment.md
          echo "| Workflow Active | \`$WORKFLOW_ACTIVE\` |" >> /tmp/comment.md
          echo "| Workflow Webhook Path | \`$WORKFLOW_WEBHOOK_PATH\` |" >> /tmp/comment.md
          echo "| Recent Executions | \`$EXECUTIONS_FOUND\` |" >> /tmp/comment.md
          echo "| **API Workflow Create** | **HTTP \`$CREATE_HTTP\`** |" >> /tmp/comment.md
          echo "| **API Error** | **\`$CREATE_ERROR\`** |" >> /tmp/comment.md
          echo "| **Created Workflow ID** | **\`$CREATED_WORKFLOW_ID\`** |" >> /tmp/comment.md
          echo "| Direct Webhook Test HTTP | \`$WEBHOOK_HTTP\` |" >> /tmp/comment.md
          echo "| Webhook URLs Tested | \`$WEBHOOK_URLS_TESTED\` |" >> /tmp/comment.md

          if [[ -n "$WEBHOOK_ERROR_BODY" ]]; then
            echo "" >> /tmp/comment.md
            echo "### Webhook Response Body" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo '```' >> /tmp/comment.md
            echo "$WEBHOOK_ERROR_BODY" | head -c 500 >> /tmp/comment.md
            echo '```' >> /tmp/comment.md
          fi

          echo "" >> /tmp/comment.md
          echo "### ðŸ”´ Root Cause Analysis" >> /tmp/comment.md
          echo "" >> /tmp/comment.md

          if [[ "$TELEGRAM_WEBHOOK_URL" != *"n8n-production"* ]]; then
            echo "âŒ **Telegram webhook is NOT pointing to n8n!**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "Current URL: \`$TELEGRAM_WEBHOOK_URL\`" >> /tmp/comment.md
            echo "Expected: \`https://n8n-production-2fe0.up.railway.app/webhook/telegram-bot\`" >> /tmp/comment.md
          elif [[ "$N8N_HEALTH_HTTP" != "200" ]]; then
            echo "âŒ **n8n is not responding (HTTP $N8N_HEALTH_HTTP)!**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "The n8n service may be down or not deployed." >> /tmp/comment.md
          elif [[ "$WORKFLOW_FOUND" == "false" || -z "$WORKFLOW_FOUND" ]]; then
            echo "âŒ **The 'Telegram Webhook Bot' workflow does NOT exist in n8n!**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "This is why the bot doesn't respond - there's no workflow to handle incoming messages." >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "**Fix**: Run the 'Setup Telegram-n8n Webhook Integration' workflow with action=full-setup" >> /tmp/comment.md
          elif [[ "$WORKFLOW_ACTIVE" != "true" ]]; then
            echo "âš ï¸ **The 'Telegram Webhook Bot' workflow exists but is NOT active!**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "This is why the bot doesn't respond - the workflow needs to be activated." >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "**Fix**: Activate workflow ID \`$WORKFLOW_ID\` in n8n" >> /tmp/comment.md
          elif [[ "$WEBHOOK_HTTP" != "200" ]]; then
            echo "âš ï¸ **Webhook endpoint returned HTTP $WEBHOOK_HTTP instead of 200.**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "The workflow may have an error. Check n8n execution logs." >> /tmp/comment.md
          else
            echo "âœ… **All checks passed!**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "Configuration looks correct. If bot still doesn't respond:" >> /tmp/comment.md
            echo "1. Check n8n execution logs for errors" >> /tmp/comment.md
            echo "2. Verify the workflow is processing messages correctly" >> /tmp/comment.md
            echo "3. Check if Telegram has pending updates that need to be cleared" >> /tmp/comment.md
          fi

          echo "" >> /tmp/comment.md
          echo "---" >> /tmp/comment.md
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> /tmp/comment.md

          gh issue comment 266 --repo ${{ github.repository }} --body-file /tmp/comment.md
