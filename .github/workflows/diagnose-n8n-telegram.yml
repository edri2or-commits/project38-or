name: Diagnose n8n Telegram

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

env:
  N8N_URL: "https://n8n-production-ef6e2.up.railway.app"

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Secrets
        id: secrets
        run: |
          N8N_API_KEY=$(gcloud secrets versions access latest --secret="N8N-API" --project=project38-483612)
          TELEGRAM_BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "n8n_api_key=$N8N_API_KEY" >> $GITHUB_OUTPUT
          echo "telegram_token=$TELEGRAM_BOT_TOKEN" >> $GITHUB_OUTPUT

      - name: Check Telegram Webhook Info
        env:
          TELEGRAM_TOKEN: ${{ steps.secrets.outputs.telegram_token }}
        run: |
          echo "=== Telegram Webhook Info ==="
          curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getWebhookInfo" | jq '.'

      - name: Check n8n Health
        run: |
          echo "=== n8n Health ==="
          curl -s -w "\nHTTP: %{http_code}" "$N8N_URL/healthz"
          echo ""

      - name: List n8n Workflows
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          echo "=== n8n Workflows ==="
          RESPONSE=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_URL/api/v1/workflows")

          echo "Total workflows: $(echo "$RESPONSE" | jq '.data | length')"
          echo ""
          echo "Workflows:"
          echo "$RESPONSE" | jq -r '.data[] | "  - \(.name) (ID: \(.id), Active: \(.active))"'

      - name: Check for Telegram Webhook Bot Workflow
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          echo "=== Looking for 'Telegram Webhook Bot' workflow ==="
          RESPONSE=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_URL/api/v1/workflows")

          TELEGRAM_WF=$(echo "$RESPONSE" | jq -r '.data[] | select(.name == "Telegram Webhook Bot")')

          if [[ -n "$TELEGRAM_WF" ]]; then
            echo "âœ… Found workflow:"
            echo "$TELEGRAM_WF" | jq '.'

            WF_ID=$(echo "$TELEGRAM_WF" | jq -r '.id')
            ACTIVE=$(echo "$TELEGRAM_WF" | jq -r '.active')

            echo ""
            echo "Workflow ID: $WF_ID"
            echo "Active: $ACTIVE"

            if [[ "$ACTIVE" != "true" ]]; then
              echo ""
              echo "âš ï¸ WORKFLOW IS NOT ACTIVE!"
              echo "This is why the bot doesn't respond!"
            fi
          else
            echo "âŒ Workflow 'Telegram Webhook Bot' NOT FOUND!"
            echo "This is why the bot doesn't respond!"
          fi

      - name: Check Recent Executions
        env:
          N8N_API_KEY: ${{ steps.secrets.outputs.n8n_api_key }}
        run: |
          echo "=== Recent Executions ==="
          RESPONSE=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_URL/api/v1/executions?limit=10")

          echo "Recent executions:"
          echo "$RESPONSE" | jq -r '.data[]? | "  - \(.workflowName // "unknown") (\(.status)) at \(.startedAt)"' 2>/dev/null || echo "No executions found or API error"

      - name: Test Webhook Endpoint Directly
        run: |
          echo "=== Testing Webhook Endpoint ==="
          echo "Sending test POST to $N8N_URL/webhook/telegram-bot"

          RESPONSE=$(curl -s -w "\nHTTP: %{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            "$N8N_URL/webhook/telegram-bot" \
            -d '{"test": true}')

          echo "$RESPONSE"

      - name: Post Diagnostic Results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ” n8n Telegram Diagnostic Results" > /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "Run completed. Check workflow logs for details." >> /tmp/comment.md
          echo "" >> /tmp/comment.md
          echo "---" >> /tmp/comment.md
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> /tmp/comment.md

          gh issue comment 266 --repo ${{ github.repository }} --body-file /tmp/comment.md
