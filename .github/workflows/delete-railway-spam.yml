name: Delete Railway Spam Emails

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - count but do not delete'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  delete-spam:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-api-python-client

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Railway Spam
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          import subprocess
          import json

          # Get OAuth credentials from GCP Secret Manager
          def get_secret(name):
              result = subprocess.run(
                  ['gcloud', 'secrets', 'versions', 'access', 'latest', f'--secret={name}', '--project=project38-483612'],
                  capture_output=True, text=True
              )
              return result.stdout.strip()

          client_id = get_secret('GOOGLE-OAUTH-CLIENT-ID')
          client_secret = get_secret('GOOGLE-OAUTH-CLIENT-SECRET')
          refresh_token = get_secret('GOOGLE-OAUTH-REFRESH-TOKEN')

          # Create credentials
          creds = Credentials(
              token=None,
              refresh_token=refresh_token,
              token_uri='https://oauth2.googleapis.com/token',
              client_id=client_id,
              client_secret=client_secret,
              scopes=['https://www.googleapis.com/auth/gmail.modify', 'https://mail.google.com/']
          )

          # Build Gmail service
          service = build('gmail', 'v1', credentials=creds)

          # Search for Railway build failure emails
          query = 'from:railway.app subject:"Build failed" OR subject:"failed for delightful-cat"'
          print(f"üîç Searching for: {query}")

          dry_run = os.environ.get('DRY_RUN', 'false').lower() == 'true'

          all_messages = []
          page_token = None

          while True:
              results = service.users().messages().list(
                  userId='me',
                  q=query,
                  pageToken=page_token,
                  maxResults=500
              ).execute()

              messages = results.get('messages', [])
              all_messages.extend(messages)

              page_token = results.get('nextPageToken')
              if not page_token:
                  break

              print(f"  Found {len(all_messages)} so far...")

          print(f"\nüìß Found {len(all_messages)} Railway spam emails")

          if not all_messages:
              print("‚úÖ No spam emails to delete!")
              exit(0)

          if dry_run:
              print(f"\nüîí DRY RUN - Would delete {len(all_messages)} emails")
              # Show sample
              for msg in all_messages[:5]:
                  msg_data = service.users().messages().get(userId='me', id=msg['id'], format='metadata').execute()
                  subject = next((h['value'] for h in msg_data['payload']['headers'] if h['name'] == 'Subject'), 'No subject')
                  print(f"  - {subject[:80]}")
              if len(all_messages) > 5:
                  print(f"  ... and {len(all_messages) - 5} more")
              exit(0)

          # Move to trash in batches (uses batchModify which needs less permissions)
          print(f"\nüóëÔ∏è Moving {len(all_messages)} emails to trash...")

          batch_size = 100
          trashed = 0

          for i in range(0, len(all_messages), batch_size):
              batch = all_messages[i:i+batch_size]
              ids = [msg['id'] for msg in batch]

              try:
                  # Try batch modify to add TRASH label
                  service.users().messages().batchModify(
                      userId='me',
                      body={
                          'ids': ids,
                          'addLabelIds': ['TRASH'],
                          'removeLabelIds': ['INBOX']
                      }
                  ).execute()
                  trashed += len(batch)
              except Exception as e:
                  print(f"  Batch failed, trying one by one: {e}")
                  # Fall back to individual trash
                  for msg_id in ids:
                      try:
                          service.users().messages().trash(userId='me', id=msg_id).execute()
                          trashed += 1
                      except Exception as e2:
                          print(f"    Failed to trash {msg_id}: {e2}")

              print(f"  Trashed {trashed}/{len(all_messages)}")

          print(f"\n‚úÖ Successfully moved {trashed} Railway spam emails to trash!")
          PYTHON_SCRIPT
