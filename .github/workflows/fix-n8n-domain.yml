name: Fix n8n Domain

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  fix-domain:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Railway Token
        id: secrets
        run: |
          RAILWAY_TOKEN=$(gcloud secrets versions access latest --secret="RAILWAY-API" --project=project38-483612)
          TELEGRAM_BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "railway_token=$RAILWAY_TOKEN" >> $GITHUB_OUTPUT
          echo "telegram_token=$TELEGRAM_BOT_TOKEN" >> $GITHUB_OUTPUT

      - name: List All Services in Project
        id: list-services
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
        run: |
          PROJECT_ID="95ec21cc-9ada-41c5-8485-12f9a00e0116"

          echo "=== All Services in Project ==="
          RESPONSE=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { project(id: \"'"$PROJECT_ID"'\") { id name services { edges { node { id name } } } environments { edges { node { id name } } } } }"
            }')

          echo "Project info:"
          echo "$RESPONSE" | jq '.'

          # Find n8n service
          N8N_ID=$(echo "$RESPONSE" | jq -r '.data.project.services.edges[] | select(.node.name == "n8n") | .node.id')
          echo "n8n service ID from project: $N8N_ID"
          echo "n8n_id=$N8N_ID" >> $GITHUB_OUTPUT

          # Save all services
          echo "All services:"
          echo "$RESPONSE" | jq -r '.data.project.services.edges[].node | "  - \(.name): \(.id)"'

      - name: Get n8n Service Info
        id: service
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
          N8N_ID: ${{ steps.list-services.outputs.n8n_id }}
        run: |
          # Use dynamic service ID from project list
          SERVICE_ID="${N8N_ID:-e1373500-e475-414a-aeb5-b93826c0616c}"
          ENV_ID="99c99a18-aea2-4d01-9360-6a93705102a0"

          echo "=== Service Info ==="
          echo "Service ID: $SERVICE_ID"
          echo "Environment ID: $ENV_ID"
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT

          if [[ -z "$SERVICE_ID" || "$SERVICE_ID" == "null" ]]; then
            echo "âŒ n8n service not found in project!"
            echo "domain=SERVICE_NOT_FOUND" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get service details with more fields
          RESPONSE=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { service(id: \"'"$SERVICE_ID"'\") { id name deletedAt domains { serviceDomains { domain } customDomains { domain } } serviceInstances { edges { node { id environmentId domains { serviceDomains { domain } } } } } } }"
            }')

          echo "Service response:"
          echo "$RESPONSE" | jq '.'

          # Check if service was deleted
          DELETED=$(echo "$RESPONSE" | jq -r '.data.service.deletedAt // "null"')
          if [[ "$DELETED" != "null" ]]; then
            echo "âŒ SERVICE WAS DELETED at $DELETED"
            echo "domain=SERVICE_DELETED" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Try to get domain from service instance
          INSTANCE_DOMAIN=$(echo "$RESPONSE" | jq -r '.data.service.serviceInstances.edges[].node | select(.environmentId == "'"$ENV_ID"'") | .domains.serviceDomains[0].domain // empty')
          if [[ -n "$INSTANCE_DOMAIN" ]]; then
            echo "Found domain from service instance: $INSTANCE_DOMAIN"
            echo "domain=$INSTANCE_DOMAIN" >> $GITHUB_OUTPUT
            exit 0
          fi

          DOMAIN=$(echo "$RESPONSE" | jq -r '.data.service.domains.serviceDomains[0].domain // "none"')
          echo "Current domain: $DOMAIN"
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT

      - name: Create Domain if Missing
        id: create-domain
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
          N8N_ID: ${{ steps.list-services.outputs.n8n_id }}
        run: |
          SERVICE_ID="${N8N_ID:-e1373500-e475-414a-aeb5-b93826c0616c}"
          ENV_ID="99c99a18-aea2-4d01-9360-6a93705102a0"
          EXISTING_DOMAIN="${{ steps.service.outputs.domain }}"

          if [[ "$EXISTING_DOMAIN" != "none" && -n "$EXISTING_DOMAIN" ]]; then
            echo "âœ… Domain already exists: $EXISTING_DOMAIN"
            echo "domain=$EXISTING_DOMAIN" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Creating new domain..."
          RESPONSE=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { serviceDomainCreate(input: { serviceId: \"'"$SERVICE_ID"'\", environmentId: \"'"$ENV_ID"'\" }) { domain } }"
            }')

          echo "Create domain response:"
          echo "$RESPONSE" | jq '.'

          # Check for errors
          ERROR=$(echo "$RESPONSE" | jq -r '.errors[0].message // ""')
          if [[ -n "$ERROR" ]]; then
            echo "âŒ Error: $ERROR"
            echo "domain=error:$ERROR" >> $GITHUB_OUTPUT

            # Try alternate approach - maybe we need serviceInstanceDomainCreate
            echo ""
            echo "Trying serviceInstanceDomainCreate..."
            RESPONSE2=$(curl -s -X POST \
              "https://backboard.railway.app/graphql/v2" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "mutation { serviceInstanceDomainCreate(input: { serviceId: \"'"$SERVICE_ID"'\", environmentId: \"'"$ENV_ID"'\" }) { domain } }"
              }')
            echo "Alternate response:"
            echo "$RESPONSE2" | jq '.'

            DOMAIN2=$(echo "$RESPONSE2" | jq -r '.data.serviceInstanceDomainCreate.domain // "failed"')
            if [[ "$DOMAIN2" != "failed" && -n "$DOMAIN2" ]]; then
              echo "domain=$DOMAIN2" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          DOMAIN=$(echo "$RESPONSE" | jq -r '.data.serviceDomainCreate.domain // "failed"')
          echo "Created domain: $DOMAIN"
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT

      - name: Get Deployments
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
          N8N_ID: ${{ steps.list-services.outputs.n8n_id }}
        run: |
          SERVICE_ID="${N8N_ID:-e1373500-e475-414a-aeb5-b93826c0616c}"

          echo "=== Recent Deployments ==="
          RESPONSE=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { deployments(input: { serviceId: \"'"$SERVICE_ID"'\" }, first: 5) { edges { node { id status staticUrl createdAt } } } }"
            }')

          echo "$RESPONSE" | jq '.data.deployments.edges'

      - name: Test n8n Health
        id: test
        run: |
          DOMAIN="${{ steps.create-domain.outputs.domain }}"

          if [[ -z "$DOMAIN" || "$DOMAIN" == "none" || "$DOMAIN" == "failed" ]]; then
            echo "âŒ No domain available"
            echo "health=no_domain" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Testing https://$DOMAIN/healthz"
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://$DOMAIN/healthz" 2>&1 || echo "curl_failed")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $BODY"
          echo "health=$HTTP_CODE" >> $GITHUB_OUTPUT

      - name: Update Telegram Webhook
        id: webhook
        env:
          TELEGRAM_TOKEN: ${{ steps.secrets.outputs.telegram_token }}
        run: |
          DOMAIN="${{ steps.create-domain.outputs.domain }}"

          if [[ -z "$DOMAIN" || "$DOMAIN" == "none" || "$DOMAIN" == "failed" ]]; then
            echo "âŒ No domain to set webhook"
            exit 0
          fi

          WEBHOOK_URL="https://$DOMAIN/webhook/telegram-bot"
          echo "Setting Telegram webhook to: $WEBHOOK_URL"

          # Delete old webhook
          curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/deleteWebhook"

          # Set new webhook
          RESPONSE=$(curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/setWebhook?url=$WEBHOOK_URL")
          echo "Set webhook response: $RESPONSE"

          # Verify
          INFO=$(curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getWebhookInfo")
          echo "Webhook info: $INFO"

          CURRENT_URL=$(echo "$INFO" | jq -r '.result.url')
          echo "webhook_url=$CURRENT_URL" >> $GITHUB_OUTPUT

      - name: Post Results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOMAIN: ${{ steps.create-domain.outputs.domain }}
          HEALTH: ${{ steps.test.outputs.health }}
          WEBHOOK_URL: ${{ steps.webhook.outputs.webhook_url }}
          EXISTING_DOMAIN: ${{ steps.service.outputs.domain }}
        run: |
          cat > /tmp/comment.md << EOF
          ## ðŸ”§ n8n Domain Fix Results

          ### Status

          | Check | Result |
          |-------|--------|
          | Existing Domain | \`$EXISTING_DOMAIN\` |
          | Final Domain | \`$DOMAIN\` |
          | Health HTTP | \`$HEALTH\` |
          | Telegram Webhook | \`$WEBHOOK_URL\` |

          ### Analysis

          EOF

          if [[ "$DOMAIN" == *"error:"* ]]; then
            ERROR_MSG="${DOMAIN#error:}"
            echo "âŒ **Railway API Error:** \`$ERROR_MSG\`" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "The n8n service may be in a bad state or deleted." >> /tmp/comment.md
            echo "Try creating a new n8n service from scratch." >> /tmp/comment.md
          elif [[ "$DOMAIN" == "none" || "$DOMAIN" == "failed" || -z "$DOMAIN" ]]; then
            echo "âŒ **Failed to create/get domain**" >> /tmp/comment.md
          elif [[ "$HEALTH" != "200" ]]; then
            echo "âš ï¸ **n8n not responding (HTTP $HEALTH)**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "Domain: \`$DOMAIN\`" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "The domain exists but n8n is not responding." >> /tmp/comment.md
            echo "May need to redeploy the n8n service." >> /tmp/comment.md
          else
            echo "âœ… **n8n is working!**" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "Domain: https://$DOMAIN" >> /tmp/comment.md
            echo "" >> /tmp/comment.md
            echo "Test by sending a message to your Telegram bot." >> /tmp/comment.md
          fi

          echo "" >> /tmp/comment.md
          echo "---" >> /tmp/comment.md
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> /tmp/comment.md

          gh issue comment 266 --repo ${{ github.repository }} --body-file /tmp/comment.md
