name: GCP MCP Phase 3 - Setup and Testing

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'setup'
        options:
          - setup          # Store token and get URL
          - test-tools     # Test all 20+ tools
          - full           # Setup + Test

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612
  SERVICE_NAME: gcp-mcp-gateway
  REGION: us-central1
  BEARER_TOKEN: tLAb_sTuMguCIuRm0f5luxuvUzYYeAyDngXyIJ1NsC8

jobs:
  setup:
    if: inputs.action == 'setup' || inputs.action == 'full'
    runs-on: ubuntu-latest
    outputs:
      service_url: ${{ steps.get-url.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Store Bearer Token in Secret Manager
        run: |
          echo "ðŸ” Storing Bearer Token in GCP Secret Manager..."

          # Check if secret exists
          if gcloud secrets describe GCP-MCP-TOKEN --project=$GCP_PROJECT_ID 2>/dev/null; then
            echo "âœ… Secret GCP-MCP-TOKEN already exists"

            # Update the secret with new version
            echo -n "$BEARER_TOKEN" | gcloud secrets versions add GCP-MCP-TOKEN \
              --data-file=- \
              --project=$GCP_PROJECT_ID

            echo "âœ… Added new version to existing secret"
          else
            echo "Creating new secret GCP-MCP-TOKEN..."

            # Create new secret
            echo -n "$BEARER_TOKEN" | gcloud secrets create GCP-MCP-TOKEN \
              --data-file=- \
              --replication-policy=automatic \
              --project=$GCP_PROJECT_ID

            echo "âœ… Created new secret"
          fi

          echo ""
          echo "ðŸ“‹ Secret Details:"
          gcloud secrets describe GCP-MCP-TOKEN --project=$GCP_PROJECT_ID

      - name: Get Service URL
        id: get-url
        run: |
          echo "ðŸŒ Retrieving GCP MCP Server URL..."

          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region=$REGION \
            --project=$GCP_PROJECT_ID \
            --format='value(status.url)')

          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Service URL: $SERVICE_URL"
          echo ""

      - name: Test Health Endpoint
        run: |
          SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
            --region=$REGION \
            --project=$GCP_PROJECT_ID \
            --format='value(status.url)')

          echo "ðŸ¥ Testing health endpoint..."
          echo "URL: $SERVICE_URL/health"
          echo ""

          # Test without auth (should work for health)
          RESPONSE=$(curl -s -w "\n%{http_code}" "$SERVICE_URL/health" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health endpoint is accessible"
          else
            echo "âš ï¸ Health endpoint returned: $HTTP_CODE"
          fi

      - name: Create Summary Issue
        uses: actions/github-script@v7
        with:
          script: |
            const serviceUrl = '${{ steps.get-url.outputs.url }}';
            const body = `## âœ… GCP MCP Phase 3 Setup Complete

            **Service Details:**
            - **URL**: \`${serviceUrl}\`
            - **Region**: \`us-central1\`
            - **Project**: \`project38-483612\`

            **Bearer Token:**
            - âœ… Stored in GCP Secret Manager as \`GCP-MCP-TOKEN\`
            - Token: \`tLAb_sTuMguCIuRm0f5luxuvUzYYeAyDngXyIJ1NsC8\`

            **Next Steps:**

            ### Option A: Configure Claude Code (Local)
            \`\`\`bash
            claude mcp add --transport http \\
              --header "Authorization: Bearer tLAb_sTuMguCIuRm0f5luxuvUzYYeAyDngXyIJ1NsC8" \\
              --scope user \\
              gcp-mcp ${serviceUrl}
            \`\`\`

            ### Option B: Manual Configuration
            Edit \`~/.claude.json\`:
            \`\`\`json
            {
              "mcpServers": {
                "gcp-mcp": {
                  "type": "http",
                  "url": "${serviceUrl}",
                  "headers": {
                    "Authorization": "Bearer tLAb_sTuMguCIuRm0f5luxuvUzYYeAyDngXyIJ1NsC8"
                  }
                }
              }
            }
            \`\`\`

            ### Test Tools
            Once configured, test with these prompts:
            - "List all secrets in project38-483612"
            - "Show compute instances in us-central1"
            - "Run: gcloud projects describe project38-483612"
            - "List Cloud Storage buckets"
            - "Show IAM service accounts"

            **Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âœ… GCP MCP Phase 3 Setup Complete',
              body: body,
              labels: ['gcp-mcp', 'phase-3', 'setup']
            });

  test-tools:
    if: inputs.action == 'test-tools' || inputs.action == 'full'
    needs: [setup]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install requests

      - name: Test MCP Tools
        run: |
          SERVICE_URL="${{ needs.setup.outputs.service_url || 'https://gcp-mcp-gateway-3e7yyrd7xq-uc.a.run.app' }}"

          cat > test_gcp_mcp.py << 'EOF'
          import requests
          import json
          import sys
          import os

          SERVICE_URL = os.environ.get('SERVICE_URL')
          BEARER_TOKEN = os.environ.get('BEARER_TOKEN')

          print(f"ðŸ”§ Configuration:")
          print(f"  SERVICE_URL: {SERVICE_URL}")
          print(f"  BEARER_TOKEN: {'SET' if BEARER_TOKEN else 'NOT SET'}")
          print()

          headers = {
              'Authorization': f'Bearer {BEARER_TOKEN}',
              'Content-Type': 'application/json'
          }

          # First, try to discover available endpoints
          print("="*60)
          print("Phase 1: Endpoint Discovery")
          print("="*60)

          test_endpoints = [
              ('/', 'Root'),
              ('/health', 'Health'),
              ('/sse', 'SSE'),
              ('/mcp', 'MCP'),
              ('/mcp/sse', 'MCP SSE'),
          ]

          for endpoint, name in test_endpoints:
              url = f"{SERVICE_URL.rstrip('/')}{endpoint}"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  print(f"  {name} ({endpoint}): {resp.status_code}")
              except Exception as e:
                  print(f"  {name} ({endpoint}): Error - {str(e)[:50]}")

          print()

          def test_mcp_request(endpoint, method, params=None):
              """Test MCP JSON-RPC request at specific endpoint"""
              url = f"{SERVICE_URL.rstrip('/')}{endpoint}"
              print(f"\n  URL: {url}")
              print(f"  Method: {method}")

              payload = {
                  "jsonrpc": "2.0",
                  "id": 1,
                  "method": method,
                  "params": params or {}
              }

              try:
                  response = requests.post(
                      url,
                      headers=headers,
                      json=payload,
                      timeout=30
                  )

                  print(f"  Status: {response.status_code}")
                  print(f"  Headers: {dict(response.headers)}")

                  if response.status_code == 200:
                      try:
                          result = response.json()
                          print(f"  âœ… JSON Response: {json.dumps(result, indent=2)[:300]}...")
                          return True, result
                      except:
                          print(f"  Response (text): {response.text[:200]}")
                          return False, None
                  else:
                      print(f"  âŒ Failed: {response.text[:200]}")
                      return False, None

              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  return False, None

          # Phase 2: Try MCP protocol at different endpoints
          print("="*60)
          print("Phase 2: MCP Protocol Tests")
          print("="*60)

          mcp_endpoints = ['/', '/mcp', '/sse', '/mcp/sse']
          working_endpoint = None

          for endpoint in mcp_endpoints:
              print(f"\n--- Testing tools/list at {endpoint} ---")
              success, result = test_mcp_request(endpoint, "tools/list")
              if success and result and 'tools' in str(result).lower():
                  working_endpoint = endpoint
                  print(f"  ðŸŽ‰ Found working endpoint: {endpoint}")
                  break

          if not working_endpoint:
              print("\nâš ï¸ Could not find working MCP endpoint")
              print("Trying root endpoint for tool tests anyway...")
              working_endpoint = '/'

          # Phase 3: Test individual tools
          print()
          print("="*60)
          print("Phase 3: Tool Tests")
          print("="*60)

          # Test individual tools (using correct tool names from server.py)
          tests = [
              ("secret_list", "tools/call", {"name": "secret_list", "arguments": {}}),
              ("gcloud_run", "tools/call", {"name": "gcloud_run", "arguments": {"command": "projects describe project38-483612"}}),
              ("iam_list_accounts", "tools/call", {"name": "iam_list_accounts", "arguments": {}}),
          ]

          results = []
          for name, method, params in tests:
              print(f"\n--- Testing {name} ---")
              success, result = test_mcp_request(working_endpoint, method, params)
              results.append((name, success))

          print("\n" + "="*60)
          print("TEST SUMMARY")
          print("="*60)
          print(f"Working Endpoint: {working_endpoint}")
          print()

          for name, success in results:
              status = "âœ…" if success else "âŒ"
              print(f"{status} {name}")

          total = len(results)
          passed = sum(1 for _, s in results if s)
          print(f"\nPassed: {passed}/{total}")

          # Don't fail the workflow - we want to see the results
          # sys.exit(1) would prevent us from seeing the diagnostic output
          if passed < total:
              print("\nâš ï¸ Some tests failed - check logs for details")
              print("This may indicate the MCP endpoint structure needs adjustment")
          EOF

          export SERVICE_URL="$SERVICE_URL"
          export BEARER_TOKEN="$BEARER_TOKEN"

          python test_gcp_mcp.py

      - name: Post Test Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”¬ GCP MCP Phase 3 - Diagnostic Results',
              body: `## Diagnostic Test Results

**Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### ðŸ“‹ Test Configuration
- **Service URL**: \`https://gcp-mcp-gateway-3e7yyrd7xq-uc.a.run.app\`
- **Bearer Token**: Configured via env variable

### ðŸ” Tests Performed
1. **Endpoint Discovery** - Probing available HTTP endpoints
2. **MCP Protocol** - Testing JSON-RPC at different paths
3. **Tool Invocation** - Testing specific tools:
   - \`secret_list\` - List GCP secrets
   - \`gcloud_run\` - Execute gcloud command
   - \`iam_list_accounts\` - List service accounts

### ðŸ“Š Check the Workflow Logs
The logs contain detailed diagnostic information including:
- HTTP status codes for each endpoint
- Response headers and bodies
- Working endpoint discovery results

**Next Steps**:
1. Review the workflow logs for detailed output
2. If endpoints are not responding correctly, check Cloud Run logs
3. Update ADR-006 with findings
`,
              labels: ['gcp-mcp', 'phase-3', 'testing', 'diagnostics']
            });
