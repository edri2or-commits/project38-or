name: Setup MCP Gateway Token

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - rotate
          - deliver
      issue_number:
        description: 'Issue number to post token (for deliver action)'
        required: false
        default: ''

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  setup-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Generate and store MCP Gateway token
        if: inputs.action == 'create' || inputs.action == 'rotate'
        id: generate
        run: |
          TOKEN=$(openssl rand -hex 32)

          # Check if secret exists
          if gcloud secrets describe MCP-GATEWAY-TOKEN --project=project38-483612 2>/dev/null; then
            echo "Secret exists, adding new version..."
            echo -n "$TOKEN" | gcloud secrets versions add MCP-GATEWAY-TOKEN --data-file=- --project=project38-483612
          else
            echo "Creating new secret..."
            echo -n "$TOKEN" | gcloud secrets create MCP-GATEWAY-TOKEN --data-file=- --project=project38-483612
          fi

          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "::notice::MCP Gateway token created/rotated successfully"

      - name: Read existing token
        if: inputs.action == 'deliver'
        id: read
        run: |
          TOKEN=$(gcloud secrets versions access latest --secret=MCP-GATEWAY-TOKEN --project=project38-483612)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Post token to issue
        if: inputs.issue_number != ''
        uses: actions/github-script@v7
        env:
          TOKEN: ${{ steps.generate.outputs.token || steps.read.outputs.token }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        with:
          script: |
            const token = process.env.TOKEN;
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## MCP Gateway Token\n\n\`\`\`\n${token}\n\`\`\`\n\n**Command to run:**\n\`\`\`bash\nclaude mcp add --transport http --header "Authorization: Bearer ${token}" --scope user claude-gateway https://or-infra.com/mcp\n\`\`\`\n\n⚠️ **Delete this comment after copying the token!**`
            });

            console.log(`Token posted to issue #${issueNumber}`);

      - name: Display token (if no issue specified)
        if: inputs.issue_number == ''
        env:
          TOKEN: ${{ steps.generate.outputs.token || steps.read.outputs.token }}
        run: |
          echo "============================================"
          echo "YOUR MCP GATEWAY TOKEN:"
          echo "============================================"
          echo "$TOKEN"
          echo "============================================"
          echo ""
          echo "Run this command:"
          echo "claude mcp add --transport http --header \"Authorization: Bearer $TOKEN\" --scope user claude-gateway https://or-infra.com/mcp"

      - name: Verify secret
        run: |
          echo "Verifying secret exists..."
          gcloud secrets describe MCP-GATEWAY-TOKEN --project=project38-483612
          echo "Secret versions:"
          gcloud secrets versions list MCP-GATEWAY-TOKEN --project=project38-483612
