name: Setup GCP MCP Authentication Token

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - rotate
          - deliver
      issue_number:
        description: 'Issue number for secure token delivery (only with deliver action)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612

jobs:
  manage-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Generate or retrieve token
        id: token
        run: |
          if [ "${{ github.event.inputs.action }}" = "create" ] || [ "${{ github.event.inputs.action }}" = "rotate" ]; then
            # Generate new secure token (32 bytes = 64 hex chars)
            NEW_TOKEN=$(openssl rand -hex 32)

            # Check if secret exists
            if gcloud secrets describe GCP-MCP-TOKEN --project=$GCP_PROJECT_ID 2>/dev/null; then
              echo "‚úÖ Secret exists, adding new version"
              echo -n "$NEW_TOKEN" | gcloud secrets versions add GCP-MCP-TOKEN \
                --data-file=- \
                --project=$GCP_PROJECT_ID
            else
              echo "‚úÖ Creating new secret"
              echo -n "$NEW_TOKEN" | gcloud secrets create GCP-MCP-TOKEN \
                --data-file=- \
                --replication-policy="automatic" \
                --project=$GCP_PROJECT_ID
            fi

            echo "token_created=true" >> $GITHUB_OUTPUT
            echo "token_preview=${NEW_TOKEN:0:8}..." >> $GITHUB_OUTPUT

            # Save token securely for delivery step
            echo "$NEW_TOKEN" > /tmp/token.txt
          fi

      - name: Deliver token to issue
        if: github.event.inputs.action == 'deliver' && github.event.inputs.issue_number != ''
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
        with:
          script: |
            const fs = require('fs');

            // Read token from GCP Secret Manager
            const { execSync } = require('child_process');
            const token = execSync(
              `gcloud secrets versions access latest --secret=GCP-MCP-TOKEN --project=${process.env.GCP_PROJECT_ID}`,
              { encoding: 'utf-8' }
            ).trim();

            const preview = token.substring(0, 8) + '...' + token.substring(token.length - 8);

            const body = `## üîê GCP MCP Authentication Token

**Status:** Ready for configuration

**Token Preview:** \`${preview}\`

**Full Token (will be deleted after 24 hours):**

<details>
<summary>Click to reveal token (COPY THIS NOW)</summary>

\`\`\`
${token}
\`\`\`

</details>

### Configuration Instructions

**For local Claude Code:**

1. Copy the token above
2. Run:
   \`\`\`bash
   claude mcp add --transport http \\
     --header "Authorization: Bearer <TOKEN>" \\
     --scope user \\
     gcp-mcp https://gcp-mcp-gateway-3e7yyrd7xq-uc.a.run.app/mcp
   \`\`\`

**For manual configuration (~/.claude.json):**

\`\`\`json
{
  "mcpServers": {
    "gcp-mcp": {
      "type": "http",
      "url": "https://gcp-mcp-gateway-3e7yyrd7xq-uc.a.run.app/mcp",
      "headers": {
        "Authorization": "Bearer ${token}"
      }
    }
  }
}
\`\`\`

**Security Notes:**
- This token grants full access to GCP MCP tools
- Store it securely (1Password, etc.)
- Don't commit it to code
- Rotate periodically using this workflow

---
*This comment will be deleted after 24 hours for security.*
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              body: body
            });

            console.log(`‚úÖ Token delivered to issue #${process.env.ISSUE_NUMBER}`);

      - name: Report success
        if: github.event.inputs.action == 'create' || github.event.inputs.action == 'rotate'
        run: |
          echo "‚úÖ Token ${{ github.event.inputs.action }} completed successfully"
          echo "Token preview: ${{ steps.token.outputs.token_preview }}"
          echo ""
          echo "To deliver this token to an issue, run:"
          echo "  gh workflow run setup-gcp-mcp-token.yml -f action=deliver -f issue_number=<NUMBER>"
