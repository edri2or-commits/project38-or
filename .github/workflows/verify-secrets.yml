name: Verify Secret Access

on:
  workflow_dispatch:  # ×”×¨×¦×” ×™×“× ×™×ª ×‘×œ×‘×“ - ××™×Ÿ trigger ×¢×œ push

# Minimal permissions - principle of least privilege
permissions:
  contents: read
  id-token: write  # Required for OIDC authentication with WIF

# Prevent concurrent runs
concurrency:
  group: verify-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Secret Manager Access
        run: |
          echo "ğŸ” Verifying Secret Manager access..."
          python src/secrets_manager.py

      - name: Test Secret Manager Module
        run: |
          python << 'EOF'
          import sys
          sys.path.insert(0, 'src')

          from secrets_manager import SecretManager

          print("\nğŸ§ª Testing Secret Manager Module")
          print("=" * 50)

          manager = SecretManager()

          # List available secrets
          secrets = manager.list_secrets()
          print(f"\nâœ… Found {len(secrets)} secret(s)")

          # Verify access without exposing values
          accessible_count = 0
          for secret in secrets:
              if manager.verify_access(secret):
                  accessible_count += 1

          print(f"âœ… Can access {accessible_count} secret(s)")

          if accessible_count > 0:
              print("\nâœ¨ Secret Manager is fully operational!")
              print("   All secrets are accessible but remain secure (not exposed)")
          else:
              print("\nâš ï¸  No secrets are accessible")
              print("   Check service account permissions")
              sys.exit(1)
          EOF

      - name: Summary
        run: |
          echo "âœ… Secret Manager verification complete"
          echo "ğŸ”’ All secrets remain secure (never exposed in logs)"
          echo "ğŸš€ System ready for autonomous secret access"
