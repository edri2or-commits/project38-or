name: Update Webhook Now

on:
  push:
    branches:
      - update-webhook-direct

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          project_id: project38-483612
          workload_identity_provider: projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: claude-code-agent@project38-483612.iam.gserviceaccount.com
          token_format: access_token

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Bot Token
        id: token
        run: |
          BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "::add-mask::$BOT_TOKEN"
          echo "bot_token=$BOT_TOKEN" >> $GITHUB_OUTPUT

      - name: Update Webhook
        id: update
        env:
          BOT_TOKEN: ${{ steps.token.outputs.bot_token }}
        run: |
          RAILWAY_URL="https://telegram-bot-production-053d.up.railway.app/webhook"

          echo "Updating webhook to: $RAILWAY_URL"

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook" \
            -d "url=$RAILWAY_URL" \
            -d "max_connections=40")

          echo "$RESPONSE"

          SUCCESS=$(echo "$RESPONSE" | jq -r '.ok')

          if [ "$SUCCESS" = "true" ]; then
            echo "✅ Webhook updated"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Update failed"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo ""
          echo "Verifying..."
          VERIFY=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo")
          echo "$VERIFY" | jq '.'

          NEW_URL=$(echo "$VERIFY" | jq -r '.result.url')
          echo "new_url=$NEW_URL" >> $GITHUB_OUTPUT

      - name: Post to Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.update.outputs.success }}' === 'true';
            const newUrl = '${{ steps.update.outputs.new_url }}';

            const body = success ? `## ✅ Webhook Updated to Railway

**New URL**: \`${newUrl}\`

Test the bot now in Telegram:
- Send: \`/start\`
- Send: \`Hello!\`

The bot should respond with Claude/GPT-4/Gemini, not n8n templates.` : `## ❌ Webhook Update Failed

Check workflow logs for details:
${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 242,
              body: body
            });
