name: GCP Secret Manager Access

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: false
        type: choice
        default: 'list-secrets'
        options:
          - list-secrets
          - exchange-oauth-code
          - deploy-gcp-mcp
          - generate-token
      auth_code:
        description: 'OAuth authorization code (for exchange-oauth-code)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write
  issues: write

concurrency:
  group: gcp-secret-manager-${{ github.ref }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: project38-483612

jobs:
  access-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: List Secret Manager Secrets
        if: inputs.action == 'list-secrets' || inputs.action == ''
        run: |
          echo "ðŸ” Available secrets in Secret Manager:"
          gcloud secrets list --format="table(name,created)" --project=$GCP_PROJECT_ID

      - name: Exchange OAuth Code for Refresh Token
        if: inputs.action == 'exchange-oauth-code'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ”„ Exchanging OAuth code for refresh token..."
          
          if [ -z "${{ inputs.auth_code }}" ]; then
            echo "âŒ Authorization code is required!"
            exit 1
          fi
          
          # Get credentials from Secret Manager
          CLIENT_ID=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-ID --project=$GCP_PROJECT_ID)
          CLIENT_SECRET=$(gcloud secrets versions access latest --secret=GOOGLE-OAUTH-CLIENT-SECRET --project=$GCP_PROJECT_ID)
          
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
            echo "âŒ OAuth credentials not found in Secret Manager!"
            echo "Please ensure GOOGLE-OAUTH-CLIENT-ID and GOOGLE-OAUTH-CLIENT-SECRET exist."
            exit 1
          fi
          
          echo "âœ… Got credentials from Secret Manager"
          
          # Exchange code for tokens
          RESPONSE=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "code=${{ inputs.auth_code }}" \
            -d "grant_type=authorization_code" \
            -d "redirect_uri=urn:ietf:wg:oauth:2.0:oob")
          
          # Check for errors
          if echo "$RESPONSE" | grep -q "error"; then
            echo "âŒ Token exchange failed!"
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error_description // .error')
            echo "Error: $ERROR_MSG"
            
            # Report to issue #149
            gh issue comment 149 --body "## OAuth Exchange Error
            
**Error:** $ERROR_MSG

**Timestamp:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')" --repo edri2or-commits/project38-or || true
            exit 1
          fi
          
          # Extract refresh token
          REFRESH_TOKEN=$(echo "$RESPONSE" | jq -r '.refresh_token')
          
          if [ -z "$REFRESH_TOKEN" ] || [ "$REFRESH_TOKEN" = "null" ]; then
            echo "âŒ No refresh token in response!"
            exit 1
          fi
          
          # Store refresh token
          echo "Storing refresh token in Secret Manager..."
          if ! gcloud secrets describe GOOGLE-OAUTH-REFRESH-TOKEN --project=$GCP_PROJECT_ID 2>/dev/null; then
            gcloud secrets create GOOGLE-OAUTH-REFRESH-TOKEN --project=$GCP_PROJECT_ID --replication-policy=automatic
          fi
          echo -n "$REFRESH_TOKEN" | gcloud secrets versions add GOOGLE-OAUTH-REFRESH-TOKEN --data-file=- --project=$GCP_PROJECT_ID
          
          echo ""
          echo "âœ… SUCCESS! OAuth setup complete!"
          echo "Refresh token stored in GOOGLE-OAUTH-REFRESH-TOKEN"
          
          # Report success
          gh issue comment 149 --body "## âœ… OAuth Exchange Success

Refresh token has been stored in GCP Secret Manager.

**Timestamp:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')" --repo edri2or-commits/project38-or || true

      - name: Deploy GCP MCP Server
        if: inputs.action == 'deploy-gcp-mcp'
        run: |
          echo "ðŸš€ Deploying GCP MCP Server to Cloud Run..."

          cd src/gcp_mcp

          # Configure Docker for Artifact Registry
          gcloud auth configure-docker us-central1-docker.pkg.dev

          # Build image
          echo "ðŸ—ï¸ Building Docker image..."
          docker build -t us-central1-docker.pkg.dev/$GCP_PROJECT_ID/cloud-run-source-deploy/gcp-mcp-gateway:latest .

          # Push image
          echo "ðŸ“¤ Pushing to Artifact Registry..."
          docker push us-central1-docker.pkg.dev/$GCP_PROJECT_ID/cloud-run-source-deploy/gcp-mcp-gateway:latest

          # Deploy to Cloud Run
          echo "â˜ï¸ Deploying to Cloud Run..."
          gcloud run deploy gcp-mcp-gateway \
            --image us-central1-docker.pkg.dev/$GCP_PROJECT_ID/cloud-run-source-deploy/gcp-mcp-gateway:latest \
            --region us-central1 \
            --platform managed \
            --service-account claude-code-agent@$GCP_PROJECT_ID.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --set-env-vars="GCP_PROJECT_ID=$GCP_PROJECT_ID" \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --timeout 300s

          # Get service URL
          URL=$(gcloud run services describe gcp-mcp-gateway --region us-central1 --format='value(status.url)')

          echo ""
          echo "âœ… Deployment complete!"
          echo "ðŸŒ Service URL: $URL"
          echo ""
          echo "Next steps:"
          echo "1. Generate auth token: gh workflow run gcp-secret-manager.yml -f action=generate-token"
          echo "2. Configure Claude Code MCP client"

      - name: Generate MCP Gateway Token
        if: inputs.action == 'generate-token'
        run: |
          echo "ðŸ” Generating GCP MCP Gateway authentication token..."

          # Generate secure token
          TOKEN=$(openssl rand -hex 32)

          echo "Token generated (length: ${#TOKEN} characters)"

          # Store in Secret Manager
          if ! gcloud secrets describe GCP-MCP-GATEWAY-TOKEN --project=$GCP_PROJECT_ID 2>/dev/null; then
            echo "Creating secret GCP-MCP-GATEWAY-TOKEN..."
            gcloud secrets create GCP-MCP-GATEWAY-TOKEN \
              --project=$GCP_PROJECT_ID \
              --replication-policy=automatic
          fi

          echo "Storing token in Secret Manager..."
          echo -n "$TOKEN" | gcloud secrets versions add GCP-MCP-GATEWAY-TOKEN \
            --data-file=- \
            --project=$GCP_PROJECT_ID

          echo ""
          echo "âœ… Token generated and stored in Secret Manager!"
          echo ""
          echo "Token: $TOKEN"
          echo ""
          echo "Configure Claude Code:"
          URL=$(gcloud run services describe gcp-mcp-gateway --region us-central1 --format='value(status.url)' 2>/dev/null || echo "https://gcp-mcp-gateway-XXXXXX.run.app")
          echo "claude mcp add --transport http \\"
          echo "  --header \"Authorization: Bearer $TOKEN\" \\"
          echo "  --scope user \\"
          echo "  gcp-gateway $URL"
