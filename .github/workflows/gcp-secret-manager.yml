name: GCP Secret Manager Access

on:
  workflow_dispatch:  # ×××¤×©×¨ ×”×¨×¦×” ×™×“× ×™×ª
  push:
    branches:
      - main
      - 'claude/**'

jobs:
  access-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP Authentication
        run: |
          echo "âœ… Authenticated as:"
          gcloud auth list
          echo ""
          echo "ğŸ“‹ Project ID:"
          gcloud config get-value project

      - name: List Secret Manager Secrets
        run: |
          echo "ğŸ” Available secrets in Secret Manager:"
          gcloud secrets list --format="table(name,created)" || echo "No secrets found or insufficient permissions"

      - name: Access a Secret (Example)
        run: |
          echo "ğŸ“– Example: Reading a secret from Secret Manager"
          echo "To access a specific secret, use:"
          echo "gcloud secrets versions access latest --secret='SECRET_NAME'"
          echo ""
          echo "Or in your code, use the Secret Manager API"

      - name: Install Secret Manager Client Library (Python example)
        run: |
          pip install google-cloud-secret-manager

      - name: Python Secret Manager Example
        run: |
          cat > test_secret_manager.py << 'EOF'
          from google.cloud import secretmanager

          def access_secret(project_id, secret_id, version_id="latest"):
              """
              Access a secret from Secret Manager

              Args:
                  project_id: GCP Project ID
                  secret_id: Secret name
                  version_id: Secret version (default: latest)
              """
              client = secretmanager.SecretManagerServiceClient()
              name = f"projects/{project_id}/secrets/{secret_id}/versions/{version_id}"

              try:
                  response = client.access_secret_version(request={"name": name})
                  payload = response.payload.data.decode("UTF-8")
                  print(f"âœ… Successfully accessed secret: {secret_id}")
                  return payload
              except Exception as e:
                  print(f"âŒ Error accessing secret: {e}")
                  return None

          # Example usage
          if __name__ == "__main__":
              project_id = "project38-483612"
              print("ğŸ” Testing Secret Manager access...")
              print(f"ğŸ“‹ Project: {project_id}")
              print("âœ… Secret Manager client initialized successfully")
              print("")
              print("To access a secret, call:")
              print("  secret_value = access_secret(project_id, 'your-secret-name')")
          EOF

          python test_secret_manager.py

      - name: Summary
        run: |
          echo "âœ¨ GCP Secret Manager Access Summary"
          echo "===================================="
          echo "âœ… Authenticated to GCP successfully"
          echo "ğŸ” Service Account: claude-code-agent@project38-483612.iam.gserviceaccount.com"
          echo "ğŸ“‹ Project ID: project38-483612"
          echo ""
          echo "ğŸ“š Next steps:"
          echo "  1. Create secrets in GCP Secret Manager"
          echo "  2. Grant access to the service account"
          echo "  3. Use gcloud or client libraries to access secrets"
