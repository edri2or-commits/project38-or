name: Test Docker Container Locally

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  test-container:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          cd src/gcp_mcp
          docker build -t gcp-mcp-test:local .

      - name: Test container startup
        id: test
        continue-on-error: true
        run: |
          cd src/gcp_mcp

          echo "Starting container..."
          docker run -d \
            --name gcp-mcp-test \
            -e PORT=8080 \
            -e GCP_PROJECT_ID=project38-483612 \
            -p 8080:8080 \
            gcp-mcp-test:local

          echo "Waiting 10 seconds for startup..."
          sleep 10

          echo ""
          echo "=== CONTAINER LOGS ==="
          docker logs gcp-mcp-test 2>&1 | tee /tmp/container-logs.txt
          echo "=== END LOGS ==="
          echo ""

          echo "Checking if port 8080 is listening..."
          if docker exec gcp-mcp-test sh -c "curl -f http://localhost:8080/health 2>/dev/null" ; then
            echo "‚úÖ Container is responding on port 8080"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Container is NOT responding on port 8080"
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "=== CONTAINER PROCESSES ==="
          docker exec gcp-mcp-test ps aux 2>&1 | tee /tmp/container-processes.txt || echo "Could not get processes"
          echo "=== END PROCESSES ==="

          echo ""
          echo "=== NETWORK PORTS ==="
          docker exec gcp-mcp-test sh -c "netstat -tlnp 2>/dev/null || ss -tlnp" 2>&1 | tee /tmp/container-ports.txt || echo "Could not check ports"
          echo "=== END PORTS ==="

      - name: Cleanup
        if: always()
        run: |
          docker stop gcp-mcp-test 2>/dev/null || true
          docker rm gcp-mcp-test 2>/dev/null || true

      - name: Report results to issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = '${{ steps.test.outputs.result }}';

            let report = `## üê≥ Docker Container Local Test\n\n`;
            report += `**Timestamp:** ${new Date().toISOString()}\n\n`;
            report += `**Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n`;

            if (result === 'success') {
              report += `### ‚úÖ Container Started Successfully\n\n`;
              report += `The container responds on port 8080. The issue is elsewhere.\n\n`;
            } else {
              report += `### ‚ùå Container Failed to Start\n\n`;
            }

            // Read container logs
            try {
              const containerLogs = fs.readFileSync('/tmp/container-logs.txt', 'utf8');
              report += `### Container Logs:\n\n\`\`\`\n${containerLogs.slice(-5000)}\n\`\`\`\n\n`;
            } catch (e) {
              report += `### Container Logs:\n\nCould not read logs: ${e.message}\n\n`;
            }

            // Read processes
            try {
              const processes = fs.readFileSync('/tmp/container-processes.txt', 'utf8');
              report += `### Container Processes:\n\n\`\`\`\n${processes}\n\`\`\`\n\n`;
            } catch (e) {
              report += `### Container Processes:\n\nCould not read processes: ${e.message}\n\n`;
            }

            // Read ports
            try {
              const ports = fs.readFileSync('/tmp/container-ports.txt', 'utf8');
              report += `### Network Ports:\n\n\`\`\`\n${ports}\n\`\`\`\n\n`;
            } catch (e) {
              report += `### Network Ports:\n\nCould not read ports: ${e.message}\n\n`;
            }

            // Post to issue #250
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 250,
              body: report
            });
