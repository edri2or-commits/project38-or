name: Fix Telegram Webhook

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Check and Fix Webhook
        run: |
          TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "::add-mask::$TOKEN"

          WEBHOOK_URL="https://telegram-bot-production-053d.up.railway.app/webhook"

          echo "=== Current Webhook Info ==="
          curl -s "https://api.telegram.org/bot${TOKEN}/getWebhookInfo" | jq '.'

          echo ""
          echo "=== Setting Webhook to: $WEBHOOK_URL ==="
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/setWebhook" \
            -d "url=$WEBHOOK_URL" \
            -d "drop_pending_updates=false" | jq '.'

          echo ""
          echo "=== Verifying Webhook ==="
          curl -s "https://api.telegram.org/bot${TOKEN}/getWebhookInfo" | jq '.'

          echo ""
          echo "âœ… Done!"
