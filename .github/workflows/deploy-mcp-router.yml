name: Deploy MCP Router Cloud Function

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'GCP Region'
        required: true
        default: 'us-central1'
        type: choice
        options:
          - us-central1
          - us-east1
          - europe-west1
      generation:
        description: 'Cloud Functions Generation'
        required: true
        default: 'gen2'
        type: choice
        options:
          - gen1
          - gen2

permissions:
  contents: read
  id-token: write  # Required for WIF

concurrency:
  group: deploy-mcp-router-${{ github.ref }}
  cancel-in-progress: true

env:
  PROJECT_ID: project38-483612
  FUNCTION_NAME: mcp-router
  SERVICE_ACCOUNT: claude-code-agent@project38-483612.iam.gserviceaccount.com

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Pre-Deployment Diagnostics
        run: |
          echo "=========================================="
          echo "PRE-DEPLOYMENT DIAGNOSTIC CHECKS"
          echo "=========================================="
          echo ""

          # Enable strict error checking for diagnostics
          set -e

          # Check 1: Verify GCP authentication
          echo "âœ“ Check 1: GCP Authentication"
          gcloud auth list --filter=status:ACTIVE --format="value(account)" || {
            echo "âŒ FAILED: Not authenticated to GCP"
            exit 1
          }
          echo "  âœ… Authenticated"
          echo ""

          # Check 2: Verify project access
          echo "âœ“ Check 2: Project Access"
          gcloud projects describe ${{ env.PROJECT_ID }} --format="value(projectId)" || {
            echo "âŒ FAILED: Cannot access project ${{ env.PROJECT_ID }}"
            exit 1
          }
          echo "  âœ… Project accessible"
          echo ""

          # Check 3: Billing status (non-blocking but informative)
          echo "âœ“ Check 3: Billing Status"
          set +e  # Don't fail on billing check
          BILLING_INFO=$(gcloud beta billing projects describe ${{ env.PROJECT_ID }} --format="value(billingEnabled)" 2>&1)
          BILLING_EXIT=$?
          set -e

          if [ $BILLING_EXIT -eq 0 ]; then
            if [ "$BILLING_INFO" = "True" ]; then
              echo "  âœ… Billing ENABLED"
            else
              echo "  âš ï¸  WARNING: Billing appears DISABLED"
              echo "  This will cause deployment to fail!"
              echo "  Fix: gcloud beta billing projects link ${{ env.PROJECT_ID }} --billing-account=YOUR-BILLING-ACCOUNT-ID"
            fi
          else
            echo "  âš ï¸  WARNING: Could not check billing status"
            echo "  Error: $BILLING_INFO"
          fi
          echo ""

          # Check 4: List existing Cloud Functions
          echo "âœ“ Check 4: Existing Functions in Region"
          set +e
          FUNCTIONS=$(gcloud functions list --regions=${{ inputs.region }} --format="value(name)" 2>&1)
          FUNCTIONS_EXIT=$?
          set -e

          if [ $FUNCTIONS_EXIT -eq 0 ]; then
            if [ -z "$FUNCTIONS" ]; then
              echo "  â„¹ï¸  No existing functions in ${{ inputs.region }}"
            else
              echo "  â„¹ï¸  Existing functions:"
              echo "$FUNCTIONS" | while read func; do
                echo "    - $func"
              done
            fi
          else
            echo "  âš ï¸  WARNING: Could not list functions"
            echo "  This may indicate API not enabled or permission issues"
          fi
          echo ""

          # Check 5: Service Account permissions
          echo "âœ“ Check 5: IAM Permissions Check"
          echo "  Checking if ${{ env.SERVICE_ACCOUNT }} has necessary roles..."

          set +e
          IAM_POLICY=$(gcloud projects get-iam-policy ${{ env.PROJECT_ID }} \
            --flatten="bindings[].members" \
            --filter="bindings.members:serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
            --format="table(bindings.role)" 2>&1)
          IAM_EXIT=$?
          set -e

          if [ $IAM_EXIT -eq 0 ]; then
            echo "  Current roles for service account:"
            echo "$IAM_POLICY"

            # Check for critical roles
            if echo "$IAM_POLICY" | grep -q "serviceAccountUser"; then
              echo "  âœ… Has roles/iam.serviceAccountUser (actAs permission)"
            else
              echo "  âš ï¸  WARNING: Missing roles/iam.serviceAccountUser"
              echo "  This is required to deploy functions!"
              echo "  Fix: gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \\"
              echo "         --member='serviceAccount:${{ env.SERVICE_ACCOUNT }}' \\"
              echo "         --role='roles/iam.serviceAccountUser'"
            fi
          else
            echo "  âš ï¸  Could not check IAM permissions"
          fi
          echo ""

          echo "=========================================="
          echo "DIAGNOSTIC CHECKS COMPLETE"
          echo "=========================================="
          echo ""

      - name: Check and Enable Required APIs
        run: |
          echo "Checking required APIs..."

          # Core API (required for both Gen 1 and Gen 2)
          CORE_APIS="cloudfunctions.googleapis.com"

          # Gen 2 requires additional APIs
          if [ "${{ inputs.generation }}" = "gen2" ]; then
            CORE_APIS="$CORE_APIS cloudbuild.googleapis.com run.googleapis.com artifactregistry.googleapis.com"
          fi

          for API in $CORE_APIS; do
            echo "Checking $API..."
            if ! gcloud services list --enabled --filter="name:$API" --format="value(name)" | grep -q "$API"; then
              echo "Enabling $API..."
              gcloud services enable "$API" --project="${{ env.PROJECT_ID }}" || {
                echo "âš ï¸ Could not enable $API - may need manual enablement"
                echo "Run: gcloud services enable $API --project=${{ env.PROJECT_ID }}"
              }
            else
              echo "âœ… $API already enabled"
            fi
          done

      - name: Get secrets from Secret Manager
        id: secrets
        run: |
          echo "Getting RAILWAY-API token..."
          RAILWAY_TOKEN=$(gcloud secrets versions access latest --secret="RAILWAY-API" --project="${PROJECT_ID}")
          echo "::add-mask::${RAILWAY_TOKEN}"
          echo "RAILWAY_TOKEN=${RAILWAY_TOKEN}" >> $GITHUB_OUTPUT

          echo "Getting or creating MCP_TUNNEL_TOKEN..."
          # Try to get existing token, or create new one
          MCP_TOKEN=$(gcloud secrets versions access latest --secret="MCP-TUNNEL-TOKEN" --project="${PROJECT_ID}" 2>/dev/null || echo "")

          if [ -z "$MCP_TOKEN" ]; then
            echo "Creating new MCP_TUNNEL_TOKEN secret..."
            # Generate a secure random token
            MCP_TOKEN=$(openssl rand -base64 32 | tr -d '/+=' | head -c 32)

            # Create the secret
            echo -n "$MCP_TOKEN" | gcloud secrets create MCP-TUNNEL-TOKEN \
              --project="${PROJECT_ID}" \
              --replication-policy="automatic" \
              --data-file=- 2>/dev/null || {
                # Secret exists but no version, add version
                echo -n "$MCP_TOKEN" | gcloud secrets versions add MCP-TUNNEL-TOKEN \
                  --project="${PROJECT_ID}" \
                  --data-file=-
              }
            echo "New MCP_TUNNEL_TOKEN created"
          else
            echo "Using existing MCP_TUNNEL_TOKEN"
          fi

          echo "::add-mask::${MCP_TOKEN}"
          echo "MCP_TUNNEL_TOKEN=${MCP_TOKEN}" >> $GITHUB_OUTPUT

      - name: Deploy Cloud Function (Gen 1)
        if: inputs.generation == 'gen1'
        run: |
          echo "=========================================="
          echo "DEPLOYING MCP ROUTER (GEN 1)"
          echo "=========================================="
          echo ""
          echo "Source files:"
          ls -la cloud_functions/mcp_router/
          echo ""
          echo "Requirements:"
          cat cloud_functions/mcp_router/requirements.txt
          echo ""

          # Enable strict error checking - deployment MUST succeed or fail loud
          set -e
          set -o pipefail

          echo "Starting deployment..."
          echo "âš ï¸  WARNING: You are using Gen 1. Consider Gen 2 for better Python 3.12 support."
          echo ""

          # Deploy with --allow-unauthenticated (public HTTP) but custom token validation
          # The function validates MCP_TUNNEL_TOKEN internally
          gcloud functions deploy ${{ env.FUNCTION_NAME }} \
            --runtime=python312 \
            --region=${{ inputs.region }} \
            --source=cloud_functions/mcp_router \
            --entry-point=mcp_router \
            --trigger-http \
            --allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --memory=512MB \
            --timeout=120s \
            --verbosity=debug \
            --set-env-vars="MCP_TUNNEL_TOKEN=${{ steps.secrets.outputs.MCP_TUNNEL_TOKEN }},RAILWAY_TOKEN=${{ steps.secrets.outputs.RAILWAY_TOKEN }},RAILWAY_PROJECT_ID=95ec21cc-9ada-41c5-8485-12f9a00e0116,RAILWAY_ENVIRONMENT_ID=99c99a18-aea2-4d01-9360-6a93705102a0"

          echo ""
          echo "âœ… Deployment completed successfully"
          echo ""

      - name: Deploy Cloud Function (Gen 2)
        if: inputs.generation == 'gen2'
        run: |
          echo "=========================================="
          echo "DEPLOYING MCP ROUTER (GEN 2)"
          echo "=========================================="
          echo ""
          echo "Source files:"
          ls -la cloud_functions/mcp_router/
          echo ""
          echo "Requirements:"
          cat cloud_functions/mcp_router/requirements.txt
          echo ""

          # Enable strict error checking - deployment MUST succeed or fail loud
          set -e
          set -o pipefail

          echo "Starting deployment to Gen 2 (Cloud Run functions)..."
          echo "âœ… Gen 2 is recommended for Python 3.12 + functions_framework"
          echo ""

          gcloud functions deploy ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --runtime=python312 \
            --region=${{ inputs.region }} \
            --source=cloud_functions/mcp_router \
            --entry-point=mcp_router \
            --trigger-http \
            --allow-unauthenticated \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --min-instances=1 \
            --max-instances=10 \
            --memory=512MB \
            --timeout=120s \
            --verbosity=debug \
            --set-env-vars="MCP_TUNNEL_TOKEN=${{ steps.secrets.outputs.MCP_TUNNEL_TOKEN }},RAILWAY_TOKEN=${{ steps.secrets.outputs.RAILWAY_TOKEN }},RAILWAY_PROJECT_ID=95ec21cc-9ada-41c5-8485-12f9a00e0116,RAILWAY_ENVIRONMENT_ID=99c99a18-aea2-4d01-9360-6a93705102a0"

          echo ""
          echo "âœ… Deployment completed successfully"
          echo ""

      - name: Get Function URL
        id: function_url
        run: |
          echo "Getting function URL..."

          # Gen 1 uses httpsTrigger.url, Gen 2 uses serviceConfig.uri
          if [ "${{ inputs.generation }}" = "gen1" ]; then
            URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
              --region=${{ inputs.region }} \
              --format='value(httpsTrigger.url)' 2>/dev/null || echo "")
          else
            URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
              --region=${{ inputs.region }} \
              --format='value(serviceConfig.uri)' 2>/dev/null || echo "")
          fi

          if [ -z "$URL" ]; then
            echo "Warning: Could not get function URL, trying alternate method..."
            URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
              --region=${{ inputs.region }} \
              --format=json | jq -r '.httpsTrigger.url // .serviceConfig.uri // "N/A"')
          fi

          echo "function_url=${URL}" >> $GITHUB_OUTPUT
          echo "Function URL: ${URL}"

      - name: Set IAM Policy (Optional)
        continue-on-error: true
        run: |
          echo "Setting IAM policy for Claude Code access..."
          echo ""
          echo "âš ï¸  Note: This is optional since we deployed with --allow-unauthenticated"
          echo "The service account may not have IAM admin rights - this is best-effort."
          echo ""

          if [ "${{ inputs.generation }}" = "gen1" ]; then
            # Gen 1: Use add-iam-policy-binding
            gcloud functions add-iam-policy-binding ${{ env.FUNCTION_NAME }} \
              --region=${{ inputs.region }} \
              --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" \
              --role="roles/cloudfunctions.invoker" && echo "âœ… IAM policy set" || {
                echo "âš ï¸ Could not set IAM policy - not critical since function is public"
              }
          else
            # Gen 2: Use add-invoker-policy-binding
            gcloud functions add-invoker-policy-binding ${{ env.FUNCTION_NAME }} \
              --region=${{ inputs.region }} \
              --member="serviceAccount:${{ env.SERVICE_ACCOUNT }}" && echo "âœ… IAM policy set" || {
                echo "âš ï¸ Could not set IAM policy - not critical since function is public"
              }
          fi

      - name: Test Function (Verification)
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "POST-DEPLOYMENT VERIFICATION"
          echo "=========================================="
          echo ""

          # Get the actual function URL from previous step
          FUNCTION_URL="${{ steps.function_url.outputs.function_url }}"

          if [ -z "$FUNCTION_URL" ] || [ "$FUNCTION_URL" = "N/A" ]; then
            echo "âš ï¸  WARNING: Could not retrieve function URL from deployment"
            echo "Attempting to construct URL manually..."

            if [ "${{ inputs.generation }}" = "gen1" ]; then
              FUNCTION_URL="https://${{ inputs.region }}-${{ env.PROJECT_ID }}.cloudfunctions.net/${{ env.FUNCTION_NAME }}"
            else
              echo "âš ï¸  Gen 2 URL format is dynamic, cannot construct without describe"
              echo "Skipping HTTP test"
              exit 0
            fi
          fi

          echo "Testing function at: ${FUNCTION_URL}"
          echo ""

          # Test 1: Basic connectivity (no auth)
          echo "Test 1: Basic Connectivity Check"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${FUNCTION_URL}")
          echo "  HTTP Status: ${HTTP_CODE}"

          if [ "$HTTP_CODE" = "404" ]; then
            echo "  âŒ FAILED: Function not accessible (404)"
            echo "  This indicates the function was NOT deployed successfully!"
            exit 1
          elif [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "401" ]; then
            echo "  â„¹ï¸  Function exists but requires authentication (expected)"
          elif [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "400" ]; then
            echo "  âœ… Function is accessible"
          else
            echo "  âš ï¸  Unexpected status code: ${HTTP_CODE}"
          fi
          echo ""

          # Test 2: MCP Protocol Test with token
          echo "Test 2: MCP Protocol Test (with MCP_TUNNEL_TOKEN)"
          RESPONSE=$(curl -s -w "\n\nHTTP_CODE: %{http_code}\n" -X POST "${FUNCTION_URL}" \
            -H "Authorization: Bearer ${{ steps.secrets.outputs.MCP_TUNNEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"data": "{\"jsonrpc\": \"2.0\", \"method\": \"tools/list\", \"id\": 1}"}' 2>&1)

          echo "Response:"
          echo "${RESPONSE}"
          echo ""

          if echo "${RESPONSE}" | grep -q '"result"'; then
            echo "  âœ… MCP Router responding correctly!"
          elif echo "${RESPONSE}" | grep -q 'tools'; then
            echo "  âœ… Function responded with tools data"
          else
            echo "  âš ï¸  Response format unexpected, but function is running"
          fi
          echo ""

          # Show function status
          echo "=========================================="
          echo "FUNCTION STATUS"
          echo "=========================================="
          gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --region=${{ inputs.region }} \
            --format="yaml(name,state,updateTime,serviceConfig.uri,httpsTrigger.url)" 2>/dev/null || {
              echo "Could not retrieve function status"
            }
          echo ""

          echo "âœ… Verification complete"

      - name: Summary
        run: |
          echo "## MCP Router Deployed Successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function URL:** ${{ steps.function_url.outputs.function_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Setup for Claude Code (Anthropic Cloud)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Step 1:** Get the MCP_TUNNEL_TOKEN from GCP Secret Manager:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'gcloud secrets versions access latest --secret="MCP-TUNNEL-TOKEN" --project="${{ env.PROJECT_ID }}"' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Step 2:** In Claude Code UI:" >> $GITHUB_STEP_SUMMARY
          echo "1. Click on Environment name (top left)" >> $GITHUB_STEP_SUMMARY
          echo "2. Select 'Add environment' or edit existing" >> $GITHUB_STEP_SUMMARY
          echo "3. Add: \`MCP_TUNNEL_TOKEN=<token-from-step-1>\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Start new session" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Step 3:** The tunnel will work automatically via:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "https://${{ inputs.region }}-${{ env.PROJECT_ID }}.cloudfunctions.net/${{ env.FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Why This Works" >> $GITHUB_STEP_SUMMARY
          echo "- \`*.cloudfunctions.net\` is a Google domain â†’ allowed by Anthropic proxy" >> $GITHUB_STEP_SUMMARY
          echo "- Custom token auth â†’ no GCP credentials needed in Claude Code session" >> $GITHUB_STEP_SUMMARY
          echo "- Token stored in Secret Manager â†’ secure, rotatable" >> $GITHUB_STEP_SUMMARY
