name: Test Drive Sheets Docs

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

env:
  GCP_PROJECT_ID: project38-483612

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-auth google-auth-oauthlib google-api-python-client

      - name: Test Drive, Sheets, Docs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python << 'PYTHON_EOF' 2>&1 | tee test_output.txt
          import subprocess
          import traceback
          from datetime import datetime

          def get_secret(name):
              result = subprocess.run(
                  ["gcloud", "secrets", "versions", "access", "latest",
                   f"--secret={name}", "--project=project38-483612"],
                  capture_output=True, text=True
              )
              return result.stdout.strip()

          print("üîê Loading credentials...")
          client_id = get_secret("GOOGLE-OAUTH-CLIENT-ID")
          client_secret = get_secret("GOOGLE-OAUTH-CLIENT-SECRET")
          refresh_token = get_secret("GOOGLE-OAUTH-REFRESH-TOKEN")

          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build

          creds = Credentials(
              token=None,
              refresh_token=refresh_token,
              token_uri="https://oauth2.googleapis.com/token",
              client_id=client_id,
              client_secret=client_secret,
              scopes=[
                  "https://www.googleapis.com/auth/drive",
                  "https://www.googleapis.com/auth/spreadsheets",
                  "https://www.googleapis.com/auth/documents"
              ]
          )

          results = []

          # Test Drive
          print("\nüìÅ Testing Drive...")
          try:
              drive = build('drive', 'v3', credentials=creds)

              # Create a test folder
              folder_metadata = {
                  'name': f'Claude Test {datetime.utcnow().strftime("%Y-%m-%d %H:%M")}',
                  'mimeType': 'application/vnd.google-apps.folder'
              }
              folder = drive.files().create(body=folder_metadata, fields='id,name,webViewLink').execute()

              results.append(("Drive", "‚úÖ SUCCESS", f"Folder: {folder.get('name')} (ID: {folder.get('id')[:8]}...)"))
              print(f"  ‚úÖ Created folder: {folder.get('name')}")

              # Clean up - delete the test folder
              drive.files().delete(fileId=folder.get('id')).execute()
              print(f"  üßπ Cleaned up test folder")

          except Exception as e:
              results.append(("Drive", "‚ùå FAILED", str(e)[:80]))
              print(f"  ‚ùå Error: {e}")
              traceback.print_exc()

          # Test Sheets
          print("\nüìä Testing Sheets...")
          try:
              sheets = build('sheets', 'v4', credentials=creds)
              drive = build('drive', 'v3', credentials=creds)

              # Create a test spreadsheet
              spreadsheet = {
                  'properties': {'title': f'Claude Test {datetime.utcnow().strftime("%Y-%m-%d %H:%M")}'}
              }
              sheet = sheets.spreadsheets().create(body=spreadsheet, fields='spreadsheetId,properties').execute()
              sheet_id = sheet.get('spreadsheetId')

              # Write some data
              values = [['Test', 'Data'], ['From', 'Claude'], ['Time', datetime.utcnow().isoformat()]]
              sheets.spreadsheets().values().update(
                  spreadsheetId=sheet_id,
                  range='A1:B3',
                  valueInputOption='RAW',
                  body={'values': values}
              ).execute()

              results.append(("Sheets", "‚úÖ SUCCESS", f"Sheet ID: {sheet_id[:8]}... (wrote 3 rows)"))
              print(f"  ‚úÖ Created and wrote to sheet: {sheet_id}")

              # Clean up
              drive.files().delete(fileId=sheet_id).execute()
              print(f"  üßπ Cleaned up test sheet")

          except Exception as e:
              results.append(("Sheets", "‚ùå FAILED", str(e)[:80]))
              print(f"  ‚ùå Error: {e}")
              traceback.print_exc()

          # Test Docs
          print("\nüìù Testing Docs...")
          try:
              docs = build('docs', 'v1', credentials=creds)
              drive = build('drive', 'v3', credentials=creds)

              # Create a test document
              doc = docs.documents().create(body={
                  'title': f'Claude Test {datetime.utcnow().strftime("%Y-%m-%d %H:%M")}'
              }).execute()
              doc_id = doc.get('documentId')

              # Insert some text
              requests = [
                  {'insertText': {
                      'location': {'index': 1},
                      'text': f'This document was created by Claude Autonomy System.\n\nTimestamp: {datetime.utcnow().isoformat()}'
                  }}
              ]
              docs.documents().batchUpdate(documentId=doc_id, body={'requests': requests}).execute()

              results.append(("Docs", "‚úÖ SUCCESS", f"Doc ID: {doc_id[:8]}... (inserted text)"))
              print(f"  ‚úÖ Created and wrote to doc: {doc_id}")

              # Clean up
              drive.files().delete(fileId=doc_id).execute()
              print(f"  üßπ Cleaned up test doc")

          except Exception as e:
              results.append(("Docs", "‚ùå FAILED", str(e)[:80]))
              print(f"  ‚ùå Error: {e}")
              traceback.print_exc()

          print("\n" + "=" * 60)
          print("üìä SUMMARY")
          print("=" * 60)
          for r in results:
              print(f"{r[0]}: {r[1]} - {r[2]}")
          PYTHON_EOF

          # Post results to issue
          DRIVE_LINE=$(grep "^Drive:" test_output.txt || echo "Drive: Unknown")
          SHEETS_LINE=$(grep "^Sheets:" test_output.txt || echo "Sheets: Unknown")
          DOCS_LINE=$(grep "^Docs:" test_output.txt || echo "Docs: Unknown")

          gh issue comment 149 --body "## üß™ Drive, Sheets, Docs Test Results

          | Service | Status | Details |
          |---------|--------|---------|
          | Drive | $(echo "$DRIVE_LINE" | cut -d: -f2- | cut -d- -f1) | $(echo "$DRIVE_LINE" | cut -d- -f2-) |
          | Sheets | $(echo "$SHEETS_LINE" | cut -d: -f2- | cut -d- -f1) | $(echo "$SHEETS_LINE" | cut -d- -f2-) |
          | Docs | $(echo "$DOCS_LINE" | cut -d: -f2- | cut -d- -f1) | $(echo "$DOCS_LINE" | cut -d- -f2-) |

          **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          <details>
          <summary>Full Log</summary>

          \`\`\`
          $(cat test_output.txt)
          \`\`\`
          </details>" --repo edri2or-commits/project38-or
