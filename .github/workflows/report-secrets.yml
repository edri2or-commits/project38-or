name: Report Secret Access

on:
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Install dependencies
        run: pip install -q google-cloud-secret-manager

      - name: Check Secrets and Write Report
        run: |
          python << 'PYTHON_EOF' > secret_report.txt
          from google.cloud import secretmanager
          from datetime import datetime
          import sys

          print("=" * 70)
          print("ğŸ” GCP Secret Manager - Access Report")
          print("=" * 70)
          print(f"ğŸ“… Generated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}")
          print(f"ğŸ“‹ Project: project38-483612")
          print(f"ğŸ”‘ Service Account: claude-code-agent@project38-483612.iam.gserviceaccount.com")
          print("=" * 70)

          try:
              client = secretmanager.SecretManagerServiceClient()
              project_id = "project38-483612"
              parent = f"projects/{project_id}"

              print(f"\nğŸ“¦ Listing Secrets:\n")

              secrets = []
              accessible = 0
              total_size = 0

              for secret in client.list_secrets(request={"parent": parent}):
                  secret_name = secret.name.split("/")[-1]
                  secrets.append(secret_name)

                  try:
                      secret_path = f"{secret.name}/versions/latest"
                      response = client.access_secret_version(request={"name": secret_path})
                      value_length = len(response.payload.data)
                      total_size += value_length
                      accessible += 1
                      print(f"  âœ… {secret_name}")
                      print(f"     â””â”€ Size: {value_length} bytes")
                      print(f"     â””â”€ Status: ACCESSIBLE")
                  except Exception as e:
                      print(f"  âŒ {secret_name}")
                      print(f"     â””â”€ Error: {type(e).__name__}")

              print(f"\n{'=' * 70}")
              print(f"ğŸ“Š Summary:")
              print(f"{'=' * 70}")
              print(f"  â€¢ Total secrets found:     {len(secrets)}")
              print(f"  â€¢ Successfully accessible: {accessible}")
              print(f"  â€¢ Total data size:         {total_size} bytes")
              print(f"  â€¢ Success rate:            {(accessible/len(secrets)*100) if secrets else 0:.1f}%")

              if accessible == len(secrets) and len(secrets) > 0:
                  print(f"\nâœ¨ ALL SYSTEMS OPERATIONAL! âœ¨")
                  print(f"   ğŸš€ Secret Manager is fully accessible")
                  print(f"   ğŸ”’ All secrets remain secure (values never exposed)")
                  print(f"   âœ… Ready for production use")
              else:
                  print(f"\nâš ï¸  PARTIAL ACCESS")
                  print(f"   Some secrets may not be accessible")

              print("=" * 70)

          except Exception as e:
              print(f"\nâŒ CRITICAL ERROR:")
              print(f"   {type(e).__name__}: {str(e)}")
              print("=" * 70)
              sys.exit(1)
          PYTHON_EOF

          cat secret_report.txt

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: secret-access-report
          path: secret_report.txt
          retention-days: 7

      - name: Commit Report to Repository
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add secret_report.txt || true
          git commit -m "ğŸ” Secret Manager Access Report - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          git push || echo "Push failed (may be no changes)"

      - name: Display Report Location
        run: |
          echo "ğŸ“„ Report saved as artifact: secret-access-report"
          echo "ğŸ“„ Report also committed to repository: secret_report.txt"
          echo "ğŸ”— View in Actions tab â†’ This run â†’ Artifacts"
