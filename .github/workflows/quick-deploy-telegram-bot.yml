name: Quick Deploy Telegram Bot

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  RAILWAY_PROJECT_ID: "95ec21cc-9ada-41c5-8485-12f9a00e0116"
  RAILWAY_ENVIRONMENT_ID: "99c99a18-aea2-4d01-9360-6a93705102a0"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Secrets
        id: secrets
        run: |
          RAILWAY_TOKEN=$(gcloud secrets versions access latest --secret="RAILWAY-API" --project=project38-483612)
          BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "::add-mask::$RAILWAY_TOKEN"
          echo "::add-mask::$BOT_TOKEN"
          echo "railway_token=$RAILWAY_TOKEN" >> $GITHUB_OUTPUT
          echo "bot_token=$BOT_TOKEN" >> $GITHUB_OUTPUT

      - name: Find or Create Telegram Bot Service
        id: service
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
        run: |
          # Find existing telegram-bot service
          SERVICES=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { project(id: \"'"$RAILWAY_PROJECT_ID"'\") { services { edges { node { id name } } } } }"
            }')

          echo "Services response:"
          echo "$SERVICES" | jq '.data.project.services.edges[].node'

          SERVICE_ID=$(echo "$SERVICES" | jq -r '.data.project.services.edges[] | select(.node.name == "telegram-bot") | .node.id' | head -1)

          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
            echo "Creating new telegram-bot service..."
            CREATE=$(curl -s -X POST \
              "https://backboard.railway.app/graphql/v2" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "mutation { serviceCreate(input: { name: \"telegram-bot\", projectId: \"'"$RAILWAY_PROJECT_ID"'\" }) { id name } }"
              }')
            echo "Create response: $CREATE"
            SERVICE_ID=$(echo "$CREATE" | jq -r '.data.serviceCreate.id')
          fi

          echo "Service ID: $SERVICE_ID"
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT

      - name: Check Service Status
        id: status
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
          SERVICE_ID: ${{ steps.service.outputs.service_id }}
        run: |
          echo "Checking service $SERVICE_ID status..."

          STATUS=$(curl -s -X POST \
            "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { service(id: \"'"$SERVICE_ID"'\") { name updatedAt deployments(first: 3) { edges { node { id status createdAt } } } serviceInstances { edges { node { id domains { serviceDomains { domain } } } } } } }"
            }')

          echo "Service status:"
          echo "$STATUS" | jq '.'

          DOMAIN=$(echo "$STATUS" | jq -r '.data.service.serviceInstances.edges[0].node.domains.serviceDomains[0].domain // "no domain"')
          DEPLOY_STATUS=$(echo "$STATUS" | jq -r '.data.service.deployments.edges[0].node.status // "no deployment"')

          echo "Domain: $DOMAIN"
          echo "Latest deployment status: $DEPLOY_STATUS"
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT

      - name: Connect Service to GitHub and Deploy
        continue-on-error: true
        env:
          RAILWAY_TOKEN: ${{ steps.secrets.outputs.railway_token }}
          SERVICE_ID: ${{ steps.service.outputs.service_id }}
          BOT_TOKEN: ${{ steps.secrets.outputs.bot_token }}
        run: |
          echo "Setting environment variables..."

          # Set all required env vars
          curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "mutation { variableUpsert(input: { projectId: \"'"$RAILWAY_PROJECT_ID"'\", environmentId: \"'"$RAILWAY_ENVIRONMENT_ID"'\", serviceId: \"'"$SERVICE_ID"'\", name: \"TELEGRAM_BOT_TOKEN\", value: \"'"$BOT_TOKEN"'\" }) }"}' > /dev/null

          curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "mutation { variableUpsert(input: { projectId: \"'"$RAILWAY_PROJECT_ID"'\", environmentId: \"'"$RAILWAY_ENVIRONMENT_ID"'\", serviceId: \"'"$SERVICE_ID"'\", name: \"LITELLM_GATEWAY_URL\", value: \"https://litellm-gateway-production-0339.up.railway.app\" }) }"}' > /dev/null

          curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "mutation { variableUpsert(input: { projectId: \"'"$RAILWAY_PROJECT_ID"'\", environmentId: \"'"$RAILWAY_ENVIRONMENT_ID"'\", serviceId: \"'"$SERVICE_ID"'\", name: \"GCP_PROJECT_ID\", value: \"project38-483612\" }) }"}' > /dev/null

          # Get PostgreSQL service and its DATABASE_URL
          echo "Finding PostgreSQL service..."
          POSTGRES_SERVICE=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query { project(id: \"'"$RAILWAY_PROJECT_ID"'\") { services { edges { node { id name } } } } }"
            }' | jq -r '.data.project.services.edges[] | select(.node.name | test("postgres|Postgres|PostgreSQL"; "i")) | .node.id' | head -1)

          if [ -n "$POSTGRES_SERVICE" ] && [ "$POSTGRES_SERVICE" != "null" ]; then
            echo "Found PostgreSQL service: $POSTGRES_SERVICE"

            # Get the DATABASE_URL from PostgreSQL service variables
            PG_VARS=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
              -H "Authorization: Bearer $RAILWAY_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "query": "query { variables(projectId: \"'"$RAILWAY_PROJECT_ID"'\", environmentId: \"'"$RAILWAY_ENVIRONMENT_ID"'\", serviceId: \"'"$POSTGRES_SERVICE"'\") }"
              }')

            DATABASE_URL=$(echo "$PG_VARS" | jq -r '.data.variables.DATABASE_URL // empty')

            if [ -n "$DATABASE_URL" ]; then
              echo "Setting DATABASE_URL for telegram-bot..."
              curl -s -X POST "https://backboard.railway.app/graphql/v2" \
                -H "Authorization: Bearer $RAILWAY_TOKEN" \
                -H "Content-Type: application/json" \
                -d '{"query": "mutation { variableUpsert(input: { projectId: \"'"$RAILWAY_PROJECT_ID"'\", environmentId: \"'"$RAILWAY_ENVIRONMENT_ID"'\", serviceId: \"'"$SERVICE_ID"'\", name: \"DATABASE_URL\", value: \"'"$DATABASE_URL"'\" }) }"}' > /dev/null
              echo "DATABASE_URL set ✅"
            else
              echo "❌ Could not get DATABASE_URL from PostgreSQL service"
              echo "Please check that PostgreSQL plugin is added to the Railway project"
              exit 1
            fi
          else
            echo "❌ No PostgreSQL service found in project"
            echo "Please add PostgreSQL plugin to Railway project first"
            exit 1
          fi

          echo "✅ Environment variables set"

          echo "Connecting service to GitHub repo (edri2or-commits/project38-or)..."
          CONNECT=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { serviceConnect(id: \"'"$SERVICE_ID"'\", input: { repo: \"edri2or-commits/project38-or\", branch: \"main\" }) { id } }"
            }')
          echo "Connect response: $CONNECT"

          echo "Setting root directory to services/telegram-bot..."
          ROOT=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { serviceUpdate(id: \"'"$SERVICE_ID"'\", input: { rootDirectory: \"services/telegram-bot\" }) { id rootDirectory } }"
            }')
          echo "Root directory response: $ROOT"

          sleep 5

          echo "Triggering deployment..."
          DEPLOY=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "mutation { serviceInstanceRedeploy(environmentId: \"'"$RAILWAY_ENVIRONMENT_ID"'\", serviceId: \"'"$SERVICE_ID"'\") }"}')
          echo "Redeploy response: $DEPLOY"

          sleep 30

          # Check final status
          FINAL=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "query { service(id: \"'"$SERVICE_ID"'\") { name repo { fullRepoName } rootDirectory deployments(first: 2) { edges { node { id status createdAt } } } } }"}')
          echo "Final status:"
          echo "$FINAL" | jq '.'
