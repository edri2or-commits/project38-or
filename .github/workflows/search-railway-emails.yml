name: Search Railway Emails

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  search:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install httpx

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'claude-code-agent@project38-483612.iam.gserviceaccount.com'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Search Railway Emails
        run: |
          # Get Google OAuth credentials
          export GOOGLE_OAUTH_CLIENT_ID=$(gcloud secrets versions access latest --secret="GOOGLE-OAUTH-CLIENT-ID" --project=project38-483612)
          export GOOGLE_OAUTH_CLIENT_SECRET=$(gcloud secrets versions access latest --secret="GOOGLE-OAUTH-CLIENT-SECRET" --project=project38-483612)
          export GOOGLE_OAUTH_REFRESH_TOKEN=$(gcloud secrets versions access latest --secret="GOOGLE-OAUTH-REFRESH-TOKEN" --project=project38-483612)

          echo "::add-mask::$GOOGLE_OAUTH_CLIENT_ID"
          echo "::add-mask::$GOOGLE_OAUTH_CLIENT_SECRET"
          echo "::add-mask::$GOOGLE_OAUTH_REFRESH_TOKEN"

          # Run the search
          python scripts/search_railway_emails.py
