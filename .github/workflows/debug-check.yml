name: Debug Routes Check

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  debug:
    name: Check Debug Routes Endpoint
    runs-on: ubuntu-latest

    steps:
      - name: Test /debug/routes
        id: debug
        run: |
          echo "ðŸ” Testing /debug/routes endpoint..."

          RESPONSE=$(curl -s https://or-infra.com/debug/routes)

          echo "Response:"
          echo "$RESPONSE" | jq .

          # Check if we got valid JSON
          if echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
            echo "âœ… Valid JSON response"

            # Extract route count
            ROUTE_COUNT=$(echo "$RESPONSE" | jq -r '.total_routes // 0')
            echo "Total routes: $ROUTE_COUNT"

            # Check if /health is registered
            HEALTH_ROUTE=$(echo "$RESPONSE" | jq -r '.routes[] | select(.path == "/health") | .path')

            if [ -n "$HEALTH_ROUTE" ]; then
              echo "âœ… /health route IS registered"
            else
              echo "âŒ /health route NOT registered"
            fi

            # List all routes
            echo ""
            echo "All routes:"
            echo "$RESPONSE" | jq -r '.routes[] | "\(.methods[]) \(.path)"'

          else
            echo "âŒ Invalid JSON response or endpoint not accessible"
            exit 1
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ” Debug Routes Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Endpoint: https://or-infra.com/debug/routes" >> $GITHUB_STEP_SUMMARY
