name: Check Relay Status

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check relay status
        run: |
          echo "Checking relay status at https://or-infra.com/api/relay/status"
          RESPONSE=$(curl -s https://or-infra.com/api/relay/status || echo '{"error": "connection failed"}')
          echo "Response: $RESPONSE"

          # Also check health
          echo ""
          echo "Checking health at https://or-infra.com/api/health"
          HEALTH=$(curl -s https://or-infra.com/api/health || echo '{"error": "connection failed"}')
          echo "Health: $HEALTH"

          # Check debug routes
          echo ""
          echo "Checking debug/routes"
          curl -s https://or-infra.com/debug/routes | head -c 2000 || true

      - name: Post to issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELAY=$(curl -s https://or-infra.com/api/relay/status || echo '{"error": "connection failed"}')
          HEALTH=$(curl -s https://or-infra.com/api/health || echo '{"error": "connection failed"}')
          ALL_ROUTES=$(curl -s https://or-infra.com/debug/routes)
          ROUTES=$(echo "$ALL_ROUTES" | jq -c '[.routes[] | select(.path | contains("relay") or contains("health") or contains("api/"))]' 2>/dev/null || echo '[]')
          ROUTE_COUNT=$(echo "$ALL_ROUTES" | jq '.total_routes' 2>/dev/null || echo 'unknown')

          gh issue comment 183 --repo ${{ github.repository }} --body "## Relay Status Check

          **Time**: $(date -u)

          **Relay Status** (/api/relay/status):
          \`\`\`json
          $RELAY
          \`\`\`

          **Health** (/api/health):
          \`\`\`json
          $HEALTH
          \`\`\`

          **Routes** (total: $ROUTE_COUNT, filtered to api/health/relay):
          \`\`\`json
          $ROUTES
          \`\`\`"
