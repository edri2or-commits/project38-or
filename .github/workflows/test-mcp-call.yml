# Test MCP tool call endpoint directly
name: Test MCP Call

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test MCP Call Endpoint
        run: |
          echo "=== Testing /api/mcp/call endpoint ==="

          echo ""
          echo "1. Health check tool:"
          curl -s -X POST "https://or-infra.com/api/mcp/call?tool_name=health_check" | tee /tmp/health_check.json | jq .

          echo ""
          echo "2. Get metrics tool:"
          curl -s -X POST "https://or-infra.com/api/mcp/call?tool_name=get_metrics" | tee /tmp/get_metrics.json | jq .

          echo ""
          echo "3. n8n_list tool:"
          curl -s -X POST "https://or-infra.com/api/mcp/call?tool_name=n8n_list" | tee /tmp/n8n_list.json | jq .

      - name: Post Results
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HEALTH=$(cat /tmp/health_check.json 2>/dev/null | head -50 || echo "No output")
          METRICS=$(cat /tmp/get_metrics.json 2>/dev/null | head -50 || echo "No output")
          N8N=$(cat /tmp/n8n_list.json 2>/dev/null | head -50 || echo "No output")

          gh issue comment 509 --repo ${{ github.repository }} --body "## MCP Tool Call Test

          **health_check:**
          \`\`\`json
          $HEALTH
          \`\`\`

          **get_metrics:**
          \`\`\`json
          $METRICS
          \`\`\`

          **n8n_list:**
          \`\`\`json
          $N8N
          \`\`\`
          "
