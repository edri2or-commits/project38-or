name: Auto-Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

# Minimal permissions for checks
permissions:
  contents: write  # Required for merge
  pull-requests: write  # Required for PR operations
  checks: read  # Required to read check status

# Only run one auto-merge per PR at a time
concurrency:
  group: auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validation Gate
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'claude/')

    outputs:
      should_merge: ${{ steps.decision.outputs.should_merge }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: üîí Security Check
        env:
          PYTHONPATH: ${{ github.workspace }}
        id: security
        run: |
          echo "## üîí Security Check" >> $GITHUB_STEP_SUMMARY

          # Check for secrets in diff
          if git diff origin/main...HEAD | grep -iE '(api[_-]?key|secret|password|token.*=|bearer |ghp_|sk-ant-api)'; then
            echo "‚ùå Potential secrets found in diff" >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ No secrets detected" >> $GITHUB_STEP_SUMMARY
          echo "status=passed" >> $GITHUB_OUTPUT

      - name: üß™ Run Tests
        id: tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY

          # Run tests with summary
          python -m pytest tests/ -v --tb=short > test_output.txt 2>&1
          TEST_EXIT=$?

          # Extract summary
          SUMMARY=$(tail -1 test_output.txt)
          echo "**Result:** $SUMMARY" >> $GITHUB_STEP_SUMMARY

          if [ $TEST_EXIT -ne 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A 5 "FAILED" test_output.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "status=passed" >> $GITHUB_OUTPUT

      - name: üé® Lint Check
        id: lint
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "## üé® Lint Check" >> $GITHUB_STEP_SUMMARY

          # Run ruff
          ruff check src/ tests/ > lint_output.txt 2>&1
          LINT_EXIT=$?

          if [ $LINT_EXIT -ne 0 ]; then
            echo "‚ùå Lint errors found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Lint passed" >> $GITHUB_STEP_SUMMARY
          echo "status=passed" >> $GITHUB_OUTPUT

      - name: üìö Documentation Check
        id: docs
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "## üìö Documentation Check" >> $GITHUB_STEP_SUMMARY

          # Check if src/ changed
          if git diff --name-only origin/main...HEAD | grep -q "^src/"; then
            # Verify changelog updated
            if ! git diff origin/main...HEAD docs/changelog.md | grep -q "^+"; then
              echo "‚ùå src/ changed but changelog.md not updated" >> $GITHUB_STEP_SUMMARY
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          # Run pydocstyle
          if command -v pydocstyle &> /dev/null; then
            pydocstyle src/ > docstyle_output.txt 2>&1
            DOCSTYLE_EXIT=$?

            if [ $DOCSTYLE_EXIT -ne 0 ]; then
              echo "‚ùå Docstring issues found" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -20 docstyle_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "‚úÖ Documentation passed" >> $GITHUB_STEP_SUMMARY
          echo "status=passed" >> $GITHUB_OUTPUT

      - name: üìä Generate Report
        if: always()
        run: |
          echo "## üìä Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ steps.security.outputs.status == 'passed' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.tests.outputs.status == 'passed' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ steps.lint.outputs.status == 'passed' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ steps.docs.outputs.status == 'passed' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: üéØ Merge Decision
        id: decision
        if: always()
        run: |
          SECURITY="${{ steps.security.outputs.status }}"
          TESTS="${{ steps.tests.outputs.status }}"
          LINT="${{ steps.lint.outputs.status }}"
          DOCS="${{ steps.docs.outputs.status }}"

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SECURITY" = "passed" ] && [ "$TESTS" = "passed" ] && [ "$LINT" = "passed" ] && [ "$DOCS" = "passed" ]; then
            echo "## ‚úÖ All checks passed - Ready for auto-merge" >> $GITHUB_STEP_SUMMARY
            echo "should_merge=true" >> $GITHUB_OUTPUT
          else
            echo "## ‚ùå Checks failed - Auto-merge blocked" >> $GITHUB_STEP_SUMMARY
            echo "should_merge=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  auto-merge:
    name: Auto-Merge
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_merge == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --squash \
            --delete-branch \
            --auto \
            --repo ${{ github.repository }}

      - name: üéâ Success
        run: |
          echo "## üéâ Auto-Merge Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ github.event.pull_request.number }} will be merged automatically once all required checks pass." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\` will be deleted after merge." >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: validate
    if: failure()

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚ùå Auto-Merge Failed\n\nOne or more validation checks failed. Please review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\n**Action Required:** Fix the issues and push again to retry auto-merge.'
            })
