name: Check Telegram Webhook

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - check
          - update

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          project_id: project38-483612
          workload_identity_provider: projects/979429709900/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: claude-code-agent@project38-483612.iam.gserviceaccount.com
          token_format: access_token

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Telegram Bot Token
        id: telegram-token
        run: |
          BOT_TOKEN=$(gcloud secrets versions access latest --secret="TELEGRAM-BOT-TOKEN" --project=project38-483612)
          echo "::add-mask::$BOT_TOKEN"
          echo "bot_token=$BOT_TOKEN" >> $GITHUB_OUTPUT

      - name: Check Current Webhook
        id: check-webhook
        env:
          BOT_TOKEN: ${{ steps.telegram-token.outputs.bot_token }}
        run: |
          echo "üìç Checking current webhook configuration..."

          RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo")

          echo "$RESPONSE" | jq '.'

          WEBHOOK_URL=$(echo "$RESPONSE" | jq -r '.result.url')
          PENDING_COUNT=$(echo "$RESPONSE" | jq -r '.result.pending_update_count')
          LAST_ERROR=$(echo "$RESPONSE" | jq -r '.result.last_error_message // "None"')

          echo ""
          echo "Current webhook URL: $WEBHOOK_URL"
          echo "Pending updates: $PENDING_COUNT"
          echo "Last error: $LAST_ERROR"

          # Save to outputs for posting to issue
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT
          echo "last_error=$LAST_ERROR" >> $GITHUB_OUTPUT

      - name: Post Results to Issue
        if: inputs.action == 'check'
        uses: actions/github-script@v7
        with:
          script: |
            const webhookUrl = '${{ steps.check-webhook.outputs.webhook_url }}';
            const pendingCount = '${{ steps.check-webhook.outputs.pending_count }}';
            const lastError = '${{ steps.check-webhook.outputs.last_error }}';

            const railwayUrl = 'https://telegram-bot-production-053d.up.railway.app/webhook';
            const isCorrect = webhookUrl === railwayUrl;

            const statusEmoji = isCorrect ? '‚úÖ' : '‚ö†Ô∏è';

            const body = `## ${statusEmoji} Telegram Webhook Status Check

**Current Configuration:**
- **Webhook URL**: \`${webhookUrl || 'Not set'}\`
- **Pending Updates**: ${pendingCount}
- **Last Error**: ${lastError}

**Expected URL**: \`${railwayUrl}\`

${isCorrect ? '‚úÖ **Webhook is correctly configured!**' : '‚ö†Ô∏è **Webhook needs to be updated!**'}

${isCorrect ? '' : `
### Next Step: Update Webhook

Run the workflow again with \`action: update\` to point the webhook to Railway:

\`\`\`bash
gh workflow run check-telegram-webhook.yml -f action=update --repo edri2or-commits/project38-or
\`\`\`
`}

---
Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 242,
              body: body
            });

      - name: Update Webhook to Railway
        id: update-webhook
        if: inputs.action == 'update'
        env:
          BOT_TOKEN: ${{ steps.telegram-token.outputs.bot_token }}
        run: |
          RAILWAY_URL="https://telegram-bot-production-053d.up.railway.app"

          echo "üîÑ Updating webhook to Railway..."
          echo "New URL: $RAILWAY_URL/webhook"

          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook" \
            -d "url=$RAILWAY_URL/webhook" \
            -d "max_connections=40" \
            -d "drop_pending_updates=false")

          echo "$RESPONSE" | jq '.'

          SUCCESS=$(echo "$RESPONSE" | jq -r '.ok')

          if [ "$SUCCESS" = "true" ]; then
            echo "‚úÖ Webhook updated successfully!"
            echo ""
            echo "Verifying new webhook..."
            VERIFY_RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo")
            echo "$VERIFY_RESPONSE" | jq '.'

            NEW_WEBHOOK_URL=$(echo "$VERIFY_RESPONSE" | jq -r '.result.url')
            echo "new_webhook_url=$NEW_WEBHOOK_URL" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to update webhook"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post Update Results to Issue
        if: inputs.action == 'update'
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.update-webhook.outputs.success }}' === 'true';
            const newWebhookUrl = '${{ steps.update-webhook.outputs.new_webhook_url }}';

            const statusEmoji = success ? '‚úÖ' : '‚ùå';

            const body = `## ${statusEmoji} Telegram Webhook ${success ? 'Updated' : 'Update Failed'}

${success ? `
**Webhook has been updated successfully!**

- **New URL**: \`${newWebhookUrl}\`
- **Service**: Railway (telegram-bot-production-053d)

### ‚úÖ Next Steps

1. **Test the bot** in Telegram:
   - Send: \`/start\`
   - Send: \`Hello!\`
   - Send: \`/generate Write a haiku about coding\`

2. **Verify responses** come from Claude/GPT-4/Gemini (not n8n templates)

3. **Check Railway logs** for LiteLLM Gateway calls

The bot should now respond with intelligent, context-aware messages powered by Multi-LLM routing!
` : `
**Failed to update webhook.**

Please check the workflow logs for details.
`}

---
Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 242,
              body: body
            });
