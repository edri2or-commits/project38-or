#!/bin/bash
# Pre-commit hook for doc-updater
# This hook prevents commits with:
# - Missing docstrings
# - Exposed secrets
# - Undocumented changes to src/

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå python3 not found. Cannot run pre-commit checks.${NC}"
    exit 1
fi

# Check if doc_updater module exists
if [ ! -f "src/doc_updater.py" ]; then
    echo -e "${RED}‚ùå src/doc_updater.py not found${NC}"
    exit 1
fi

# Run verification checks
echo ""
echo "Running doc-updater --verify..."
if python3 src/doc_updater.py --verify; then
    echo -e "${GREEN}‚úÖ All checks passed${NC}"
else
    echo ""
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    echo "To fix issues:"
    echo "  1. Add missing docstrings (Google style)"
    echo "  2. Remove any exposed secrets"
    echo "  3. Update docs/changelog.md if src/ changed"
    echo ""
    exit 1
fi

# Additional check: if src/ files changed, remind about changelog
CHANGED_SRC=$(git diff --cached --name-only --diff-filter=ACM | grep "^src/.*\.py$" || true)

if [ -n "$CHANGED_SRC" ]; then
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Python files in src/ are being committed:${NC}"
    echo "$CHANGED_SRC" | sed 's/^/  - /'

    # Check if changelog was also staged
    CHANGELOG_STAGED=$(git diff --cached --name-only | grep "^docs/changelog.md$" || true)

    if [ -z "$CHANGELOG_STAGED" ]; then
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  docs/changelog.md is NOT staged${NC}"
        echo ""
        echo "Consider updating the changelog:"
        echo "  python3 src/doc_updater.py --suggest"
        echo "  # Edit docs/changelog.md"
        echo "  git add docs/changelog.md"
        echo ""
        echo -e "${YELLOW}Proceeding with commit (warning only)...${NC}"
    else
        echo -e "${GREEN}‚úÖ docs/changelog.md is staged${NC}"
    fi
fi

echo ""
echo -e "${GREEN}‚úÖ Pre-commit checks complete${NC}"
exit 0
