# Railway Deployment Guide

## Overview

This guide documents the Railway deployment pipeline for the Agent Platform. Railway provides a production environment with PostgreSQL database and automatic HTTPS.

---

## Prerequisites

### 1. Railway Project Setup

**Create Railway Project:**
```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Create new project
railway init

# Link to GitHub repository
railway link
```

**Get Project/Environment IDs:**
```bash
# Get project ID
railway status
# Output: Project ID: abc123...

# Get environment ID
railway environment
# Output: Environment ID: def456...
```

Save these IDs - you'll need them for the GitHub workflow.

### 2. Railway Database Configuration

**Add PostgreSQL:**
1. Go to Railway dashboard: https://railway.app/dashboard
2. Click on your project
3. Click "New" → "Database" → "PostgreSQL"
4. Railway automatically creates `DATABASE_URL` variable

**Database Connection String:**
```
postgresql://user:password@host:port/dbname
```

Railway provides this as `DATABASE_URL` environment variable.

### 3. Railway Environment Variables

Railway needs these environment variables (set in dashboard):

| Variable | Source | Purpose |
|----------|--------|---------|
| `DATABASE_URL` | Auto-generated by Railway | PostgreSQL connection |
| `GCP_PROJECT_ID` | Manual | `project38-483612` |
| `GCP_SERVICE_ACCOUNT_EMAIL` | Manual | `claude-code-agent@project38-483612.iam.gserviceaccount.com` |
| `PORT` | Auto-set by Railway | Application port (default: 8000) |

**⚠️ Important:** Railway uses **ephemeral filesystem** - don't store data on disk!

---

## Secret Management Strategy

### The "Secret Zero" Problem

Railway has no native Workload Identity Federation support, so we use the **Bootstrap Key Pattern**:

```
Railway Env Var (BOOTSTRAP_KEY) → Authenticate to GCP → Fetch other secrets → Load to memory
```

### Setup Process

**Step 1: Create Railway Service Account Key (One-time)**

```bash
# Create a dedicated Railway service account
gcloud iam service-accounts create railway-bootstrap \
  --project=project38-483612 \
  --display-name="Railway Bootstrap"

# Grant Secret Manager access
gcloud projects add-iam-policy-binding project38-483612 \
  --member="serviceAccount:railway-bootstrap@project38-483612.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"

# Create key (download JSON)
gcloud iam service-accounts keys create railway-key.json \
  --iam-account=railway-bootstrap@project38-483612.iam.gserviceaccount.com
```

**Step 2: Add Bootstrap Key to Railway**

```bash
# Copy the entire JSON content
cat railway-key.json

# Add to Railway dashboard:
# Settings → Variables → Add Variable
# Name: GCP_SERVICE_ACCOUNT_KEY
# Value: <paste entire JSON>
```

**Step 3: Application Startup Code**

The FastAPI app loads secrets on startup:

```python
# src/api/main.py (lifespan function)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """Load secrets on startup."""
    # Initialize SecretManager
    manager = SecretManager()

    # Load required secrets to environment
    manager.load_secrets_to_env({
        "ANTHROPIC_API_KEY": "ANTHROPIC-API",
        "OPENAI_API_KEY": "OPENAI-API",
        "TELEGRAM_BOT_TOKEN": "TELEGRAM-BOT-TOKEN",
        "N8N_API_KEY": "N8N-API",
    })

    # Initialize database connection
    await init_db()

    yield

    # Cleanup on shutdown
    await close_db()
    manager.clear_cache()
```

### Security Considerations

**✅ Good:**
- Bootstrap key has minimal permissions (secretAccessor only)
- Key is separate from GitHub Actions (different SA)
- Secrets loaded to memory, not disk
- Cache cleared on shutdown

**⚠️ Limitations:**
- Bootstrap key is long-lived (must rotate quarterly)
- Key stored in Railway (not as secure as WIF)
- If Railway is compromised, attacker gets GCP access

**Future Improvement:**
- Monitor Railway for WIF support
- Implement key rotation automation
- Use GCP Secret Manager audit logs

---

## Deployment Workflow

### Manual Deployment

**Via GitHub Actions:**
1. Go to Actions tab: https://github.com/edri2or-commits/project38-or/actions
2. Select "Deploy to Railway"
3. Click "Run workflow"
4. Select environment: `production` or `staging`
5. Approve deployment (if Production environment)

**Direct to Railway:**
```bash
# Deploy current branch
railway up

# Deploy specific branch
railway up --branch main
```

### Automatic Deployment (Future)

To enable automatic deployment on push to main:

```yaml
# .github/workflows/deploy-railway.yml
on:
  push:
    branches:
      - main  # Deploy on every push to main
```

**⚠️ Not recommended** - keep manual approval for production safety.

---

## Railway Configuration Files

### Procfile (Optional)

Railway auto-detects Python apps, but you can be explicit:

```procfile
# Procfile (create in root)
web: uvicorn src.api.main:app --host 0.0.0.0 --port $PORT
```

### railway.json (Optional)

Configure build and deployment:

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pip install -r requirements.txt"
  },
  "deploy": {
    "startCommand": "uvicorn src.api.main:app --host 0.0.0.0 --port $PORT",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 3
  }
}
```

### nixpacks.toml (Optional)

Fine-tune Python environment:

```toml
[phases.setup]
nixPkgs = ["python311", "postgresql"]

[phases.install]
cmds = ["pip install -r requirements.txt"]

[start]
cmd = "uvicorn src.api.main:app --host 0.0.0.0 --port $PORT"
```

---

## Health Checks

### Endpoint

```
GET https://your-app.up.railway.app/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "version": "0.1.0",
  "database": "connected"
}
```

### Monitoring

**Railway Dashboard:**
- Deployment logs: Real-time view
- Metrics: CPU, Memory, Network
- Crash detection: Automatic restart

**External Monitoring (Recommended):**
- UptimeRobot: Free HTTP monitoring
- Better Uptime: Advanced monitoring
- Custom: Use `/health` endpoint

---

## Troubleshooting

### Deployment Failed

**Check Railway logs:**
```bash
railway logs
```

**Common Issues:**

| Error | Cause | Solution |
|-------|-------|----------|
| `ModuleNotFoundError` | Missing dependency | Check `requirements.txt` |
| `Connection refused` | Wrong PORT | Use `$PORT` env var |
| `Secret not found` | GCP auth failed | Verify bootstrap key |
| `Database connection failed` | Wrong `DATABASE_URL` | Check Railway dashboard |

### Rollback

**Via Railway CLI:**
```bash
# List deployments
railway deployments

# Rollback to previous
railway rollback <deployment-id>
```

**Via Dashboard:**
1. Go to project → Deployments
2. Find previous working deployment
3. Click "Redeploy"

### Secret Rotation

**When ANTHROPIC-API key rotates:**

1. Update in GCP Secret Manager:
   ```bash
   echo -n "new-key-value" | gcloud secrets versions add ANTHROPIC-API \
     --data-file=-
   ```

2. Restart Railway app:
   ```bash
   railway restart
   ```

3. Verify:
   ```bash
   railway logs --tail 50
   ```

**When Bootstrap Key rotates:**

1. Create new SA key:
   ```bash
   gcloud iam service-accounts keys create railway-key-new.json \
     --iam-account=railway-bootstrap@project38-483612.iam.gserviceaccount.com
   ```

2. Update in Railway dashboard:
   - Variables → `GCP_SERVICE_ACCOUNT_KEY` → Edit → Paste new JSON

3. Delete old key:
   ```bash
   gcloud iam service-accounts keys delete <old-key-id> \
     --iam-account=railway-bootstrap@project38-483612.iam.gserviceaccount.com
   ```

4. Restart app

---

## Cost Estimation

**Railway Pricing (as of 2026-01):**

| Resource | Free Tier | Usage | Est. Cost |
|----------|-----------|-------|-----------|
| Compute | $5 credit/month | ~20% CPU, 512MB RAM | $0-5/month |
| PostgreSQL | 1GB free | < 1GB expected | $0/month |
| Bandwidth | 100GB free | < 10GB expected | $0/month |

**Total:** ~$0-5/month for development, ~$10-20/month for production

**GCP Costs:**
- Secret Manager: ~$0.06/10k accesses (negligible)
- Total: < $1/month

**Claude API Costs:**
- Agent generation: ~$0.025-0.10 per agent
- Ralph loop iterations: ~$2-3 per agent
- Production usage: Varies by volume

---

## Production Checklist

Before deploying to production:

- [ ] Railway project configured with PostgreSQL
- [ ] Bootstrap key added to Railway environment variables
- [ ] `GCP_PROJECT_ID` set in Railway
- [ ] GitHub Actions workflow tested
- [ ] Health check endpoint verified
- [ ] Database migrations applied
- [ ] Monitoring configured (UptimeRobot/Better Uptime)
- [ ] CORS origins restricted (update `src/api/main.py`)
- [ ] Rate limiting configured (future)
- [ ] Backup strategy documented (Railway auto-backups)

---

## Links

- Railway Dashboard: https://railway.app/dashboard
- Railway Docs: https://docs.railway.app/
- Railway Status: https://status.railway.app/
- GCP Console: https://console.cloud.google.com/
