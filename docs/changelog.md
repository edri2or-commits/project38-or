# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **Railway Deployment Pipeline** - Complete infrastructure for deploying Agent Platform to Railway (2026-01-12)
  - `railway.json` - Railway build and deploy configuration with Playwright Chromium installation
  - `Procfile` - Fallback process definition for Railway (`web: uvicorn src.api.main:app --host 0.0.0.0 --port $PORT`)
  - `.github/workflows/deploy-railway.yml` - GitHub Actions workflow for Railway deployment
    - Manual trigger with environment selection (production/staging)
    - GitHub Environment "Production" approval gate
    - WIF authentication to fetch RAILWAY-API token from GCP Secret Manager
    - Railway CLI integration for deployment (`railway up --detach`)
    - Health check verification at `/health` endpoint with 10 retries
    - Deployment status reporting in GitHub Actions summary
  - `docs/railway-setup.md` - Comprehensive Railway setup guide (7 sections, 350+ lines)
    - Step-by-step Railway project creation
    - PostgreSQL database configuration
    - Environment variables setup
    - Deployment process documentation
    - Monitoring and logging setup
    - Troubleshooting guide with 5 common issues
    - Cost estimation and security best practices
    - Rollback procedure
  - Updated `CLAUDE.md` Railway section from "Future" to "Current" (lines 979-1017)
    - Deployment architecture documentation
    - Key constraints (ephemeral filesystem, PostgreSQL persistence)
    - Deployment process workflow
    - Configuration files reference
  - Updated `CLAUDE.md` File Structure (lines 193, 208, 214-215) to include Railway files
  - Railway deployment features:
    - Zero-downtime deployments
    - Automatic PostgreSQL backups
    - Built-in metrics and logging
    - HTTPS by default
    - $5/month free tier (sufficient for development)
  - Integration with existing infrastructure:
    - Secrets from GCP Secret Manager
    - WIF authentication (no static credentials)
    - FastAPI application (Phase 3.1)
    - PostgreSQL database (Phase 3.1)
    - Agent Factory, Harness, and MCP Tools (Phases 3.2-3.4)
  - Estimated production cost: ~$23/month (~$10 web service + ~$8 PostgreSQL + ~$5 egress)
- **Phase 3.4: MCP Tools** - Browser automation, sandboxed filesystem, and notifications (2026-01-12)
  - `src/mcp/browser.py` - Playwright-based web automation with headless Chromium (488 lines)
  - `src/mcp/filesystem.py` - Sandboxed file operations per agent at /workspace/agent_{id}/ (528 lines)
  - `src/mcp/notifications.py` - Telegram bot and n8n webhook integration (327 lines)
  - `src/mcp/registry.py` - Centralized tool access control and usage tracking (497 lines)
  - `tests/test_mcp.py` - 30 comprehensive tests with 100% pass rate (438 lines)
  - `docs/api/mcp.md` - Complete API documentation with examples and troubleshooting (886 lines)
  - New dependencies: playwright>=1.40.0, httpx>=0.27.0
  - Browser tools: navigate(), click(), extract_text(), screenshot(), fill_form(), wait_for_element()
  - Filesystem tools: read_file(), write_file(), list_files(), delete_file(), create_dir(), file_info()
  - Security features: Path traversal prevention, absolute path blocking, 10MB file size limit, sandbox isolation
  - Rate limiting: Configurable per-minute and per-hour limits to prevent abuse
  - Usage tracking: Records all operations with success/failure, duration, and agent attribution
  - Resource limits: Max 2 concurrent browsers, max 10MB files, max 100 notifications/hour
  - Notification channels: Telegram (direct API), n8n webhooks (via httpx)
  - Context manager support for automatic cleanup of browser and HTTP clients
  - Dynamic Playwright import (no dependency if browser not used)
  - Integration with Agent Harness for tool provisioning during agent execution
  - All 123 tests passing (including 30 new MCP tests)
- **Phase 3.3: Agent Harness** - 24/7 orchestration and execution infrastructure (2026-01-11)
  - `src/harness/executor.py` - Executes agent code in isolated subprocesses with timeout protection
  - `src/harness/scheduler.py` - APScheduler integration with PostgreSQL advisory locks for idempotent execution
  - `src/harness/resources.py` - Resource monitoring and concurrency control using psutil and asyncio semaphores
  - `src/harness/handoff.py` - State persistence between agent runs for long-running agents
  - `src/api/routes/tasks.py` - REST API endpoints for task management (GET, POST retry, DELETE, stats)
  - `tests/test_harness.py` - 23 comprehensive tests covering all harness components
  - `docs/api/harness.md` - Complete API documentation with examples and troubleshooting
  - New dependencies: apscheduler>=3.10.0, psutil>=5.9.0
  - Advisory lock pattern prevents duplicate execution on Railway multi-replica deployments
  - Resource limits: 5 concurrent agents max (configurable), 256MB memory per agent, 50% CPU throttling
  - Handoff artifacts enable agents to maintain context across 100+ consecutive runs
  - Task API endpoints: GET /api/tasks/{id}, GET /api/tasks/agent/{id}, POST /api/tasks/{id}/retry, DELETE /api/tasks/{id}, GET /api/tasks/stats/summary
  - Integration with existing Agent Factory for autonomous scheduled execution
  - Foundation for Phase 3.4 (MCP Tools) and full autonomous agent platform
- **Phase 3.2: Agent Factory** - Natural Language to Working Python Agent (2026-01-11)
  - `src/factory/generator.py` - Claude Sonnet 4.5 code generation from natural language
  - `src/factory/validator.py` - Multi-stage validation (syntax, ruff, pydocstyle, security patterns)
  - `src/factory/ralph_loop.py` - Recursive Test→Fix→Test cycle for automatic code fixing
  - `src/api/routes/agents.py` - REST API endpoints for agent CRUD operations
  - `tests/test_factory.py` - 16 comprehensive tests with Anthropic API mocking
  - `docs/api/factory.md` - Complete API documentation for Agent Factory
  - New dependencies: anthropic>=0.18.0, jinja2>=3.1.0
  - POST /api/agents endpoint for creating agents from descriptions
  - Security pattern detection (eval/exec, hardcoded secrets, shell injection)
  - Cost estimation: ~$0.025-$0.10 per agent generated
  - Target cost < $3 per agent achieved (including Ralph loop iterations)
  - Foundation for Phase 3.3 (Agent Harness) and autonomous agent deployment
- **Documentation Alignment** - Synchronized CLAUDE.md and BOOTSTRAP_PLAN.md with Phase 3.1 completion
  - Updated `CLAUDE.md` File Structure to include `src/api/`, `src/models/`, `src/github_auth.py`, `src/github_pr.py`
  - Added complete Phase 3 documentation to `docs/BOOTSTRAP_PLAN.md` (245 lines):
    - Phase 3.1: Core Infrastructure ✅ COMPLETED (database schema, endpoints, dependencies)
    - Phase 3.2: Agent Factory ✅ COMPLETED (Claude code generator, Ralph Wiggum loop, CRUD endpoints)
    - Phase 3.3: Agent Harness ✅ COMPLETED (24/7 orchestration, Handoff Artifacts, scheduler)
    - Phase 3.4: MCP Tools ✅ COMPLETED (browser automation, filesystem, notifications)
  - Ensures all project documentation accurately reflects current system state
- **Phase 3.1 API Documentation** - Comprehensive API reference for FastAPI application and database layer
  - `docs/api/fastapi.md` - FastAPI application documentation (configuration, endpoints, lifecycle, testing)
  - `docs/api/database.md` - Database connection management (async patterns, pooling, health checks)
  - `docs/api/models.md` - SQLModel schemas documentation (Agent/Task entities, relationships, usage patterns)
  - Updated `docs/api/index.md` with overview of all API layers (FastAPI, Database, Models, Secrets, GitHub)
  - Updated `mkdocs.yml` navigation to include new API documentation pages
  - Completes documentation requirement for Phase 3.1 Core Infrastructure
- **Phase 3.1: Core Infrastructure** - FastAPI application and database models for Agent Platform
  - `src/api/main.py` - FastAPI app entry point with CORS middleware and lifecycle hooks
  - `src/api/routes/health.py` - Health check (`/health`) and root (`/`) endpoints
  - `src/api/database.py` - PostgreSQL connection management with asyncpg and SQLModel
  - `src/models/agent.py` - Agent entity schema (name, description, code, status, timestamps)
  - `src/models/task.py` - Task entity schema (agent execution history, scheduling, results)
  - New dependencies: fastapi>=0.109.0, sqlmodel>=0.0.14, asyncpg>=0.29.0, uvicorn[standard]>=0.27.0
  - `tests/test_api_health.py` - 10 tests for health check endpoints
  - Foundation for Agent Factory (Phase 3.2) and Agent Harness (Phase 3.3)

### Fixed
- **SQLModel Column definition** - Fixed SQLAlchemy ArgumentError in Agent and Task models (2026-01-11)
  - Changed `sa_column_kwargs={"type_": "TEXT"}` to `sa_column=Column(Text, nullable=True)` in `src/models/agent.py:36,41`
  - Changed `sa_column_kwargs={"type_": "TEXT"}` to `sa_column=Column(Text, nullable=True)` in `src/models/task.py:39,40`
  - Resolves "May not pass type_ positionally and as a keyword" error during model imports
  - Added proper SQLAlchemy imports: `from sqlalchemy import Column, Text`
  - All 93 tests now pass successfully
- **BOOTSTRAP_PLAN.md accuracy** - Updated Success Metrics and completed skills documentation
  - Corrected Autonomous Skills count from 5 to 7 in `docs/BOOTSTRAP_PLAN.md:238`
  - Updated Current State date from 2026-01-09 to 2026-01-11 in `docs/BOOTSTRAP_PLAN.md:3`
  - Moved completed skills from Future Enhancements to Completed section:
    - dependency-checker skill (v1.0.0) - security vulnerability audits
    - changelog-updater skill (v1.0.0) - automated changelog generation
    - session-start-hook skill (v1.0.0) - environment setup automation
  - Added new "Skills Enhancement (2026-01-11)" section with detailed descriptions
  - Cleaned up Future Enhancements section to reflect remaining work

### Added
- **session-start-hook skill (v1.0.0)** for creating and managing SessionStart hooks in `.claude/skills/session-start-hook/SKILL.md`
  - Creates `.claude/.claude-settings.json` with SessionStart hook configuration
  - Generates `.claude/hooks/session-start.sh` script for automated environment checks
  - Verifies Python and development tools (pytest, ruff, pydocstyle) availability
  - Displays git status, current branch, and project configuration on session start
  - Shows available skills and quick reminders about project guidelines
  - Auto-installs dependencies if requirements.txt is newer than last install
  - Fast startup (< 10 seconds) and idempotent (safe to run multiple times)
  - Works in both local Claude Code CLI and web environments
  - Updated Skills README in `.claude/skills/README.md:284-366` with complete documentation
  - Updated CLAUDE.md in `CLAUDE.md:566-622` with skill description and usage examples
  - Provides foundation for all other skills by ensuring environment is ready
- **Manual setup documentation in MkDocs navigation** - Added `manual-setup-guide.md` and `wif-migration-plan.md` to site structure
  - New section "הגדרות ידניות" under ארכיטקטורה in `mkdocs.yml:62-64`
  - Resolves mkdocs build warning about pages not in nav configuration
  - Improves discoverability of setup guides
- **changelog-updater skill (v1.0.0)** for automatically generating changelog entries from git commit history in `.claude/skills/changelog-updater/SKILL.md`
  - Analyzes git commit history from branch divergence point
  - Parses conventional commit messages (feat, fix, docs, security, etc.)
  - Categorizes changes into appropriate changelog sections (Added/Changed/Fixed/Security)
  - Generates well-formatted, human-readable changelog entries with file references
  - Groups related commits to reduce clutter
  - Updates `docs/changelog.md` under [Unreleased] section automatically
  - Validates markdown syntax and completeness
  - Updated Skills README in `.claude/skills/README.md:221-282` with complete documentation
  - Updated CLAUDE.md in `CLAUDE.md:507-564` with skill description and usage examples
- **100% test coverage achieved** - Added 4 new tests to reach complete code coverage (174/174 statements)
  - PermissionError handling in `ensure_gh_cli()`
  - SubprocessError handling in `ensure_gh_cli()` and `create_pr_with_gh()`
  - Failed branch detection in `create_pr()`
  - All edge cases now covered
- **github_pr API documentation** in `docs/api/github_pr.md` - Complete documentation coverage achieved (3/3 modules)
  - Function reference with docstrings
  - Usage examples and patterns
  - Security guidelines
  - Troubleshooting guide
  - Comparison: gh CLI vs requests
- **Updated Success Metrics** in `docs/BOOTSTRAP_PLAN.md` - Corrected Autonomous Skills count from 4 to 5
- **Git troubleshooting documentation** in `CLAUDE.md:673-810` - Comprehensive guide for handling 403 errors and merge conflicts
  - Problem 1: HTTP 403 on git push (branch protection, merge conflicts)
  - Problem 2: Merge conflicts in PRs (clean branch approach)
  - Problem 3: "Everything up-to-date" with 403 errors
  - Best practices for branch management
  - Real example from PR #28 → PR #29 resolution
- dependency-checker skill (v1.0.0) for auditing Python dependencies for security vulnerabilities in `.claude/skills/dependency-checker/SKILL.md`
  - Scans for known vulnerabilities using pip-audit
  - Identifies outdated packages
  - Validates requirements.txt format and version pinning
  - Checks for dependency conflicts
  - Generates prioritized remediation plans
  - Blocks deployment on CRITICAL/HIGH vulnerabilities
  - Updated Skills README and CLAUDE.md with dependency-checker documentation
- **Universal GitHub PR operations** (`src/github_pr.py`) - Works in any environment, with or without gh CLI
  - Automatic fallback from gh CLI to requests library
  - Handles GitHub tokens from multiple sources (GH_TOKEN, GITHUB_TOKEN, gh auth)
  - Proven to work with Anthropic egress proxy
  - 16 comprehensive tests with 97% overall code coverage
  - Documentation in `CLAUDE.md:581-617`
- GitHub App authentication API documentation in `docs/api/github_auth.md` (complete documentation coverage achieved)
- **Workload Identity Federation (WIF)** - Full migration from static Service Account keys to OIDC-based authentication
- WIF setup complete with Pool: `github-pool` and Provider: `github-provider` (Project: 979429709900)
- Comprehensive WIF migration plan in `docs/wif-migration-plan.md` with step-by-step GCP setup instructions
- Manual setup guide for GitHub Admin tasks in `docs/manual-setup-guide.md` (branch protection + environments)
- test-runner skill (v1.0.0) for automated test execution before commits in `.claude/skills/test-runner/SKILL.md`
- security-checker skill (v1.0.0) for validating no secrets in commits in `.claude/skills/security-checker/SKILL.md`
- pr-helper skill (v1.0.0) for standardized PR creation in `.claude/skills/pr-helper/SKILL.md`
- Complete skills documentation in `CLAUDE.md:272-453` for all four skills
- Updated Skills README with test-runner, security-checker, and pr-helper documentation in `.claude/skills/README.md:51-176`

- Claude Skills infrastructure in `.claude/skills/` directory
- doc-updater skill (v1.0.0) for autonomous documentation maintenance in `.claude/skills/doc-updater/SKILL.md`
- Skills README with usage guide and best practices in `.claude/skills/README.md`
- Available Skills section in `CLAUDE.md:220-283` documenting skill system
- Manual trigger (workflow_dispatch) for docs-check.yml workflow
- Complete test coverage for exception handling scenarios (100% coverage achieved)
- Test for RequestException in github_auth.get_installation_token()
- Test for SubprocessError in github_auth.configure_gh_cli()
- Test for generic exceptions in secrets_manager.get_secret()
- Test for exception handling in secrets_manager.list_secrets()
- Test for failure scenario in secrets_manager.load_secrets_to_env()
- Test for successful gh CLI configuration
- GitHub PAT security guidelines in docs/SECURITY.md
- Claude Code Web environment configuration documentation in CLAUDE.md
- GitHub MCP Server documentation in CLAUDE.md (autonomy configuration)
- Tests for github_auth module
- pytest pythonpath configuration in pyproject.toml
- GitHub App authentication module (github_auth.py, github_auth.sh)
- Mandatory CI verification process in CLAUDE.md
- CI enforcement for documentation (docs-check.yml)
- Automatic changelog verification on PRs modifying src/
- Docstring validation with pydocstyle (Google style)
- MkDocs documentation with Material theme
- Automatic documentation system with mkdocstrings
- GitHub Pages deployment
- pytest framework with coverage
- Python linting with ruff
- Agent workflow for issue handling (`/claude` command)
- SecretManager for GCP Secret Manager access
- CLAUDE.md project context file
- Research summaries (7 documents in docs/research/)
- Requirements lockfile for reproducible builds

### Changed
- **All GCP workflows migrated to WIF** - No more static credentials in GitHub Secrets
- Updated `verify-secrets.yml`, `gcp-secret-manager.yml`, `quick-check.yml`, `report-secrets.yml`, and `test-wif.yml` to use WIF
- CLAUDE.md GCP Configuration section updated with WIF details and Provider Resource Name
- Updated BOOTSTRAP_PLAN.md with completed tasks and pending manual execution items
- Enhanced Success Metrics table with current status indicators (100% test coverage achieved)

### Fixed
- **Deploy Documentation workflow failure** in `docs/api/github_pr.md` - Removed broken markdown links to `CLAUDE.md`
  - Changed `[CLAUDE.md:634-669](../../CLAUDE.md)` to plain text: `` `CLAUDE.md` (lines 634-669) ``
  - Changed `[CLAUDE.md:673-810](../../CLAUDE.md)` to plain text: `` `CLAUDE.md` (lines 673-810) ``
  - Root cause: MkDocs cannot resolve links to files outside `docs/` directory
  - Fix verified: `mkdocs build --strict` passes successfully
  - Commit: `b78cd9b` (PR #33)

### Security
- ✅ **Eliminated long-lived Service Account keys** - GitHub Actions now use ephemeral OIDC tokens (1-hour lifetime)
- ✅ **Least privilege access** - WIF restricted to `edri2or-commits/project38-or` repository only
- ✅ **Automatic token rotation** - No manual credential rotation needed
- ✅ **Audit trail** - All WIF authentications logged in GCP Cloud Logging
- Workflow hardening (removed push triggers)
- Branch protection on main
- GitHub Environment "Production" for deploy gates
- OWNER-only agent triggers

## [0.1.0] - 2026-01-10

### Added
- Initial project setup
- GCP Secret Manager integration
- Basic GitHub Actions workflows
