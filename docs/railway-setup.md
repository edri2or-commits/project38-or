# Railway Deployment Setup Guide

## Overview

This guide explains how to deploy the Agent Platform to Railway, a modern platform-as-a-service (PaaS) that provides PostgreSQL databases and automatic HTTPS endpoints.

**Benefits:**
- ðŸš€ Zero-downtime deployments
- ðŸ”„ Automatic PostgreSQL backups
- ðŸ“Š Built-in metrics and logging
- ðŸ”’ HTTPS by default
- ðŸ’° $5/month free tier

---

## Prerequisites

Before deploying to Railway, ensure you have:

1. âœ… Railway account ([railway.app](https://railway.app))
2. âœ… RAILWAY-API token stored in GCP Secret Manager
3. âœ… GitHub Environment "Production" configured with approval gate
4. âœ… All Phase 3 components completed (API, Factory, Harness, MCP)

---

## Step 1: Create Railway Project

### Option A: Via Railway CLI (Recommended)

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login to Railway
railway login

# Initialize project
railway init

# Link to existing project (if already created)
railway link
```

### Option B: Via Railway Dashboard

1. Go to [railway.app](https://railway.app)
2. Click "New Project"
3. Choose "Empty Project"
4. Name it `project38-agent-platform`

---

## Step 2: Add PostgreSQL Database

### Via Railway Dashboard:

1. In your project, click "+ New"
2. Select "Database" â†’ "PostgreSQL"
3. Railway automatically provisions PostgreSQL 15
4. Connection string is available as `DATABASE_URL` environment variable

### Via Railway CLI:

```bash
railway add --database postgresql
```

**Verify Database:**
```bash
railway run psql $DATABASE_URL
# Should connect to PostgreSQL successfully
```

---

## Step 3: Configure Environment Variables

Railway needs these environment variables:

### Required Variables:

| Variable | Source | Purpose |
|----------|--------|---------|
| `DATABASE_URL` | Auto-generated by Railway | PostgreSQL connection |
| `GCP_PROJECT_ID` | `project38-483612` | GCP project for secrets |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` | Service Account JSON (base64) | GCP authentication |
| `PORT` | Auto-set by Railway | Application port |

### Optional Variables:

| Variable | Default | Purpose |
|----------|---------|---------|
| `LOG_LEVEL` | `info` | Logging verbosity |
| `MAX_CONCURRENT_AGENTS` | `5` | Resource limit |
| `AGENT_TIMEOUT_SECONDS` | `300` | Execution timeout |

### Add Variables via Railway CLI:

```bash
# Set GCP project
railway variables set GCP_PROJECT_ID=project38-483612

# Set service account credentials (base64 encoded)
# First, create a service account key in GCP Console:
# 1. Go to IAM & Admin â†’ Service Accounts
# 2. Select claude-code-agent@project38-483612.iam.gserviceaccount.com
# 3. Keys â†’ Add Key â†’ Create New Key â†’ JSON
# 4. Download the JSON file

# Encode and set as variable
cat service-account-key.json | base64 | railway variables set GOOGLE_APPLICATION_CREDENTIALS_JSON
```

### Add Variables via Railway Dashboard:

1. In your project, go to "Variables"
2. Click "+ Variable"
3. Add each variable from the table above

---

## Step 4: Configure Railway Deployment

Railway automatically detects `railway.json` and `Procfile` in the repository root.

### Verify Configuration Files:

**railway.json:**
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pip install -r requirements.txt && playwright install chromium"
  },
  "deploy": {
    "startCommand": "uvicorn src.api.main:app --host 0.0.0.0 --port $PORT",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10,
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300
  }
}
```

**Procfile:**
```
web: uvicorn src.api.main:app --host 0.0.0.0 --port $PORT
```

---

## Step 5: Deploy from GitHub Actions

### Manual Deployment:

1. Go to GitHub repository â†’ Actions
2. Select "Deploy to Railway" workflow
3. Click "Run workflow"
4. Select `production` environment
5. Click "Run workflow"
6. **Approval required** - A maintainer must approve the deployment in GitHub Environment "Production"

### Automatic Deployment (Optional):

To enable automatic deployment on push to `main`:

```yaml
# In .github/workflows/deploy-railway.yml
on:
  push:
    branches:
      - main
  workflow_dispatch:
```

âš ï¸ **Warning:** Automatic deployments bypass approval gates. Only enable for mature projects.

---

## Step 6: Verify Deployment

### Check Deployment Status:

```bash
# Via Railway CLI
railway status

# Expected output:
# Service: project38-agent-platform
# Status: RUNNING
# URL: https://project38-agent-platform-production.up.railway.app
```

### Test Health Endpoint:

```bash
curl https://your-app.up.railway.app/health

# Expected response:
# {
#   "status": "healthy",
#   "database": "connected",
#   "timestamp": "2026-01-12T..."
# }
```

### Test API Documentation:

Visit `https://your-app.up.railway.app/docs` to see interactive API documentation (Swagger UI).

---

## Database Migrations

### Initial Setup:

```bash
# Connect to Railway PostgreSQL
railway run psql $DATABASE_URL

# Create tables (run SQL from src/models/)
\i scripts/init_db.sql
```

### Future Migrations:

Use Alembic for schema migrations:

```bash
pip install alembic
alembic init alembic
# Configure alembic.ini with DATABASE_URL
alembic revision --autogenerate -m "Add new column"
alembic upgrade head
```

---

## Monitoring and Logs

### View Real-time Logs:

```bash
railway logs
```

### View Metrics:

1. Railway Dashboard â†’ Project â†’ Metrics
2. Monitor:
   - CPU usage
   - Memory usage
   - Network traffic
   - Request rate

### Set Up Alerts:

Railway can send alerts to:
- Email
- Slack
- Discord
- Webhooks

Configure in Railway Dashboard â†’ Settings â†’ Notifications

---

## Troubleshooting

### Issue: "Health check timeout"

**Cause:** Playwright installation takes > 5 minutes

**Solution:** Increase `healthcheckTimeout` in `railway.json`:
```json
"healthcheckTimeout": 600  // 10 minutes
```

### Issue: "Database connection failed"

**Cause:** `DATABASE_URL` not set or incorrect

**Solution:** Verify PostgreSQL service is running:
```bash
railway status
railway variables get DATABASE_URL
```

### Issue: "Secret Manager access denied"

**Cause:** Service account credentials not configured

**Solution:**
1. Verify `GOOGLE_APPLICATION_CREDENTIALS_JSON` is set
2. Check service account has `roles/secretmanager.secretAccessor` role

### Issue: "Port binding failed"

**Cause:** App is not using `$PORT` environment variable

**Solution:** Verify `src/api/main.py` uses `int(os.getenv("PORT", 8000))`

### Issue: "Module not found"

**Cause:** Dependencies not installed

**Solution:**
1. Check `requirements.txt` is complete
2. Verify `buildCommand` in `railway.json` includes `pip install -r requirements.txt`

---

## Cost Estimation

Railway pricing (as of 2026-01):

| Resource | Free Tier | Pro Plan |
|----------|-----------|----------|
| **Compute** | $5 credit/month | $0.000231/GB-second |
| **PostgreSQL** | $5 credit/month | $0.00021/GB-second |
| **Egress** | 100GB/month | $0.10/GB after |
| **Total** | ~$5/month free | ~$20-50/month |

**Estimated monthly cost for production:**
- Web service (512MB RAM, 24/7): ~$10
- PostgreSQL (1GB RAM, 10GB storage): ~$8
- Egress (moderate traffic): ~$5
- **Total: ~$23/month**

Free tier is sufficient for development and testing.

---

## Security Best Practices

1. **Never commit service account keys** - Use Railway environment variables
2. **Rotate secrets quarterly** - Update RAILWAY-API token in GCP Secret Manager
3. **Use Railway Environments** - Separate production/staging with different credentials
4. **Enable automatic backups** - PostgreSQL backups every 24 hours (Pro plan)
5. **Monitor access logs** - Review Railway audit logs regularly

---

## Rollback Procedure

If deployment fails or introduces bugs:

### Via Railway Dashboard:

1. Go to Deployments
2. Find last working deployment
3. Click "Redeploy"

### Via Railway CLI:

```bash
# List deployments
railway deployments

# Rollback to specific deployment
railway rollback <deployment-id>
```

---

## Next Steps

After successful Railway deployment:

1. âœ… Configure custom domain (optional)
2. âœ… Set up monitoring alerts
3. âœ… Enable automatic PostgreSQL backups (Pro plan)
4. âœ… Create staging environment for testing
5. âœ… Document deployment process in team runbook

---

## Support

- Railway Documentation: [docs.railway.app](https://docs.railway.app)
- Railway Discord: [discord.gg/railway](https://discord.gg/railway)
- Project Issues: [github.com/edri2or-commits/project38-or/issues](https://github.com/edri2or-commits/project38-or/issues)
