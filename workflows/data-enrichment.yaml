# WAT Framework Workflow: Data Enrichment Pipeline
# Enriches raw company data with additional information

name: data-enrichment
description: >
  Enrich company records with additional data from various sources.
  Adds social media profiles, employee counts, and technology stack.
version: "1.0.0"

inputs:
  input_file:
    type: str
    description: Path to CSV file with raw company data
    required: true
  output_file:
    type: str
    description: Path for enriched output
    required: false
    default: "data/output/enriched.csv"
  enrichment_level:
    type: str
    description: Level of enrichment (basic, standard, full)
    required: false
    default: "standard"

outputs:
  type: list
  description: Enriched company records
  schema:
    type: array
    items:
      type: object
      properties:
        company_name:
          type: string
        website:
          type: string
        linkedin_url:
          type: string
        employee_count:
          type: integer
        tech_stack:
          type: array
        industry:
          type: string

steps:
  - id: load_data
    tool: read_csv
    description: Load raw company data from CSV file
    inputs:
      path: "$inputs.input_file"
    timeout_seconds: 30

  - id: normalize
    tool: normalize_company_names
    description: Standardize company names and domains
    inputs:
      records: "$prev.output"
    timeout_seconds: 20

  - id: find_linkedin
    tool: search_linkedin_company
    description: Find LinkedIn company profiles
    inputs:
      companies: "$normalize.output"
    condition: "$inputs.enrichment_level != 'basic'"
    timeout_seconds: 120
    on_error: skip

  - id: get_tech_stack
    tool: detect_tech_stack
    description: Analyze websites for technology stack
    inputs:
      companies: "$normalize.output"
    condition: "$inputs.enrichment_level == 'full'"
    timeout_seconds: 180
    on_error: skip

  - id: merge_data
    tool: merge_enrichment
    description: Merge all enrichment data into final records
    inputs:
      base: "$normalize.output"
      linkedin: "$find_linkedin.output"
      tech: "$get_tech_stack.output"
    timeout_seconds: 30

  - id: export
    tool: export_csv
    description: Export enriched data to CSV
    inputs:
      data: "$merge_data.output"
      path: "$inputs.output_file"
    timeout_seconds: 10

constraints:
  - "Respect LinkedIn rate limits"
  - "Cache enrichment results to avoid duplicate API calls"
  - "Mark missing data as null, do not fabricate"

error_handlers:
  - error_type: rate_limit
    action: retry_with_backoff
    max_attempts: 10
    backoff_seconds: 60.0
    backoff_multiplier: 1.5

  - error_type: network
    action: retry_with_backoff
    max_attempts: 3
    backoff_seconds: 5.0

timeout_seconds: 900
cost_budget_usd: 5.0

tags:
  - data-enrichment
  - linkedin
  - company-data
