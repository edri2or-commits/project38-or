# WAT Framework Workflow: Dentist Lead Generation
# This workflow demonstrates the WAT pattern for automated lead generation

name: lead-gen-dentist
description: >
  Identify, verify, and extract contact details for dental practices.
  Uses Google Maps search, website enrichment, and data validation.
version: "1.0.0"

inputs:
  location:
    type: str
    description: Target location for the search (city, state)
    required: true
    default: "San Francisco, CA"
  niche:
    type: str
    description: Business niche to search for
    required: false
    default: "Dentist"
  max_results:
    type: int
    description: Maximum number of leads to generate
    required: false
    default: 50
  output_path:
    type: str
    description: Path to save the output CSV
    required: false
    default: "data/output/leads.csv"

outputs:
  type: list
  description: List of lead records with contact information
  schema:
    type: array
    items:
      type: object
      properties:
        name:
          type: string
        address:
          type: string
        phone:
          type: string
        website:
          type: string
        email:
          type: string
        rating:
          type: number

steps:
  - id: search
    tool: search_places
    description: Search for dental practices using Google Maps API
    inputs:
      query: "$inputs.niche"
      location: "$inputs.location"
      radius: 5000
    timeout_seconds: 30

  - id: filter
    tool: filter_results
    description: Filter out chain practices and prioritize private practices
    inputs:
      results: "$prev.output"
      exclude_patterns:
        - "Western Dental"
        - "Pacific Dental"
        - "Aspen Dental"
      min_rating: 3.5
    timeout_seconds: 10

  - id: enrich
    tool: enrich_contacts
    description: Visit websites to extract contact emails
    inputs:
      places: "$filter.output"
      max_concurrent: 5
    timeout_seconds: 120
    on_error: skip

  - id: validate
    tool: validate_emails
    description: Verify email format and basic deliverability
    inputs:
      records: "$prev.output"
    timeout_seconds: 30

  - id: export
    tool: export_csv
    description: Save validated leads to CSV file
    inputs:
      data: "$validate.output"
      path: "$inputs.output_path"
      columns:
        - name
        - address
        - phone
        - website
        - email
        - rating
    timeout_seconds: 10

constraints:
  - "Do not hallucinate contact information - if not found, leave blank"
  - "Respect robots.txt when scraping websites"
  - "Pause for 2 seconds between browser requests to avoid rate limiting"
  - "Exclude chains and prioritize private practices"
  - "Validate email format before including in output"

error_handlers:
  - error_type: rate_limit
    action: retry_with_backoff
    max_attempts: 5
    backoff_seconds: 5.0
    backoff_multiplier: 2.0

  - error_type: network
    action: retry_with_backoff
    max_attempts: 3
    backoff_seconds: 2.0

  - error_type: resource
    action: skip
    alert_severity: warning

  - error_type: timeout
    action: increase_timeout
    max_attempts: 2

timeout_seconds: 600
cost_budget_usd: 2.0

tags:
  - lead-generation
  - google-maps
  - scraping
  - data-enrichment
