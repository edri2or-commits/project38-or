# תוכנית יישום אופרטיבית: ארכיטקטורת סוכן דפדפן היברידי המגשר בין נתונים מקומיים לפעולות SaaS

## תקציר מנהלים

ההתכנסות של מודלי שפה גדולים (LLMs) עם פרוטוקולי אוטומציה של דפדפנים יצרה שינוי פרדיגמה באופן שבו ארגונים יכולים לגשר על הפער בין מאגרי נתונים מקומיים סטטיים (On-Premises) לבין סביבות תוכנה כשירות (SaaS) דינמיות. דו"ח מחקר זה מתווה תוכנית יישום אופרטיבית מקיפה וממצה לבניית סוכן דפדפן (Browser Agent) המבוסס על עקרונות הארכיטקטורה של Claude Code ו-Claude Chrome Extension.

המטרה האסטרטגית היא לתכנן מערכת המסוגלת לתזמר באופן אוטונומי תהליכי עבודה המצריכים קריאת נתונים מתוך היקף האבטחה המקומי (מסדי נתונים SQL, קבצי CSV, מאגרי Git מקומיים) וביצוע פעולות על סמך נתונים אלו בתוך ממשקי SaaS צד שלישי (כגון Salesforce, Jira, פורטלים בנקאיים) במקומות בהם ממשקי API אינם קיימים, מוגבלים בקצב (Rate-limited), או אינם מספקים את הפונקציונליות הנדרשת.

הארכיטקטורה המוצעת ממנפת את פרוטוקול הקשר המודל (Model Context Protocol - MCP) כמערכת העצבים המרכזית, המנתקת את ה"מוח" (Claude 3.5 Sonnet) מה"ידיים" (כלי הדפדפן). על ידי סינתזה של יכולות ה-Computer Use API של Anthropic (שליטה מבוססת ראייה ממוחשבת) עם הזרקת פקודות מבוססת DOM (ניווט בעץ הנגישות), דו"ח זה מציע ארכיטקטורה סוכנית היברידית.

## 1. יסודות ארכיטקטוניים ותפיסות ליבה

כדי לשכפל ולהרחיב את היכולות של "Claude Code" ושל "Claude Chrome Extension" לכדי סוכן דפדפן מותאם אישית, עלינו לפרק תחילה את הדפוסים הארכיטקטוניים הבסיסיים שהופכים את הכלים הללו ליעילים.

### 1.1 הלולאה הסוכנית: "צפה-חשוב-פעל" (Observe-Think-Act)

בלב הארכיטקטורה של Claude Code נמצאת לולאת משוב רציפה. בניגוד לסקריפטים מסורתיים של אוטומציה (כגון Selenium או Cypress), לולאה סוכנית היא דינמית ומסתגלת לשינויים בזמן אמת.

#### צפייה (Observe)
הסוכן תופס את הסביבה. בהקשר של דפדפן, תפיסה זו היא דו-מודאלית:
- **ויזואלית**: צילום מסך של אזור התצוגה הנוכחי
- **מבנית**: תמונת מצב של עץ הנגישות (Accessibility Tree)

#### חשיבה (Think)
מודל השפה (Claude 3.5 Sonnet) מעבד את התצפית כנגד המטרה של המשתמש וההקשר הנוכחי.

#### פעולה (Act)
המודל פולט קריאת כלי במבנה JSON מובנה: `click()`, `type_text()`, או `sql_query()`.

#### אימות (Verify)
הכלי מבצע את הפעולה ומחזיר את התוצאה חזרה למודל.

**תובנת עומק**: יכולת תיקון עצמי זו היא המבדילה בין סוכנים לבין סקריפטים שבירים.

### 1.2 פרוטוקול הקשר המודל (MCP): הרקמה המחברת

הארכיטקטורה מסתמכת במידה רבה על Model Context Protocol (MCP). ה-MCP הוא תקן פתוח המנרמל כיצד מודלי AI מתקשרים עם משאבים מקומיים ומרוחקים.

**שרת MCP לנתונים מקומיים**: חושף מערכות קבצים מקומיות, מסדי נתונים מסוג SQLite, או ממשקי API פנימיים.

**שרת MCP לדפדפן**: חושף את מופע הדפדפן (Chrome) לסוכן.

**יתרון אסטרטגי**: השימוש ב-MCP הופך את הארכיטקטורה למודולרית לחלוטין.

### 1.3 הדיכוטומיה של "Headless" מול "Headed"

Claude Code פועל בעיקר בממשק שורת פקודה (CLI), שהוא "Headless" כברירת מחדל. עם זאת, עבור משימות דפדפן המבוססות על ראייה ממוחשבת, המערכת דורשת סביבה "Headed".

**סינתזה**: הסוכן המוצע חייב לגשר בין עולמות אלו.

## 2. ממשק הדפדפן: גישות, ניתוח עלויות ופשרות

החלטת תכנון קריטית בבניית סוכן דפדפן היא קביעת האופן שבו הסוכן תופס ומקיים אינטראקציה עם דף האינטרנט.

### 2.1 הגישה הוויזואלית: Anthropic Computer Use API

יכולת ה-"Computer Use" מאפשרת ל-Claude 3.5 Sonnet לקיים אינטראקציה עם ממשק מחשב באמצעות צילומי מסך וקואורדינטות.

**יתרונות**:
- אוניברסליות: עובד על כל ממשק
- חוסן לשינויי DOM

**חסרונות**:
- עלות גבוהה (~1,000+ טוקנים לצעד)
- שיהוי משמעותי
- דיוק מוגבל

### 2.2 הגישה המבנית: DOM ועץ הנגישות

גישה זו כרוכה בניתוח הקוד שמאחורי דף האינטרנט.

**יתרונות**:
- יעילות: זול ומהיר יותר
- דיוק דטרמיניסטי
- מודעות למצב

**חסרונות**:
- הגנות אנטי-בוט
- נכשל בממשקים מורכבים

### 2.3 הארכיטקטורה ההיברידית המומלצת

**זרימת הלוגיקה**:
1. ניסיון ראשוני (מבני): שימוש בעץ הנגישות/DOM
2. זיהוי כשל: במידת הצורך
3. ניסיון משני (ויזואלי): Computer Use API
4. למידה: עדכון זיכרון לאופטימיזציה

| תכונה | ויזואלי | מבני | היברידי |
|-------|---------|------|---------|
| עלות טוקנים | גבוהה | נמוכה | אופטימלית |
| מהירות | איטית | מהירה | מהירה |
| חוסן | גבוה | נמוך | מקסימלי |

## 3. תכנון המערכת: גשר מקומי-SaaS

המטרה העיקרית היא לגשר בין נתונים מקומיים (מאובטחים) לבין פעולות SaaS (חיצוניות).

### 3.1 צינור קליטת נתונים (צד מקומי)

הסוכן זקוק לגישה לנתונים מקומיים מבלי לחשוף את כל הרשת המקומית.

**שער SQL מקומי**: שרת MCP מותאם אישית המתחבר למסד הנתונים המקומי.

**שער מערכת קבצים**: שרת MCP לקריאת קבצי CSV/Excel.

### 3.2 מנגנון ה-"Teleport" (העברת הקשר)

"טלפורטציה" משמעה העברת נתונים וכוונות מההקשר המקומי להקשר הדפדפן ובחזרה.

**תהליך העבודה**:
1. הקשר A (מקומי): שאילתת DB
2. סריאליזציה: שמירת נתונים
3. הקשר B (דפדפן): ביצוע פעולה
4. סנכרון: עדכון חזרה

### 3.3 טופולוגיית רשת וארגז חול

**קונטיינר A (הסוכן)**: מריץ את לקוח ה-LLM

**קונטיינר B (הדפדפן)**: מריץ Chrome Headless עם Xvfb

**תקשורת**: HTTP/WebSocket (Chrome DevTools Protocol)

## 4. אסטרטגיית יישום: תבנית "Claude Code"

### 4.1 CLAUDE.md: חוקת הסוכן

```markdown
# פרוטוקולים תפעוליים לסוכן דפדפן

## מטרה ליבה
גישור זרמי נתונים מקומיים עם ממשקי SaaS באמצעות MCP.

## אילוצים תפעוליים
- בטיחות פיננסית: אישור אנושי לתשלומים > $50
- פרטיות נתונים: אין להעלות PII ללא הצפנה
- בחירת כלים: העדף DOM על ויזואלי

## טיפול בשגיאות
- סלקטור נכשל → חפש אלטרנטיבה
- דף נכשל → המתן והנסה שנית (מקס 3)
- CAPTCHA → בקש התערבות אנושית
```

### 4.2 SKILL.md: יכולות מודולריות

יכולות חדשות נלמדות על ידי הסוכן באמצעות קבצי SKILL.md.

**תהליך הקלטת מיומנות**:
1. הפעל תוסף Chrome
2. הקלט תהליך עבודה
3. ייצא ל-SKILL.md
4. העבר לספריית הסוכן

**דוגמה: SKILL.md עבור Salesforce**:
```yaml
---
name: salesforce-entry
description: הזנת ליד חדש ל-Salesforce
---

# הנחיות
1. נווט ל-force.com/leads/new
2. בדוק מסך התחברות
3. מלא שדות
4. שמור
5. אמת הצלחה
```

### 4.3 יישום שרת MCP מותאם אישית

שרת Node.js/Python מתמיד השומר על אובייקט browser גלובלי חי.

**ארכיטקטורה**:
- שרת: `browser_server.py` (FastAPI + Playwright)
- נקודות קצה: `/navigate`, `/click`, `/type`, `/snapshot`
- מצב: WebSocket ל-Chrome

## 5. תוכנית אופרטיבית: בניית הסוכן

### שלב 1: סביבה ותשתית

**הקמת Docker**:
- Dockerfile מבוסס `playwright:v1.40.0-jammy`
- Xvfb לתצוגה וירטואלית
- Python 3.11 ו-UV

**ניהול אימות**:
- Persistent Volume ל-`~/.config/google-chrome`
- שמירת עוגיות/טוקנים

### שלב 2: לוגיקת הסוכן

```python
messages = []
while True:
    response = client.beta.messages.create(
        model="claude-3-5-sonnet-20241022",
        max_tokens=1024,
        messages=messages,
        tools=tool_definitions
    )
    if response.stop_reason == "tool_use":
        # ביצוע הכלי
        pass
    else:
        break
```

**אופטימיזציה**: קיטום הקשר - גיזום עצי נגישות.

### שלב 3: אינטגרציית Dev Browser

**יצירת תמונת מצב**: JSON מפשוט של DOM במקום צילום מסך.

**היוריסטיקה**: חיפוש ב-DOM תחילה, גיבוי ויזואלי במידת הצורך.

## 6. אדם-בלולאה (HITL) וממשל

"אדם-בלולאה" אינו אופציה; זוהי דרישת בטיחות מחייבת.

### 6.1 אינטגרציית HumanLayer

**תהליך העבודה**:
1. הסוכן מחשב פעולה
2. קריאה ל-`request_approval()`
3. HumanLayer מיירט ושולח הודעה
4. השהיה וממתין
5. אישור ממשתמש
6. חידוש ביצוע

### 6.2 אכיפת מדיניות

**סיווג סיכונים**:
- סיכון נמוך: קריאה בלבד
- סיכון גבוה: Publish, Delete, Pay

## 7. אבטחה ותאימות

### 7.1 הגנה מפני הזרקת הנחיות

**אסטרטגיית הפחתת סיכונים**:
- הפרדה ויזואלית
- סינון פלט
- זכויות מינימליות

### 7.2 תנאי שימוש של SaaS

**אסטרטגיית תאימות**:
- API תחילה
- הגבלת קצב: עיכובים בין פעולות
- חיקוי התנהגות אנושית

## 8. אופטימיזציה וסקיילינג

### 8.1 ניהול עלויות

**נוסחה להערכת עלות**:
```
Cost = (Steps × Input Tokens × Price_in) + (Steps × Output Tokens × Price_out)
```

**בשימוש ב-Claude 3.5 Sonnet**:
- צעד ויזואלי: ~$0.005
- צעד DOM: ~$0.0015

**המלצה**: המודל ההיברידי מפחית עלות ב-~70%.

### 8.2 סלקטורים בעלי "ריפוי עצמי"

**מנגנון**:
1. סלקטור נכשל
2. לכידת DOM חדש
3. השוואה וזיהוי מאפיין חדש
4. עדכון אוטומטי

## 9. סימולציית מקרה בוחן

**תרחיש**: עדכון סטטוס משלוחים בפורטל ישן ללא API.

**אתחול** → **שליפת נתונים** → **פעולת דפדפן** → **אימות** → **השלמה**

**תוצאה**: תהליך עבודה אופטימלי עם בדיקה ויזואלית אחת ו-4 אינטראקציות DOM.

## 10. מסקנות והמלצות אסטרטגיות

1. **אמצו היברידית מיידית**: אל תסתמכו רק על Computer Use
2. **השקיעו ב-SKILL.md**: בנו מאגר מיומנויות לשימוש חוזר
3. **תקננו על MCP**: עמידות לשינויים עתידיים
4. **ממשל לפני אוטונומיה**: HumanLayer לפעולות קריטיות

על ידי ביצוע תוכנית אופרטיבית זו, ארגונים יכולים לפרוס סוכן דפדפן שאינו רק הדגמה טכנולוגית, אלא חלק חזק, מאובטח וכלכלי מתהליך העבודה הארגוני שלהם.
